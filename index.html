<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>í´ë˜ìŠ¤ì–´ë¼ìš´ë“œ Â· ìš´ì˜ë´‡ ëŒ€ì‹œë³´ë“œ</title>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <style>
    :root{
      --bg:#f3f4f6; --card:#fff; --surface:#f8fafc; --line:#e5e7eb; --text:#0f172a; --muted:#64748b;
      --accent:#60a5fa; --accent-strong:#3b82f6; --ok:#22c55e; --warn:#f59e0b; --bad:#ef4444;
      --radius:12px; --ctl-h:42px; --gap:12px; --logo-size:112px;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font:14px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
    .wrap{max-width:1200px;margin:24px auto 40px;padding:0 16px}
    h1{font-size:22px;margin:0 0 8px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:16px;margin-bottom:16px}
    label{display:block;color:var(--muted);margin-bottom:6px}
    select{
      width:100%; background:#fff; color:var(--text); border:1px solid var(--line);
      border-radius:var(--radius); padding:10px 12px; outline:none; height:var(--ctl-h);
    }
    input{
      width:100%; background:#fff; color:var(--text); border:1px solid var(--line);
      border-radius:var(--radius); padding:10px 12px; outline:none; height:var(--ctl-h);
    }
    .btn{
      appearance:none; border:1px solid var(--line); background:#fff; color:var(--text);
      padding:10px 14px; border-radius:var(--radius); cursor:pointer; transition:all .15s ease;
      height:var(--ctl-h); display:inline-flex; align-items:center; justify-content:center;
      font-size:13px;
    }
    .btn:hover{border-color:var(--accent-strong);box-shadow:0 0 0 3px rgba(96,165,250,.2)}
    .btn.acc{background:var(--accent);border-color:var(--accent);color:#fff}
    .btn.acc:hover{background:var(--accent-strong);border-color:var(--accent-strong)}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .hint{color:#64748b;font-size:12px}
    .err{color:#ef4444;font-family:ui-monospace,monospace;white-space:pre-wrap}

    .pill{display:inline-flex;gap:8px;align-items:center;padding:6px 10px;border:1px solid var(--line);border-radius:999px;color:var(--muted);background:#fff;font-size:12px}
    .pill.ok{border-color:rgba(34,197,94,.25);color:var(--ok)}
    .pill.warn{border-color:rgba(245,158,11,.25);color:var(--warn)}
    .pill.bad{border-color:rgba(239,68,68,.25);color:var(--bad)}
    table{width:100%;border-collapse:collapse;border:1px solid var(--line);overflow:auto;background:#fff;border-radius:12px}
    th,td{padding:8px 10px;border-bottom:1px solid var(--line);text-align:left;vertical-align:top;font-size:12px}
    th{color:#0f172a;font-weight:600;background:#f1f5f9;position:sticky;top:0}

    .brand{display:flex;align-items:center;gap:14px;margin:0 0 6px}
    .brand h1{margin:0;font-size:22px}
    .brand-logo{width:var(--logo-size);height:var(--logo-size);flex:0 0 var(--logo-size)}
    .logo-text{
      font-family:'Nunito','Arial Rounded MT','SF Pro Rounded','Quicksand','Pretendard','Noto Sans KR',sans-serif;
      font-weight:900; letter-spacing:-0.2px; fill:#0f172a; font-size:18px;
      paint-order:stroke fill; stroke:#0f172a; stroke-width:.9px;
    }

    /* í™”ë©´ ìŠ¤ìœ„ì¹­ */
    .screen{display:none;}
    .screen.active{display:block;}

    /* ìƒë‹¨ ë°” */
    .topbar{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:12px;
      gap:12px;
      flex-wrap:wrap;
    }

    /* ëŒ€ì‹œë³´ë“œ íƒ€ì¼ */
    .tiles{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(220px,1fr));
      gap:16px;
      margin-top:8px;
    }
    .tile{
      border-radius:18px;
      border:1px solid var(--line);
      background:#fff;
      padding:16px 16px 18px;
      display:flex;
      flex-direction:column;
      gap:6px;
      cursor:pointer;
      transition:transform .12s ease, box-shadow .12s ease, border-color .12s ease;
      text-align:left;
      text-decoration:none;
      color:inherit;
    }
    .tile:hover{
      transform:translateY(-2px);
      box-shadow:0 10px 25px rgba(15,23,42,.08);
      border-color:var(--accent-strong);
    }
    .tile-title{
      font-weight:700;
      font-size:15px;
      display:flex;
      align-items:center;
      gap:6px;
    }
    .tile-badge{
      font-size:11px;
      padding:2px 6px;
      border-radius:999px;
      background:#e5e7eb;
      color:#4b5563;
    }
    .tile-desc{
      font-size:12px;
      color:var(--muted);
    }

    /* ì¹´í†¡ ì…ì¥ì ì²´í¬ ë‚´ë¶€ ë ˆì´ì•„ì›ƒ */
    .panels{display:grid;gap:16px}
    @media(min-width:1100px){ .panels{grid-template-columns:1fr 1fr} }
    .controls{display:grid;gap:var(--gap)}
    .controls-line{display:grid;align-items:end;gap:var(--gap);grid-template-columns:1.2fr 1fr var(--ctl-h)}
    .icon-btn{width:var(--ctl-h);height:var(--ctl-h);border:1px solid var(--line);border-radius:10px;background:#fff;display:inline-flex;align-items:center;justify-content:center;cursor:pointer}
    .icon-btn:hover{border-color:var(--accent-strong);box-shadow:0 0 0 3px rgba(96,165,250,.2)}
    .icon-btn svg{width:18px;height:18px}

    .dirline{
      display:grid;align-items:center;gap:8px;
      grid-template-columns:auto minmax(120px,auto) minmax(240px,1fr) auto;
    }
    .dirlabel{
      display:none;
      color:#64748b;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
      font-weight:700;
    }
    .dirlabel::before{content:"ğŸ“";margin-right:8px;opacity:.9}
    .dirlabel.connected{display:inline-block;color:var(--accent-strong);font-weight:800}

    /* ì¹´í†¡ ì„œë¸Œíƒ­ */
    .subtabs{
      display:flex;
      gap:8px;
      align-items:center;
      margin:8px 0 16px;
      padding:4px;
      border-radius:999px;
      background:#f8fafc;
      border:1px solid var(--line);
      flex-wrap:wrap;
    }
    .subtab-btn{
      appearance:none;
      border:none;
      background:transparent;
      padding:6px 12px;
      border-radius:999px;
      font-size:13px;
      display:inline-flex;
      align-items:center;
      gap:6px;
      cursor:pointer;
      color:var(--muted);
    }
    .subtab-btn span.badge{
      font-size:11px;
      padding:2px 6px;
      border-radius:999px;
      background:#e5e7eb;
    }
    .subtab-btn.active{
      background:#fff;
      color:var(--text);
      box-shadow:0 0 0 1px rgba(148,163,184,.8);
    }
    .subtab-btn.active span.badge{
      background:#dbeafe;
      color:#2563eb;
    }
    .tab-screen{display:none;}
    .tab-screen.active{display:block;}

    /* ì˜µì…˜ í™”ë©´ìš© */
    .opt-grid{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(200px,1fr));
      gap:12px;
      margin-top:8px;
    }
    .opt-section-title{
      font-weight:700;
      margin:0 0 6px;
      font-size:14px;
    }

    .back-btn{
      margin-bottom:8px;
    }
  </style>
</head>
<body>
<div class="wrap">
  <!-- ìƒë‹¨ ë¸Œëœë“œ -->
  <header class="brand">
    <svg class="brand-logo" viewBox="0 0 90 50" role="img" aria-label="ClassAround">
      <rect width="90" height="50" rx="10" fill="white"/>
      <circle cx="66" cy="10" r="8" fill="#6b8bd6"/>
      <circle cx="80" cy="18" r="5" fill="#ef4444"/>
      <text x="8" y="24" class="logo-text">Class</text>
      <text x="8" y="42" class="logo-text">Around</text>
    </svg>
    <h1>í´ë˜ìŠ¤ì–´ë¼ìš´ë“œ ìš´ì˜ë´‡ ëŒ€ì‹œë³´ë“œ</h1>
  </header>

  <!-- ë¡œê·¸ì¸/ìƒíƒœ ë°” -->
  <div class="topbar">
    <div class="row">
      <button id="gsLoginBtn" class="btn acc" type="button">Google ë¡œê·¸ì¸</button>
      <button id="gsLogoutBtn" class="btn" type="button">ë¡œê·¸ì•„ì›ƒ</button>
      <span id="authState" class="hint">ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.</span>
    </div>
    <span class="hint">ìŠ¤í”„ë ˆë“œì‹œíŠ¸Â·ë“œë¼ì´ë¸Œ ì—°ë™ì€ Google ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.</span>
  </div>
  <div id="authErr" class="err" style="margin-top:-6px;margin-bottom:12px"></div>

  <!-- ===== í™”ë©´ 1: ë¡œê·¸ì¸ ì•ˆë‚´ ===== -->
  <section id="screen-login" class="screen active">
    <div class="card" style="text-align:center;padding:32px 20px">
      <h2 style="margin:0 0 8px;font-size:20px">ìš´ì˜ë´‡ ì‹œì‘í•˜ê¸°</h2>
      <p class="hint" style="margin:0 0 20px">
        Google ê³„ì •ìœ¼ë¡œ ë¡œê·¸ì¸í•˜ë©´ ì¹´í†¡ ì…ì¥ì ì²´í¬, ìˆ˜ê°•ìƒ ëª…ë‹¨ ê´€ë¦¬, ë“œë¼ì´ë¸Œ í´ë” ëª¨ìŒ ë“±<br/>
        ìš´ì˜ ìë™í™” ê¸°ëŠ¥ì„ í•œ ë²ˆì— ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
      </p>
      <button id="loginMainBtn" class="btn acc" style="min-width:220px;font-size:15px;height:48px">
        ğŸš€ Google ë¡œê·¸ì¸í•˜ê³  ëŒ€ì‹œë³´ë“œ ì…ì¥
      </button>
    </div>
  </section>

  <!-- ===== í™”ë©´ 2: ë©”ì¸ ëŒ€ì‹œë³´ë“œ ===== -->
  <section id="screen-main" class="screen">
    <div class="card">
      <h2 style="margin:0 0 4px;font-size:18px">ìš´ì˜ ê¸°ëŠ¥ ì„ íƒ</h2>
      <p class="hint" style="margin:0 0 10px">
        ìì£¼ ì‚¬ìš©í•˜ëŠ” ìš´ì˜ ê¸°ëŠ¥ì„ ì„ íƒí•´ ì£¼ì„¸ìš”. ì¼ë¶€ ê¸°ëŠ¥ì€ ìˆœì°¨ì ìœ¼ë¡œ íƒ‘ì¬ ì˜ˆì •ì…ë‹ˆë‹¤.
      </p>
      <div class="tiles">
        <!-- ì¹´í†¡ ì…ì¥ì ì²´í¬ -->
        <button class="tile" data-goto="kakao">
          <div class="tile-title">ğŸ’¬ ì¹´í†¡ ì…ì¥ì ì²´í¬</div>
          <div class="tile-desc">
            ì¹´í†¡ ì…ì¥ë¡œê·¸ txt/csv + ìˆ˜ê°•ìƒ ì‹œíŠ¸ ê¸°ë°˜ìœ¼ë¡œ ê³µìœ ìš© ì‹œíŠ¸ì— ì…ì¥ ì—¬ë¶€ë¥¼ ìë™ìœ¼ë¡œ ê¸°ë¡í•©ë‹ˆë‹¤.
          </div>
        </button>

        <!-- ìˆ˜ê°•ìƒ ëª…ë‹¨ ì—…ë°ì´íŠ¸ (ì˜ˆì •) -->
        <button class="tile" data-goto="students">
          <div class="tile-title">
            ğŸ“Š ìˆ˜ê°•ìƒ ëª…ë‹¨ ì—…ë°ì´íŠ¸
            <span class="tile-badge">ì˜ˆì •</span>
          </div>
          <div class="tile-desc">
            ê²°ì œì DBÂ·CSVë¥¼ ë¶ˆëŸ¬ì™€ ê¸°ìˆ˜ë³„ ìˆ˜ê°•ìƒ ì‹œíŠ¸ë¥¼ ìë™ ì •ë¦¬í•˜ëŠ” ê¸°ëŠ¥ì„ ì´ ì˜ì—­ì— ì¶”ê°€í•  ì˜ˆì •ì…ë‹ˆë‹¤.
          </div>
        </button>

        <!-- ë“œë¼ì´ë¸Œ í´ë” ëª¨ìŒ (ì˜ˆì •) -->
        <button class="tile" data-goto="drive">
          <div class="tile-title">
            ğŸ“ ë“œë¼ì´ë¸Œ í´ë” ëª¨ìŒ
            <span class="tile-badge">ì˜ˆì •</span>
          </div>
          <div class="tile-desc">
            ê°•ì˜ë³„Â·í”„ë¡œì íŠ¸ë³„ë¡œ ìì£¼ ì‚¬ìš©í•˜ëŠ” ë“œë¼ì´ë¸Œ í´ë”ë¥¼ í•œ í™”ë©´ì—ì„œ ê´€ë¦¬í•˜ê³  ë°”ë¡œ ì—´ ìˆ˜ ìˆë„ë¡ êµ¬ì„±í•  ì˜ˆì •ì…ë‹ˆë‹¤.
          </div>
        </button>

        <!-- ì„¸ì¼ì¦ˆ ë©˜íŠ¸ GPTs ë§í¬ -->
        <a class="tile" href="https://chatgpt.com/g/g-692d30887e04819196d4f0b3e603a5a7-seiljeu-menteu-jagseong"
           target="_blank" rel="noopener">
          <div class="tile-title">ğŸ§  ì„¸ì¼ì¦ˆ ë©˜íŠ¸ GPTs ì—´ê¸°</div>
          <div class="tile-desc">
            ì„¸ì¼ì¦ˆ ë©˜íŠ¸ ì‘ì„± ì „ìš© GPTs í˜ì´ì§€ë¥¼ ìƒˆ íƒ­ì—ì„œ ì—½ë‹ˆë‹¤. ìš´ì˜ë´‡ì—ì„œ ë§Œë“  ë°ì´í„°ì™€ í•¨ê»˜ í™œìš©í•´ ì£¼ì„¸ìš”.
          </div>
        </a>
      </div>
    </div>
  </section>

  <!-- ===== í™”ë©´ 3: ì¹´í†¡ ì…ì¥ì ì²´í¬ ===== -->
  <section id="screen-kakao" class="screen">
    <button class="btn back-btn" type="button" id="backFromKakao">â† ëŒ€ì‹œë³´ë“œë¡œ ëŒì•„ê°€ê¸°</button>

    <div class="card" style="margin-bottom:12px">
      <h2 style="margin:0 0 4px;font-size:18px">ì¹´í†¡ ì…ì¥ì ì²´í¬</h2>
      <p class="hint" style="margin:0">
        ì¹´í†¡ ì…ì¥ë¡œê·¸(txt/csv)ì™€ ìˆ˜ê°•ìƒ ìŠ¤í”„ë ˆë“œì‹œíŠ¸ë¥¼ ì—°ê²°í•´,
        ê³µìœ ìš© ì‹œíŠ¸ì— ìë™ìœ¼ë¡œ <strong>ì…ì¥ ìƒíƒœ</strong>ë¥¼ ê¸°ë¡í•˜ê³  ìš”ì•½ ë¦¬í¬íŠ¸ë¥¼ ì œê³µí•©ë‹ˆë‹¤.
      </p>
    </div>

    <!-- ì¹´í†¡ ì…ì¥ì ì²´í¬ íƒ­ -->
    <nav class="subtabs">
      <button class="subtab-btn active" data-tab="basic">
        ğŸ§¾ <span>ê¸°ë³¸ ì²´í¬</span>
      </button>
      <button class="subtab-btn" data-tab="extra">
        ğŸ§© <span>ì¶”ê°€ ê¸°ëŠ¥</span> <span class="badge">ì˜ˆì •</span>
      </button>
      <button class="subtab-btn" data-tab="options">
        âš™ <span>ì˜µì…˜</span>
      </button>
    </nav>

    <!-- ê¸°ë³¸ ì²´í¬ íƒ­ -->
    <section id="tab-basic" class="tab-screen active">
      <div class="panels">
        <!-- Panel A -->
        <section>
          <div class="card">
            <div class="controls">
              <div class="controls-line">
                <div>
                  <label>ì‹œíŠ¸ ì„ íƒ</label>
                  <select id="sheetPackSelectA"></select>
                </div>
                <div>
                  <label>ì½ê¸° ì‹œíŠ¸ ì„ íƒ</label>
                  <select id="readSheetSelectA"></select>
                </div>
                <div>
                  <label style="visibility:hidden">refresh</label>
                  <button id="refreshMetaA" class="icon-btn" type="button">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M3 12a9 9 0 1 0 3-6.7"/><polyline points="3 4 3 10 9 10"/>
                    </svg>
                  </button>
                </div>
              </div>

              <div class="hint" style="margin-top:-4px">A íŒ¨ë„ : ì£¼ë ¥ ë°© / 1ë²ˆë°© ë“±</div>

              <label style="margin-top:8px">ì¹´í†¡ ì…ì¥ë¡œê·¸ txt / csv</label>
              <div class="dirline">
                <button id="dirPickA" class="btn" type="button">í´ë”</button>
                <div class="dirlabel" id="dirNameA"></div>
                <select id="dirFileSelectA"></select>
                <button id="dirRefreshA" class="icon-btn" type="button">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M3 12a9 9 0 1 0 3-6.7"/><polyline points="3 4 3 10 9 10"/>
                  </svg>
                </button>
              </div>
            </div>

            <div class="row" style="margin-top:10px">
              <label class="row" style="gap:6px;align-items:center">
                <input id="previewOnlyA" type="checkbox" />
                <span class="hint">ì²´í¬ë§Œ (ì‹¤ì œ ì‹œíŠ¸ ë°˜ì˜ ì—†ìŒ)</span>
              </label>
              <button id="runBtnA" class="btn acc" type="button">ì‹¤í–‰</button>
              <button id="demoBtnA" class="btn" type="button">ë°ëª¨</button>
              <span id="pillsAA" class="row"></span>
            </div>
            <div id="errA" class="err" style="margin-top:8px"></div>
          </div>
          <div id="resultsA" style="display:grid;gap:16px"></div>
        </section>

        <!-- Panel B -->
        <section>
          <div class="card">
            <div class="controls">
              <div class="controls-line">
                <div>
                  <label>ì‹œíŠ¸ ì„ íƒ</label>
                  <select id="sheetPackSelectB"></select>
                </div>
                <div>
                  <label>ì½ê¸° ì‹œíŠ¸ ì„ íƒ</label>
                  <select id="readSheetSelectB"></select>
                </div>
                <div>
                  <label style="visibility:hidden">refresh</label>
                  <button id="refreshMetaB" class="icon-btn" type="button">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M3 12a9 9 0 1 0 3-6.7"/><polyline points="3 4 3 10 9 10"/>
                    </svg>
                  </button>
                </div>
              </div>

              <div class="hint" style="margin-top:-4px">B íŒ¨ë„ : 2ë²ˆë°© / ì˜ˆë¹„ ë°© ë“±</div>

              <label style="margin-top:8px">ì¹´í†¡ ì…ì¥ë¡œê·¸ txt / csv</label>
              <div class="dirline">
                <button id="dirPickB" class="btn" type="button">í´ë”</button>
                <div class="dirlabel" id="dirNameB"></div>
                <select id="dirFileSelectB"></select>
                <button id="dirRefreshB" class="icon-btn" type="button">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M3 12a 9 9 0 1 0 3-6.7"/><polyline points="3 4 3 10 9 10"/>
                  </svg>
                </button>
              </div>
            </div>

            <div class="row" style="margin-top:10px">
              <label class="row" style="gap:6px;align-items:center">
                <input id="previewOnlyB" type="checkbox" />
                <span class="hint">ì²´í¬ë§Œ (ì‹¤ì œ ì‹œíŠ¸ ë°˜ì˜ ì—†ìŒ)</span>
              </label>
              <button id="runBtnB" class="btn acc" type="button">ì‹¤í–‰</button>
              <button id="demoBtnB" class="btn" type="button">ë°ëª¨</button>
              <span id="pillsBB" class="row"></span>
            </div>
            <div id="errB" class="err" style="margin-top:8px"></div>
          </div>
          <div id="resultsB" style="display:grid;gap:16px"></div>
        </section>
      </div>
    </section>

    <!-- ì¶”ê°€ ê¸°ëŠ¥ íƒ­ (ì§€ê¸ˆì€ ì•ˆë‚´ìš© ì¹´ë“œ) -->
    <section id="tab-extra" class="tab-screen">
      <div class="card">
        <h3 style="margin:0 0 8px">ì¶”ê°€ ê¸°ëŠ¥ (ì˜ˆì •)</h3>
        <p class="hint" style="margin:0">
          ê¸°ë³¸ ì²´í¬ì—ì„œ ê³„ì‚°ëœ ê²°ê³¼ë¥¼ ê¸°ë°˜ìœ¼ë¡œ, ì…ì¥/ë¯¸ì…ì¥/ëª…ë‹¨ ì™¸ ì…ì¥ì ë“±ì„ ì§‘ê³„í•˜ê³ 
          ë¦¬í¬íŠ¸ í˜•íƒœë¡œ ë½‘ì•„ë‚´ëŠ” ê¸°ëŠ¥ë“¤ì„ ì—¬ê¸°ì— ëª¨ì„ ì˜ˆì •ì…ë‹ˆë‹¤.<br/>
          (ì˜ˆ: ë°©ë³„ ì…ì¥ë¥ , ëª…ë‹¨ ì™¸ ì…ì¥ì ë¦¬ìŠ¤íŠ¸ CSV ë‚´ë³´ë‚´ê¸° ë“±)
        </p>
      </div>
    </section>

    <!-- ì˜µì…˜ íƒ­ : ê´€ë¦¬ì + ë™ì‘ ì„¤ì • -->
    <section id="tab-options" class="tab-screen">
      <!-- ìŠ¤í”„ë ˆë“œì‹œíŠ¸ ì—°ê²° ê´€ë¦¬ -->
      <div class="card">
        <h3 class="opt-section-title">ìŠ¤í”„ë ˆë“œì‹œíŠ¸ ì—°ê²° ê´€ë¦¬</h3>
        <p class="hint" style="margin-top:0">
          ì¹´í†¡ ì…ì¥ì ì²´í¬ì— ì‚¬ìš©í•  ìˆ˜ê°•ìƒ/ê³µìœ ìš© ì‹œíŠ¸ë“¤ì„ ë“±ë¡í•˜ëŠ” ì˜ì—­ì…ë‹ˆë‹¤.
          ì—¬ëŸ¬ ê°•ì˜Â·ê¸°ìˆ˜ë¥¼ ë¯¸ë¦¬ ì—°ê²°í•´ë‘ê³ , ê¸°ë³¸ ì²´í¬ íƒ­ì—ì„œ ì„ íƒí•´ì„œ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
        </p>

        <div class="opt-grid">
          <div>
            <label>í‘œì‹œ ì´ë¦„(ì„ íƒ)</label>
            <input id="admLabel" type="text" placeholder="ì˜ˆ: ë””ë…¸ ì¿ íŒ¡ 3ê¸°" />
          </div>
          <div>
            <label>ìŠ¤í”„ë ˆë“œì‹œíŠ¸ ë§í¬(URL)</label>
            <input id="admUrl" type="text" placeholder="https://docs.google.com/spreadsheets/d/..." />
          </div>
          <div>
            <label>ì½ì„ ì—´(A~) <span class="hint">ì½ê¸° ì‹œíŠ¸ ì´ë¦„ì—´ (ì˜ˆ: C)</span></label>
            <input id="admReadCol" type="text" value="G" />
          </div>
        </div>

        <div class="row" style="margin-top:10px">
          <button id="admAdd" class="btn" type="button">ì—°ê²° ì¶”ê°€</button>
          <button id="admClearAll" class="btn" type="button">ì „ì²´ ì‚­ì œ</button>
        </div>
        <div id="admErr" class="err" style="margin-top:8px"></div>

        <div style="margin-top:16px">
          <table style="width:100%;border-collapse:collapse">
            <thead><tr><th>ë¼ë²¨</th><th>ì‹œíŠ¸ìˆ˜</th><th>ì½ì„ ì—´</th><th>ì‘ì—…</th></tr></thead>
            <tbody id="admList"><tr><td colspan="4" style="color:#64748b">ì—†ìŒ</td></tr></tbody>
          </table>
          <div class="hint" id="admMeta" style="margin-top:6px"></div>
        </div>
      </div>

      <!-- ì…ì¥ì ì²´í¬ ë™ì‘ ì„¤ì • -->
      <div class="card">
        <h3 class="opt-section-title">ì…ì¥ì ì²´í¬ ë™ì‘ ì„¤ì •</h3>
        <p class="hint" style="margin-top:0">
          ê³µìœ ìš© ì‹œíŠ¸ì˜ ì–´ëŠ í–‰/ì‹œíŠ¸/ì—´ì— ê°’ì„ ì“¸ì§€, ìƒíƒœ í…ìŠ¤íŠ¸ë¥¼ ë¬´ì—‡ìœ¼ë¡œ í• ì§€ ì„¤ì •í•©ë‹ˆë‹¤.
          ê°•ì˜ ìš´ì˜ ë°©ì‹ì— ë§ê²Œ ì¡°ì •í•´ì„œ ì‚¬ìš©í•˜ì„¸ìš”.
        </p>

        <div class="opt-grid">
          <div>
            <label>ì½ê¸° ì‹œì‘ í–‰ (READ_START_ROW)</label>
            <input id="optReadStartRow" type="number" min="1" />
          </div>
          <div>
            <label>ì“°ê¸° ì‹œì‘ í–‰ (WRITE_START_ROW)</label>
            <input id="optWriteStartRow" type="number" min="1" />
          </div>
          <div>
            <label>ì“°ê¸° ì‹œíŠ¸ ì´ë¦„</label>
            <input id="optWriteSheet" type="text" placeholder="ì˜ˆ: ê³µìœ ìš© ì‹œíŠ¸" />
          </div>
          <div>
            <label>ì…ì¥ ìƒíƒœ í…ìŠ¤íŠ¸</label>
            <input id="optStatusLabel" type="text" placeholder="ì˜ˆ: ì…ì¥" />
          </div>
        </div>

        <div class="row" style="margin-top:10px">
          <button id="optSave" class="btn acc" type="button">ì˜µì…˜ ì €ì¥</button>
          <button id="optReset" class="btn" type="button">ê¸°ë³¸ê°’ìœ¼ë¡œ ì´ˆê¸°í™”</button>
        </div>
      </div>
    </section>
  </section>

  <!-- ===== í™”ë©´ 4/5: ì•„ì§ì€ ì•ˆë‚´ ì¹´ë“œë§Œ ===== -->
  <section id="screen-students" class="screen">
    <button class="btn back-btn" type="button" id="backFromStudents">â† ëŒ€ì‹œë³´ë“œë¡œ ëŒì•„ê°€ê¸°</button>
    <div class="card">
      <h2 style="margin:0 0 8px;font-size:18px">ìˆ˜ê°•ìƒ ëª…ë‹¨ ì—…ë°ì´íŠ¸ (ì˜ˆì •)</h2>
      <p class="hint" style="margin:0">
        íšŒì‚¬ ì‚¬ì´íŠ¸ì˜ ê²°ì œì ëª…ë‹¨Â·CSVë¥¼ ë¶ˆëŸ¬ì™€ ê¸°ìˆ˜ë³„ ìˆ˜ê°•ìƒ ì‹œíŠ¸ë¥¼ ìë™ìœ¼ë¡œ ìƒì„±/ì •ë¦¬í•˜ëŠ” ê¸°ëŠ¥ì„
        ì´ í™”ë©´ì— íƒ‘ì¬í•  ì˜ˆì •ì…ë‹ˆë‹¤.
      </p>
    </div>
  </section>

  <section id="screen-drive" class="screen">
    <button class="btn back-btn" type="button" id="backFromDrive">â† ëŒ€ì‹œë³´ë“œë¡œ ëŒì•„ê°€ê¸°</button>
    <div class="card">
      <h2 style="margin:0 0 8px;font-size:18px">ë“œë¼ì´ë¸Œ í´ë” ëª¨ìŒ (ì˜ˆì •)</h2>
      <p class="hint" style="margin:0">
        ê°•ì˜ë³„Â·í”„ë¡œì íŠ¸ë³„ë¡œ ìì£¼ ì‚¬ìš©í•˜ëŠ” êµ¬ê¸€ ë“œë¼ì´ë¸Œ í´ë”ë¥¼ í•œ ë²ˆì— ëª¨ì•„ë‘ê³ ,
        ìš´ì˜ë´‡ì—ì„œ ë°”ë¡œ ì—´ ìˆ˜ ìˆëŠ” ê¸°ëŠ¥ì„ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤.
      </p>
    </div>
  </section>
</div>

<script>
/* ===== ê³µí†µ í—¬í¼ ===== */
const PANEL_SUFFIXES=['A','B'];
const $$=id=>document.getElementById(id);
const byPanel=(base,s)=>$$(base+s);
const txt=(id,v,sfx)=>{const el=sfx?byPanel(id,sfx):$$(id);if(el)el.textContent=v||'';};
const val=(id,sfx)=>{const el=sfx?byPanel(id,sfx):$$(id);return el?el.value:'';};
function on(id,ev,fn,sfx){
  const el=sfx?byPanel(id,sfx):$$(id);
  if(!el){console.warn('bind skip',id,sfx);return;}
  el.addEventListener(ev,e=>{try{fn(e);}catch(err){console.error(err);}});
}
function digitsOnly(s){return String(s||'').replace(/[^\d]/g,'');}
function last4Digits(s){const d=digitsOnly(s);return d.slice(-4);}
function normalizeName(n){
  let s=String(n||'').trim();
  s=s.replace(/[\s]*[\(\[\{ï¼ˆã€][^)\]\}ï¼‰ã€‘]*[\)\]\}ï¼‰ã€‘]\s*$/,'');
  s=s.replace(/[/_\-\s]+$/,'');
  s=s.replace(/\s+/g,' ');
  return s;
}
const earlierId=(a,b)=>{const ai=parseInt(a,10),bi=parseInt(b,10);if(!Number.isNaN(ai)&&!Number.isNaN(bi))return ai<=bi?a:b;return(String(a)<=String(b))?a:b;};

(function(){
  const pushErr=(msg,src,l,c,e)=>{
    const details=(e&&e.stack)?'\n'+e.stack:'';
    PANEL_SUFFIXES.forEach(s=>{
      const el=$$('#err'+s);
      if(el)el.textContent='ì˜¤ë¥˜: '+msg+(src?`\n${src}:${l}:${c}`:'')+details;
    });
  };
  window.addEventListener('error',e=>pushErr(e.message,e.filename,e.lineno,e.colno,e.error));
  window.addEventListener('unhandledrejection',e=>{
    const r=e.reason||{};
    pushErr(r.message||String(r),'',0,0,r);
  });
})();

/* ===== í™”ë©´ ì „í™˜ ===== */
function switchScreen(name){
  document.querySelectorAll('.screen').forEach(sc=>{
    sc.classList.toggle('active',sc.id===`screen-${name}`);
  });
}

/* ===== ì˜µì…˜ ê¸°ë³¸ê°’ / ì €ì¥ ===== */
const DEFAULT_OPTIONS={
  readStartRow:2,
  writeStartRow:2,
  writeSheet:'ê³µìœ ìš© ì‹œíŠ¸',
  statusLabel:'ì…ì¥'
};
let OPTIONS={...DEFAULT_OPTIONS};
const OPT_KEY='ca_kakao_opts_v1';

function loadOptions(){
  try{
    const raw=localStorage.getItem(OPT_KEY);
    if(raw){
      const obj=JSON.parse(raw);
      OPTIONS={...DEFAULT_OPTIONS,...obj};
    }else{
      OPTIONS={...DEFAULT_OPTIONS};
    }
  }catch(e){
    console.warn('ì˜µì…˜ ë¡œë“œ ì‹¤íŒ¨',e);
    OPTIONS={...DEFAULT_OPTIONS};
  }
}
function saveOptions(){
  try{
    localStorage.setItem(OPT_KEY,JSON.stringify(OPTIONS));
  }catch(e){
    console.warn('ì˜µì…˜ ì €ì¥ ì‹¤íŒ¨',e);
  }
}
function applyOptionsToUI(){
  const m=[
    ['optReadStartRow','readStartRow'],
    ['optWriteStartRow','writeStartRow'],
    ['optWriteSheet','writeSheet'],
    ['optStatusLabel','statusLabel']
  ];
  m.forEach(([id,key])=>{
    const el=$$(id);
    if(el)el.value=OPTIONS[key];
  });
}
function readOptionsFromUI(){
  const rs=parseInt(val('optReadStartRow'),10);
  const ws=parseInt(val('optWriteStartRow'),10);
  OPTIONS.readStartRow=Number.isFinite(rs)&&rs>0?rs:DEFAULT_OPTIONS.readStartRow;
  OPTIONS.writeStartRow=Number.isFinite(ws)&&ws>0?ws:DEFAULT_OPTIONS.writeStartRow;
  const wsName=val('optWriteSheet').trim();
  OPTIONS.writeSheet=wsName||DEFAULT_OPTIONS.writeSheet;
  const st=val('optStatusLabel').trim();
  OPTIONS.statusLabel=st||DEFAULT_OPTIONS.statusLabel;
}

/* ===== OAuth ===== */
let accessToken=null,tokenClient=null;
/* âœ… ì—¬ê¸°ì— ë³¸ì¸ OAuth í´ë¼ì´ì–¸íŠ¸ ID ë„£ê¸° */
const CLIENT_ID="18228268359-iifm4ck3j9kqj74eh1p90tco1k2mbpi0.apps.googleusercontent.com";

function handleLoggedIn(){
  txt('authState','ë¡œê·¸ì¸ ì™„ë£Œ');
  txt('authErr','');
  // ë¡œê·¸ì¸ í›„ ë©”ì¸ í™”ë©´ìœ¼ë¡œ
  switchScreen('main');
  // ê¸°ë³¸ ë“œë¼ì´ë¸Œ í´ë” A íŒ¨ë„ì— ì—°ê²°
  driveFolderId.A='1OIZGro5_CVmlsNiOuvtzbnHDukPJIcQJ';
  refreshDriveList('A');
  driveFolderId.B=null;
  refreshDriveList('B');
}

function initAuth(){
  try{
    if(!window.google?.accounts?.oauth2){txt('authErr','GIS ë¡œë“œ ì‹¤íŒ¨');return;}
    tokenClient=google.accounts.oauth2.initTokenClient({
      client_id:CLIENT_ID,
      scope:'https://www.googleapis.com/auth/spreadsheets https://www.googleapis.com/auth/drive.readonly',
      prompt:'',
      callback:res=>{accessToken=res.access_token;handleLoggedIn();},
      error_callback:err=>{txt('authErr','OAuth ì˜¤ë¥˜: '+(err?.error||err?.type||JSON.stringify(err)));}
    });
  }catch(e){txt('authErr','OAuth ì´ˆê¸°í™” ì˜¤ë¥˜');console.error(e);}
}
function requestAccess(){
  if(!tokenClient){txt('authErr','OAuth ì´ˆê¸°í™” ì‹¤íŒ¨');return;}
  tokenClient.requestAccessToken({prompt:'consent'});
}
function revokeAccess(){
  if(accessToken){
    google.accounts.oauth2.revoke(accessToken,()=>{
      accessToken=null;
      txt('authState','ë¯¸ë¡œê·¸ì¸');
      switchScreen('login');
    });
  }
}
function requireAuth(){if(!accessToken)throw new Error('ë¨¼ì € Google ë¡œê·¸ì¸í•˜ì„¸ìš”.');}

/* ===== Sheets & Drive ê³µí†µ ===== */
async function gFetch(url,init){
  requireAuth();
  const res=await fetch(url,{...(init||{}),headers:{...(init&&init.headers||{}),Authorization:'Bearer '+accessToken,'Content-Type':'application/json'}});
  if(!res.ok)throw new Error(await res.text());
  return res.json();
}
async function listSheets(spreadsheetId){
  const url=`https://sheets.googleapis.com/v4/spreadsheets/${encodeURIComponent(spreadsheetId)}?fields=sheets(properties(title))`;
  const data=await gFetch(url);
  return (data.sheets||[]).map(s=>s.properties.title);
}
async function getRange(spreadsheetId,rangeA1){
  const url=`https://sheets.googleapis.com/v4/spreadsheets/${encodeURIComponent(spreadsheetId)}/values/${encodeURIComponent(rangeA1)}`;
  return await gFetch(url);
}
async function batchUpdateValues(spreadsheetId,dataRanges){
  const url=`https://sheets.googleapis.com/v4/spreadsheets/${encodeURIComponent(spreadsheetId)}/values:batchUpdate`;
  return await gFetch(url,{method:'POST',body:JSON.stringify({valueInputOption:'USER_ENTERED',data:dataRanges})});
}

/* ===== ê´€ë¦¬ì(ìŠ¤í”„ë ˆë“œì‹œíŠ¸ íŒ¨ãƒƒã‚¯) ì €ì¥ ===== */
const PACKS_KEY='ca_gsapi_sources_v12';
const loadPacks=()=>{try{return JSON.parse(localStorage.getItem(PACKS_KEY)||'[]');}catch(e){return[];}};
const savePacks=ps=>localStorage.setItem(PACKS_KEY,JSON.stringify(ps));
const addPack=p=>{const a=loadPacks();a.push(p);savePacks(a);};
const removePack=id=>savePacks(loadPacks().filter(p=>p.id!==id));
const clearPacks=()=>localStorage.removeItem(PACKS_KEY);

let admBusy=false;
async function admAdd(){
  if(admBusy)return;
  admBusy=true;
  try{
    txt('admErr','');
    const label=(val('admLabel').trim()||'ìŠ¤í”„ë ˆë“œì‹œíŠ¸');
    const urlOrId=val('admUrl').trim();
    const m=urlOrId.match(/spreadsheets\/d\/([a-zA-Z0-9-_]+)/);
    const sheetId=m?m[1]:urlOrId;
    const readCol=(val('admReadCol').trim()||'C').toUpperCase();
    if(!sheetId)throw new Error('ìŠ¤í”„ë ˆë“œì‹œíŠ¸ ë§í¬/IDë¥¼ ì…ë ¥í•˜ì„¸ìš”.');
    const titles=await listSheets(sheetId);
    const pack={id:`${Date.now()}_${Math.random().toString(36).slice(2,7)}`,label,sheetId,readCol,sheets:titles};
    addPack(pack);
    ['admLabel','admUrl'].forEach(id=>{const el=$$(id);if(el)el.value='';});
    const rc=$$('admReadCol');if(rc)rc.value=readCol;
    renderAdmList();populatePacks('A');populatePacks('B');
    alert('ì—°ê²° ì™„ë£Œ! ê¸°ë³¸ ì²´í¬ íƒ­ì—ì„œ ì„ íƒí•´ì„œ ì‚¬ìš©í•˜ì„¸ìš”.');
  }catch(e){txt('admErr',e.message);}
  finally{admBusy=false;}
}
function renderAdmList(){
  const list=loadPacks();const tb=$$('admList');if(!tb)return;tb.innerHTML='';
  if(!list.length){tb.innerHTML='<tr><td colspan="4" style="color:#64748b">ì—†ìŒ</td></tr>';txt('admMeta','');return;}
  list.forEach(p=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${p.label}</td><td>${p.sheets?.length||0}</td><td>${p.readCol}</td><td><button class="btn" data-del="${p.id}" type="button">ì‚­ì œ</button></td>`;
    tb.appendChild(tr);
  });
  tb.querySelectorAll('button[data-del]').forEach(b=>b.addEventListener('click',e=>{
    removePack(e.target.getAttribute('data-del'));renderAdmList();populatePacks('A');populatePacks('B');
  }));
  txt('admMeta',`ì´ ${list.length}ê°œ ì—°ê²° Â· ${new Date().toLocaleString()}`);
}

/* ===== ì‹œíŠ¸ ì„ íƒ ===== */
function populatePacks(sfx){
  const packs=loadPacks();const sel=byPanel('sheetPackSelect',sfx);if(!sel)return;sel.innerHTML='';
  const readSel=byPanel('readSheetSelect',sfx);
  if(!packs.length){
    sel.appendChild(new Option('(ìŠ¤í”„ë ˆë“œì‹œíŠ¸ ì—°ê²° ì—†ìŒ)',''));
    if(readSel)readSel.innerHTML='';
    return;
  }
  sel.appendChild(new Option('ìŠ¤í”„ë ˆë“œì‹œíŠ¸ ì„ íƒ',''));
  packs.forEach(p=>sel.appendChild(new Option(p.label,p.id)));
  const prev=sessionStorage.getItem('ca_prev_pack_'+sfx);
  if(prev){const o=[...sel.options].find(x=>x.value===prev);if(o)o.selected=true;}
  onPackChanged(sfx);
}
async function refreshMeta(sfx){
  try{
    const sel=byPanel('sheetPackSelect',sfx);if(!sel)return;
    const id=sel.value;if(!id)return;
    const packs=loadPacks();const idx=packs.findIndex(p=>p.id===id);if(idx<0)return;
    const titles=await listSheets(packs[idx].sheetId);
    packs[idx].sheets=titles;savePacks(packs);onPackChanged(sfx);
  }catch(e){txt('err'+sfx,'ì‹œíŠ¸ ëª©ë¡ ê°±ì‹  ì‹¤íŒ¨: '+e.message);}
}
function onPackChanged(sfx){
  const sel=byPanel('sheetPackSelect',sfx);if(!sel)return;
  const id=sel.value;sessionStorage.setItem('ca_prev_pack_'+sfx,id||'');
  const packs=loadPacks();const p=packs.find(x=>x.id===id);
  const readSel=byPanel('readSheetSelect',sfx);
  if(readSel)readSel.innerHTML='';
  if(!p)return;
  if(readSel)readSel.appendChild(new Option('ì½ê¸° ì‹œíŠ¸ ì„ íƒ',''));
  (p.sheets||[]).forEach(t=>{if(readSel)readSel.appendChild(new Option(t,t));});
}

/* ===== ë“œë¼ì´ë¸Œ í´ë” / íŒŒì¼ ===== */
let driveFolderId={A:null,B:null};
let driveFiles={A:[],B:[]};

function extractDriveFolderId(input){
  const s=String(input||'').trim();if(!s)return'';
  const m=s.match(/folders\/([a-zA-Z0-9_-]+)/);
  if(m)return m[1];
  return s;
}
async function getDriveFolderName(folderId){
  requireAuth();
  const url=`https://www.googleapis.com/drive/v3/files/${encodeURIComponent(folderId)}?fields=name`;
  const res=await fetch(url,{headers:{Authorization:'Bearer '+accessToken}});
  if(!res.ok)throw new Error(await res.text());
  const data=await res.json();
  return data.name||folderId;
}
async function pickDriveFolder(sfx){
  try{
    const input=prompt('êµ¬ê¸€ ë“œë¼ì´ë¸Œ í´ë” URL ë˜ëŠ” IDë¥¼ ì…ë ¥í•˜ì„¸ìš”.','');
    if(!input)return;
    const id=extractDriveFolderId(input);
    if(!id)throw new Error('í´ë” IDë¥¼ ì¸ì‹í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
    driveFolderId[sfx]=id;
    await refreshDriveList(sfx);
  }catch(e){
    alert('ë“œë¼ì´ë¸Œ í´ë” ì„¤ì • ì‹¤íŒ¨: '+e.message);
    console.error(e);
  }
}
async function listDriveTxtFiles(folderId){
  requireAuth();
  const q=`'${folderId}' in parents and (mimeType='text/plain' or mimeType='text/csv') and trashed=false`;
  const url=`https://www.googleapis.com/drive/v3/files?q=${encodeURIComponent(q)}&fields=files(id,name,modifiedTime,size)&orderBy=modifiedTime desc&pageSize=1000`;
  const res=await fetch(url,{headers:{Authorization:'Bearer '+accessToken}});
  if(!res.ok)throw new Error(await res.text());
  const data=await res.json();
  return data.files||[];
}
async function refreshDriveList(sfx){
  const sel=byPanel('dirFileSelect',sfx);
  const nameSpan=byPanel('dirName',sfx);
  driveFiles[sfx]=[];
  if(sel)sel.innerHTML='';
  const folderId=driveFolderId[sfx];
  if(!folderId){
    if(nameSpan){nameSpan.textContent='';nameSpan.classList.remove('connected');}
    if(sel)sel.appendChild(new Option('(ë“œë¼ì´ë¸Œ í´ë” ì—°ê²°)',''));
    return;
  }
  try{
    const files=await listDriveTxtFiles(folderId);
    driveFiles[sfx]=files.map(f=>({id:f.id,name:f.name,size:f.size||0,mtime:f.modifiedTime?Date.parse(f.modifiedTime):0}));
    if(nameSpan){
      let displayName=folderId;
      try{displayName=await getDriveFolderName(folderId);}catch(e){console.warn('í´ë” ì´ë¦„ ì¡°íšŒ ì‹¤íŒ¨',e);}
      nameSpan.textContent=displayName;
      nameSpan.classList.add('connected');
    }
    if(sel){
      sel.appendChild(new Option('í´ë” ë‚´ íŒŒì¼ ì„ íƒ',''));
      driveFiles[sfx].forEach((f,idx)=>sel.appendChild(new Option(f.name,String(idx))));
    }
  }catch(e){
    if(nameSpan){nameSpan.textContent='';nameSpan.classList.remove('connected');}
    if(sel)sel.appendChild(new Option('(ë“œë¼ì´ë¸Œ ì ‘ê·¼ ì˜¤ë¥˜)',''));
    console.error(e);
    alert('ë“œë¼ì´ë¸Œ íŒŒì¼ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤: '+e.message);
  }
}

/* âœ… txt / csv ì½ê¸° : csvëŠ” Cì—´ë§Œ */
async function readSelectedTxt(sfx){
  const idxStr=val('dirFileSelect',sfx);
  if(!idxStr)throw new Error('í´ë” ë‚´ íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”.');
  const info=driveFiles[sfx][Number(idxStr)];
  if(!info)throw new Error('ì„ íƒí•œ íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');

  requireAuth();
  const url=`https://www.googleapis.com/drive/v3/files/${encodeURIComponent(info.id)}?alt=media`;
  const res=await fetch(url,{headers:{Authorization:'Bearer '+accessToken}});
  if(!res.ok)throw new Error(await res.text());

  const raw=await res.text();

  if(info.name.toLowerCase().endsWith('.csv')){
    const lines=raw.split(/\r?\n/);
    const colC=[];
    for(let i=0;i<lines.length;i++){
      const line=lines[i];
      if(!line.trim())continue;
      const cells=line.split(',');
      if(cells.length<3)continue;
      let cell=cells[2].trim();
      if(cell.startsWith('"')&&cell.endsWith('"')){
        cell=cell.slice(1,-1);
      }
      if(cell)colC.push(cell);
    }
    return colC.join('\n');
  }
  return raw;
}

/* ===== ì¹´í†¡ íŒŒì‹± ===== */
const JOIN_PAT=/(.*?)ë‹˜ì´\s*(ì…ì¥í•˜ì…¨ìŠµë‹ˆë‹¤|ë“¤ì–´ì™”ìŠµë‹ˆë‹¤|ì…ì¥í–ˆìŠµë‹ˆë‹¤|ë“¤ì–´ì˜¤ì…¨ìŠµë‹ˆë‹¤)[\s\.\!]*$/;
const LEAVE_PAT=/(.*?)ë‹˜ì´\s*(í‡´ì¥í•˜ì…¨ìŠµë‹ˆë‹¤|ë‚˜ê°”ìŠµë‹ˆë‹¤|í‡´ì¥í–ˆìŠµë‹ˆë‹¤|ë‚˜ê°€ì…¨ìŠµë‹ˆë‹¤)[\s\.\!]*$/;
const KICK_PAT=/(.*?)ë‹˜ì„\s*(ë‚´ë³´ëƒˆìŠµë‹ˆë‹¤|ê°•í‡´í–ˆìŠµë‹ˆë‹¤|ì¶”ë°©í–ˆìŠµë‹ˆë‹¤)[\s\.\!]*$/;

function splitNickname(nick){
  const raw=String(nick||'').trim();
  if(!raw)return null;
  const idx=raw.search(/\d/);
  let namePart=idx>=0?raw.slice(0,idx):raw;
  let name=namePart.replace(/[/_\-\s]+$/,'');
  name=normalizeName(name);
  if(!name)return{name:raw,digits:null};
  const digitsAll=raw.replace(/[^\d]/g,'');
  const digits=digitsAll.length>=4?digitsAll.slice(-4):null;
  return{name,digits};
}
function parseChat(text){
  const lines=text.split(/\r?\n/);
  const events=[];let joinedCount=0,leftCount=0;
  for(const raw of lines){
    const line=raw.trim();if(!line)continue;
    let m=line.match(JOIN_PAT);if(m){events.push({type:'join',nick:m[1].trim(),raw:line});joinedCount++;continue;}
    m=line.match(LEAVE_PAT);if(m){events.push({type:'leave',nick:m[1].trim(),raw:line});leftCount++;continue;}
    m=line.match(KICK_PAT);if(m){events.push({type:'leave',nick:m[1].trim(),raw:line});leftCount++;continue;}
  }
  return{events,joinedCount,leftCount};
}

/* ===== ì‹¤í–‰ ===== */
async function runMain(sfx){
  try{
    txt('err','',sfx);
    const resultsEl=byPanel('results',sfx);if(resultsEl)resultsEl.innerHTML='';
    const previewOnly=byPanel('previewOnly',sfx)?.checked;

    const chatText=await readSelectedTxt(sfx);
    const packSel=byPanel('sheetPackSelect',sfx);if(!packSel||!packSel.value)throw new Error('ìŠ¤í”„ë ˆë“œì‹œíŠ¸ë¥¼ ì„ íƒí•˜ì„¸ìš”.');
    const readSheet=val('readSheetSelect',sfx);if(!readSheet)throw new Error('ì½ê¸° ì‹œíŠ¸ë¥¼ ì„ íƒí•˜ì„¸ìš”.');
    const writeSheet=OPTIONS.writeSheet;

    const packs=loadPacks();const pack=packs.find(x=>x.id===packSel.value);if(!pack)throw new Error('ì—°ê²° ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
    const sheetId=pack.sheetId;const readCol=pack.readCol||'C';

    const {events,joinedCount,leftCount}=parseChat(chatText);

    const NAME_ONLY_SENTINEL='__NAMEONLY__';
    const activeDigitsByName=new Map();
    const leftFinalDigitsByName=new Map();
    const nameOnlyJoin=new Set();
    const ensure=(map,key)=>{if(!map.has(key))map.set(key,new Set());return map.get(key);};

    for(const ev of events){
      const s=splitNickname(ev.nick);
      if(!s)continue;
      const nN=s.name;
      if(ev.type==='join'){
        ensure(activeDigitsByName,nN).add(s.digits||NAME_ONLY_SENTINEL);
        if(leftFinalDigitsByName.has(nN)){
          const L=leftFinalDigitsByName.get(nN);
          L.delete(s.digits||NAME_ONLY_SENTINEL);
          if(L.size===0)leftFinalDigitsByName.delete(nN);
        }
        if(!s.digits)nameOnlyJoin.add(nN);
      }else{
        const A=ensure(activeDigitsByName,nN);
        if(s.digits)A.delete(s.digits);
        else if(A.size===1&&A.has(NAME_ONLY_SENTINEL))A.delete(NAME_ONLY_SENTINEL);
        ensure(leftFinalDigitsByName,nN).add(s.digits||NAME_ONLY_SENTINEL);
      }
    }

    const readNames=await getRange(sheetId,`${readSheet}!${readCol}${OPTIONS.readStartRow}:${readCol}`);
    const readRows=readNames.values||[];
    const rosterNames=[];const rosterNamesN=[];const rosterSetN=new Set();
    for(let i=0;i<readRows.length;i++){
      const nm=String(readRows[i]?.[0]??'').trim();
      if(!nm)continue;
      const nN=normalizeName(nm);
      rosterNames.push(nm);
      rosterNamesN.push(nN);
      rosterSetN.add(nN);
    }

    const wAtoE=await getRange(sheetId,`${writeSheet}!A${OPTIONS.writeStartRow}:E`);
    const wRowsAE=wAtoE.values||[];
    const earliestByKey=new Map();
    const earliestByName=new Map();
    for(const r of wRowsAE){
      const id=(r[0]??'').toString().trim();
      const nameRaw=(r[3]??'').toString().trim();
      const phoneRaw=(r[4]??'').toString().trim();
      if(!id||!nameRaw)continue;
      const nN=normalizeName(nameRaw);
      const p4=last4Digits(phoneRaw);
      if(p4){
        const key=nN+'|'+p4;
        if(!earliestByKey.has(key))earliestByKey.set(key,{id,phoneFull:phoneRaw,phone4:p4});
        else{
          const cur=earliestByKey.get(key);
          earliestByKey.set(key,earlierId(cur.id,id)===cur.id?cur:{id,phoneFull:phoneRaw,phone4:p4});
        }
      }
      if(!earliestByName.has(nN))earliestByName.set(nN,{id,phoneFull:phoneRaw,phone4:p4});
      else{
        const cur=earliestByName.get(nN);
        earliestByName.set(nN,earlierId(cur.id,id)===cur.id?cur:{id,phoneFull:phoneRaw,phone4:p4});
      }
    }

    const isAttendingNameN=nN=>{
      const set=activeDigitsByName.get(nN);
      return(set&&set.size>0)||nameOnlyJoin.has(nN);
    };
    const attendingSetN=new Set([...rosterSetN].filter(nN=>isAttendingNameN(nN)));

    const report=[];
    let attendingCount=0, missingCount=0;
    for(let i=0;i<rosterNames.length;i++){
      const nm=rosterNames[i];
      const nN=rosterNamesN[i];
      const phoneFull=earliestByName.get(nN)?.phoneFull||'';
      const set=activeDigitsByName.get(nN)||new Set();
      const any4=[...set].find(x=>x!==NAME_ONLY_SENTINEL)||'';
      const matchedId=
        any4&&earliestByKey.get(nN+'|'+any4)?earliestByKey.get(nN+'|'+any4).id:
        earliestByName.get(nN)?.id||'';
      const notes=(isAttendingNameN(nN)&&!any4)?'(ë²ˆí˜¸ì—†ìŒ)':'';
      const status=attendingSetN.has(nN)?OPTIONS.statusLabel:'ë¯¸ì…ì¥';
      if(status===OPTIONS.statusLabel)attendingCount++;else missingCount++;
      const rosterNo=matchedId;
      report.push([rosterNo,nm,phoneFull,status,any4?`${nm}/${any4}`:(status===OPTIONS.statusLabel?nm:''),notes]);
    }

    const extra=[];
    [...activeDigitsByName.entries()].sort(([a],[b])=>a.localeCompare(b,'ko')).forEach(([nN,set])=>{
      if(!rosterSetN.has(nN)){
        const digits=[...set].filter(x=>x!==NAME_ONLY_SENTINEL);
        if(digits.length)digits.forEach(d=>extra.push([`${nN}/${d}`]));
        if(set.has(NAME_ONLY_SENTINEL))extra.push([`${nN}(ë²ˆí˜¸ì—†ìŒ)`]);
      }
    });

    const leavers=[];
    [...leftFinalDigitsByName.entries()].sort(([a],[b])=>a.localeCompare(b,'ko')).forEach(([nN,set])=>{
      const activeSet=activeDigitsByName.get(nN);
      set.forEach(d=>{
        if(!activeSet||!activeSet.has(d)){
          if(d===NAME_ONLY_SENTINEL)leavers.push([`${nN}(ë²ˆí˜¸ì—†ìŒ)`]);
          else leavers.push([`${nN}/${d}`]);
        }
      });
    });

    const readWriteRange=`${writeSheet}!D${OPTIONS.writeStartRow}:T`;
    const wdata=await getRange(sheetId,readWriteRange);
    const rows=wdata.values||[];
    const targetRowsIdx=[];
    const nameCountN=new Map();
    for(let i=0;i<rows.length;i++){
      const r=rows[i]||[];
      const tVal=(r[16]??'').toString().trim(); // Tì—´
      if(tVal!=='ìˆ˜ê°•ìƒ')continue;
      const nameN=normalizeName(String(r[0]??'')); // D
      if(!nameN)continue;
      targetRowsIdx.push(i);
      nameCountN.set(nameN,(nameCountN.get(nameN)||0)+1);
    }
    const updates=[];
    const unresolved=[];
    for(const i of targetRowsIdx){
      const r=rows[i]||[];
      const nameRaw=String(r[0]??'').trim();
      const nameN=normalizeName(nameRaw);
      const phone4=last4Digits(r[1]??'');
      if(!nameN)continue;
      if(!attendingSetN.has(nameN))continue;
      const set=activeDigitsByName.get(nameN)||new Set();
      const isDupInPaid=(nameCountN.get(nameN)||0)>1;
      let canWrite=false;
      if(isDupInPaid){
        if(phone4&&set.has(phone4))canWrite=true;
        else{
          if(set.has(NAME_ONLY_SENTINEL))unresolved.push([nameRaw,'ê³µìœ ì‹œíŠ¸ ë™ëª…ì´ì¸ + ì…ì¥ë¡œê·¸ ë²ˆí˜¸ì—†ìŒ']);
          else unresolved.push([nameRaw,'ê³µìœ ì‹œíŠ¸ ë™ëª…ì´ì¸ + ë²ˆí˜¸ë¶ˆì¼ì¹˜']);
        }
      }else{
        if(set.size>=1||set.has(NAME_ONLY_SENTINEL))canWrite=true;
      }
      if(canWrite){
        const rowNumber=OPTIONS.writeStartRow+i;
        updates.push({range:`${writeSheet}!S${rowNumber}`,values:[[OPTIONS.statusLabel]]});
      }
    }

    if(updates.length&&!previewOnly){
      await batchUpdateValues(sheetId,updates);
    }

    const pills=$$('#pills'+sfx+sfx);
    if(pills){
      pills.innerHTML='';
      const mk=(t,c)=>{const s=document.createElement('span');s.className='pill '+c;s.textContent=t;return s;};
      pills.appendChild(mk(`ì…ì¥ë¡œê·¸ join ${joinedCount}`,'ok'));
      pills.appendChild(mk(`í‡´ì¥ë¡œê·¸ leave ${leftCount}`,'bad'));
      pills.appendChild(mk(`ì…ì¥ ëŒ€ìƒ(ì½ê¸° ì‹œíŠ¸) ${attendingSetN.size}`,'warn'));
      pills.appendChild(mk(`ëª…ë‹¨ ì™¸ ì…ì¥ì ${extra.length}`,'warn'));
      if(previewOnly)pills.appendChild(mk('ì²´í¬ë§Œ ëª¨ë“œ','warn'));
    }

    function resTbl(title,headers,rowsArr){
      if(!resultsEl)return;
      const wrap=document.createElement('div');wrap.className='card';
      const h=document.createElement('h3');h.textContent=title;h.style.margin='0 0 8px';wrap.appendChild(h);
      const t=document.createElement('table');const thead=document.createElement('thead');const trh=document.createElement('tr');
      headers.forEach(x=>{const th=document.createElement('th');th.textContent=x;trh.appendChild(th);});
      thead.appendChild(trh);t.appendChild(thead);
      const tb=document.createElement('tbody');
      (rowsArr||[]).forEach(r=>{const tr=document.createElement('tr');(r||[]).forEach(c=>{const td=document.createElement('td');td.textContent=(c==null?'':String(c));tr.appendChild(td);});tb.appendChild(tr);});
      t.appendChild(tb);wrap.appendChild(t);resultsEl.appendChild(wrap);
    }

    const summaryRows=[
      ['ì´ ëŒ€ìƒ ìˆ˜',rosterNames.length],
      [OPTIONS.statusLabel,attendingCount],
      ['ë¯¸ì…ì¥',missingCount],
      ['í‡´ì¥ì(ìµœì¢…)',leavers.length],
      ['ëª…ë‹¨ ì™¸ ì…ì¥ì',extra.length],
      ['ë¯¸í™•ì¸(ë™ëª…ì´ì¸/ë²ˆí˜¸ ë¬¸ì œ)',unresolved.length]
    ];
    resTbl('ìš”ì•½', ['í•­ëª©','ê°’'], summaryRows);

    resTbl('ë‚´ ëª…ë‹¨ ê¸°ì¤€ ìƒíƒœ(ì½ê¸° ì‹œíŠ¸)', ['no','name','phone','status','matched_id','notes'], report);
    resTbl('ëª…ë‹¨ ì™¸ ì…ì¥ì',['name/last4 or (ë²ˆí˜¸ì—†ìŒ)'],extra);
    resTbl('í‡´ì¥ì ëª…ë‹¨(ìµœì¢…)',['name/last4 or (ë²ˆí˜¸ì—†ìŒ)'],leavers);
    resTbl(previewOnly?'ì˜ˆìƒ ê°±ì‹  ê²°ê³¼(ì²´í¬ë§Œ ëª¨ë“œ)':'ê³µìœ  ì‹œíŠ¸ ê°±ì‹  ê²°ê³¼',
      ['updated_cells'],
      updates.map(u=>[u.range+` â† ${OPTIONS.statusLabel}`])
    );
    resTbl('ë¯¸í™•ì¸ ëª©ë¡(ê³µìœ  ì‹œíŠ¸ ë™ëª…ì´ì¸/ë²ˆí˜¸ ë¬¸ì œ)',['name','reason'],unresolved);

  }catch(e){
    txt('err','ì˜¤ë¥˜: '+(e?.message||e),sfx);
    console.error(e);
  }
}

/* ===== ë°ëª¨ ===== */
function runDemo(sfx){
  txt('err','',sfx);
  const resultsEl=byPanel('results',sfx);
  if(resultsEl)resultsEl.innerHTML='';

  const roster=[
    {id:1,name:'í™©í˜„í•˜',phone:'010-1234-5678'},
    {id:3,name:'ê¹€í˜œì˜',phone:'010-3456-7890'},
    {id:4,name:'ì„ê·œë¦¬',phone:'010-1717-1771'},
    {id:5,name:'ê¹€ì˜ˆì€',phone:'010-1111-0000'},
    {id:6,name:'ë°©ì˜ˆì§„',phone:'010-0000-9999'},
  ];
  const rosterSetN=new Set(roster.map(r=>normalizeName(r.name)));
  const chatText=[
    'ê¹€ì˜ˆì€/0000ë‹˜ì´ ì…ì¥í•˜ì…¨ìŠµë‹ˆë‹¤',
    'í™©í˜„í•˜/5678ë‹˜ì´ ì…ì¥í•˜ì…¨ìŠµë‹ˆë‹¤',
    'ë°©ì˜ˆì§„/9999ë‹˜ì´ ì…ì¥í–ˆìŠµë‹ˆë‹¤',
    'ì„ê·œë¦¬ 1771ë‹˜ì´ ë“¤ì–´ì™”ìŠµë‹ˆë‹¤',
    'ê¹€í˜œì˜/7890ë‹˜ì´ ì…ì¥í•˜ì…¨ìŠµë‹ˆë‹¤',
    'ì§„ì¢…ë²”/2514ë‹˜ì´ ì…ì¥í•˜ì…¨ìŠµë‹ˆë‹¤',
    'ë§¤ë“œë“œë¼ì´ë²„ê¹€ì§€í˜„ë‹˜ì´ ì…ì¥í•˜ì…¨ìŠµë‹ˆë‹¤',
    'ì„¸ê³„ì œì¼ì˜ê·œë¦¬ë‹¹ì¥ì°¬ì–‘ë‹˜ì´ ë‚˜ê°”ìŠµë‹ˆë‹¤.',
    'ì†¡ì§€í˜„ì˜ˆì˜ë‹¤ë‹˜ì„ ë‚´ë³´ëƒˆìŠµë‹ˆë‹¤.'
  ].join('\n');
  const {events,joinedCount,leftCount}=parseChat(chatText);
  const NAME_ONLY_SENTINEL='__NAMEONLY__';
  const active=new Map();const leftFinal=new Map();
  const ensure=(map,key)=>{if(!map.has(key))map.set(key,new Set());return map.get(key);};
  for(const ev of events){
    const s=splitNickname(ev.nick);if(!s)continue;
    const nN=s.name;
    if(ev.type==='join'){
      ensure(active,nN).add(s.digits||NAME_ONLY_SENTINEL);
      const L=leftFinal.get(nN);if(L){L.delete(s.digits||NAME_ONLY_SENTINEL);if(L.size===0)leftFinal.delete(nN);}
    }else{
      const A=ensure(active,nN);
      if(s.digits)A.delete(s.digits);
      else if(A.size===1&&A.has(NAME_ONLY_SENTINEL))A.delete(NAME_ONLY_SENTINEL);
      ensure(leftFinal,nN).add(s.digits||NAME_ONLY_SENTINEL);
    }
  }
  const paidRows=[
    {name:'ê¹€ì˜ˆì€',phone4:'0000'},
    {name:'ë°©ì˜ˆì§„',phone4:'9999'},
    {name:'í™©í˜„í•˜',phone4:'5678'},
    {name:'í™©í˜„í•˜',phone4:'9999'},
    {name:'ê¹€í˜œì˜',phone4:''},
  ];
  const paidNameCountN=new Map();
  for(const r of paidRows){
    const nN=normalizeName(r.name);
    paidNameCountN.set(nN,(paidNameCountN.get(nN)||0)+1);
  }
  const report=[];
  let attendingCount=0,missingCount=0;
  for(const r of roster){
    const nN=normalizeName(r.name);
    const set=active.get(nN)||new Set();
    const isActive=set.size>0;
    const any4=[...set].find(x=>x!==NAME_ONLY_SENTINEL)||'';
    const status=isActive?OPTIONS.statusLabel:'ë¯¸ì…ì¥';
    if(status===OPTIONS.statusLabel)attendingCount++;else missingCount++;
    report.push([String(r.id),r.name,r.phone,status,isActive?(any4?`${r.name}/${any4}`:r.name):'',isActive&&!any4?'(ë²ˆí˜¸ì—†ìŒ)':'']);
  }
  const extra=[];
  [...active.entries()].sort(([a],[b])=>a.localeCompare(b,'ko')).forEach(([nN,set])=>{
    if(!rosterSetN.has(nN)){
      const digits=[...set].filter(x=>x!==NAME_ONLY_SENTINEL);
      if(digits.length)digits.forEach(d=>extra.push([`${nN}/${d}`]));
      if(set.has(NAME_ONLY_SENTINEL))extra.push([`${nN}(ë²ˆí˜¸ì—†ìŒ)`]);
    }
  });
  const leavers=[];
  [...leftFinal.entries()].sort(([a],[b])=>a.localeCompare(b,'ko')).forEach(([nN,set])=>{
    const act=active.get(nN);
    set.forEach(d=>{if(!act||!act.has(d))leavers.push([d===NAME_ONLY_SENTINEL?`${nN}(ë²ˆí˜¸ì—†ìŒ)`:`${nN}/${d}`]);});
  });
  const unresolved=[];
  for(const r of paidRows){
    const nN=normalizeName(r.name);
    const set=active.get(nN)||new Set();
    const isDupInPaid=(paidNameCountN.get(nN)||0)>1;
    if(!isDupInPaid)continue;
    const p4=(r.phone4||'').trim();
    if(p4&&set.has(p4))continue;
    unresolved.push([r.name,p4?'ê³µìœ ì‹œíŠ¸ ë™ëª…ì´ì¸ + ë²ˆí˜¸ë¶ˆì¼ì¹˜':'ê³µìœ ì‹œíŠ¸ ë™ëª…ì´ì¸ + ì…ì¥ë¡œê·¸ ë²ˆí˜¸ì—†ìŒ']);
  }
  const pills=$$('#pills'+sfx+sfx);
  if(pills){
    pills.innerHTML='';
    const mk=(t,c)=>{const s=document.createElement('span');s.className='pill '+c;s.textContent=t;return s;};
    pills.appendChild(mk(`ì…ì¥ë¡œê·¸ join ${joinedCount}`,'ok'));
    pills.appendChild(mk(`í‡´ì¥ë¡œê·¸ leave ${leftCount}`,'bad'));
    const attendingDemo=roster.filter(r=>(active.get(normalizeName(r.name))||new Set()).size>0).length;
    pills.appendChild(mk(`ì…ì¥ ëŒ€ìƒ(ë°ëª¨) ${attendingDemo}`,'warn'));
    pills.appendChild(mk('ì²´í¬ë§Œ ëª¨ë“œ(ë°ëª¨)','warn'));
  }
  function resTbl(title,headers,rowsArr){
    if(!resultsEl)return;
    const wrap=document.createElement('div');wrap.className='card';
    const h=document.createElement('h3');h.textContent=title;h.style.margin='0 0 8px';wrap.appendChild(h);
    const t=document.createElement('table');const thead=document.createElement('thead');const trh=document.createElement('tr');
    headers.forEach(x=>{const th=document.createElement('th');th.textContent=x;trh.appendChild(th);});
    thead.appendChild(trh);t.appendChild(thead);
    const tb=document.createElement('tbody');
    (rowsArr||[]).forEach(r=>{const tr=document.createElement('tr');(r||[]).forEach(c=>{const td=document.createElement('td');td.textContent=(c==null?'':String(c));tr.appendChild(td);});tb.appendChild(tr);});
    t.appendChild(tb);wrap.appendChild(t);resultsEl.appendChild(wrap);
  }

  const summaryRows=[
    ['ì´ ëŒ€ìƒ ìˆ˜',roster.length],
    [OPTIONS.statusLabel,attendingCount],
    ['ë¯¸ì…ì¥',missingCount],
    ['í‡´ì¥ì(ë°ëª¨)',leavers.length],
    ['ëª…ë‹¨ ì™¸ ì…ì¥ì(ë°ëª¨)',extra.length],
    ['ë¯¸í™•ì¸(ë°ëª¨)',unresolved.length]
  ];
  resTbl('ìš”ì•½(ë°ëª¨)', ['í•­ëª©','ê°’'], summaryRows);
  resTbl('ëª…ë‹¨ê¸°ì¤€ ì…ì¥ì(ë°ëª¨)',['no','name','phone','status','matched_id','notes'],report);
  resTbl('ëª…ë‹¨ ì™¸ ì…ì¥ì(ë°ëª¨)',['name/last4 or (ë²ˆí˜¸ì—†ìŒ)'],extra);
  resTbl('í‡´ì¥ì ëª…ë‹¨(ë°ëª¨)',['name/last4 or (ë²ˆí˜¸ì—†ìŒ)'],leavers);
  resTbl('ë¯¸í™•ì¸ ëª©ë¡(ë°ëª¨)',['name','reason'],unresolved);
}

/* ===== ì´ˆê¸°í™” ===== */
window.addEventListener('load',()=>{if(window.google?.accounts?.oauth2)initAuth();});
document.addEventListener('DOMContentLoaded',()=>{
  // ì˜µì…˜ ë¡œë“œ/í‘œì‹œ
  loadOptions();
  applyOptionsToUI();

  // ë¡œê·¸ì¸ ë²„íŠ¼ë“¤
  on('gsLoginBtn','click',requestAccess);
  on('loginMainBtn','click',requestAccess);
  on('gsLogoutBtn','click',revokeAccess);

  // í™”ë©´ ë„¤ë¹„ê²Œì´ì…˜
  document.querySelectorAll('.tile[data-goto]').forEach(t=>{
    t.addEventListener('click',()=>{
      const target=t.getAttribute('data-goto');
      switchScreen(target);
    });
  });
  on('backFromKakao','click',()=>switchScreen('main'));
  on('backFromStudents','click',()=>switchScreen('main'));
  on('backFromDrive','click',()=>switchScreen('main'));

  // ê´€ë¦¬ì(ì˜µì…˜ íƒ­) ì´ë²¤íŠ¸
  on('admAdd','click',admAdd);
  on('admClearAll','click',()=>{if(confirm('ëª¨ë“  ì—°ê²°ì„ ì‚­ì œí• ê¹Œìš”?')){clearPacks();renderAdmList();populatePacks('A');populatePacks('B');}});

  on('optSave','click',()=>{
    readOptionsFromUI();
    saveOptions();
    alert('ì˜µì…˜ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
  });
  on('optReset','click',()=>{
    OPTIONS={...DEFAULT_OPTIONS};
    applyOptionsToUI();
    saveOptions();
    alert('ì˜µì…˜ì„ ê¸°ë³¸ê°’ìœ¼ë¡œ ë˜ëŒë ¸ìŠµë‹ˆë‹¤.');
  });

  // íŒ¨ë„ A
  on('sheetPackSelect','change',()=>onPackChanged('A'),'A');
  on('refreshMeta','click',()=>refreshMeta('A'),'A');
  on('runBtn','click',()=>runMain('A'),'A');
  on('demoBtn','click',()=>runDemo('A'),'A');
  on('dirPick','click',()=>pickDriveFolder('A'),'A');
  on('dirRefresh','click',()=>refreshDriveList('A'),'A');

  // íŒ¨ë„ B
  on('sheetPackSelect','change',()=>onPackChanged('B'),'B');
  on('refreshMeta','click',()=>refreshMeta('B'),'B');
  on('runBtn','click',()=>runMain('B'),'B');
  on('demoBtn','click',()=>runDemo('B'),'B');
  on('dirPick','click',()=>pickDriveFolder('B'),'B');
  on('dirRefresh','click',()=>refreshDriveList('B'),'B');

  // ì´ˆê¸° ìŠ¤í”„ë ˆë“œì‹œíŠ¸ ìƒíƒœ (ë¡œì»¬ ì €ì¥ëœ ê²ƒë§Œ)
  renderAdmList();
  populatePacks('A');
  populatePacks('B');

  // ì¹´í†¡ ì„œë¸Œíƒ­ ì „í™˜
  const tabButtons=document.querySelectorAll('.subtab-btn');
  const tabScreens=document.querySelectorAll('.tab-screen');
  tabButtons.forEach(btn=>{
    btn.addEventListener('click',()=>{
      const target=btn.dataset.tab;
      tabButtons.forEach(b=>b.classList.toggle('active',b===btn));
      tabScreens.forEach(sc=>sc.classList.toggle('active',sc.id==='tab-'+target));
    });
  });

  // ì²˜ìŒì—” ë¡œê·¸ì¸ í™”ë©´
  switchScreen('login');
});
</script>
</body>
</html>
