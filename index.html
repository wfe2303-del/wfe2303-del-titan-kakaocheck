<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>í´ë˜ìŠ¤ì–´ë¼ìš´ë“œ Â· ìš´ì˜ë´‡ ëŒ€ì‹œë³´ë“œ</title>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <style>
    :root{
      --bg:#fff; --card:#fff; --surface:#f8fafc; --line:#e5e7eb; --text:#0f172a; --muted:#64748b;
      --accent:#60a5fa; --accent-strong:#3b82f6; --ok:#22c55e; --warn:#f59e0b; --bad:#ef4444;
      --radius:12px; --ctl-h:42px; --gap:12px; --logo-size:112px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;background:var(--bg);color:var(--text);
      font:14px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
    }
    .wrap{max-width:1200px;margin:28px auto;padding:0 16px}
    h1{font-size:22px;margin:0 0 8px}
    .card{
      background:var(--card);border:1px solid var(--line);
      border-radius:16px;padding:16px;margin-bottom:16px;
    }
    label{display:block;color:var(--muted);margin-bottom:6px}
    select{
      width:100%; background:#fff; color:var(--text); border:1px solid var(--line);
      border-radius:var(--radius); padding:10px 12px; outline:none; height:var(--ctl-h);
    }
    .btn{
      appearance:none; border:1px solid var(--line); background:#fff; color:var(--text);
      padding:10px 14px; border-radius:var(--radius); cursor:pointer; transition:all .15s ease;
      height:var(--ctl-h); display:inline-flex; align-items:center; justify-content:center;
      font-size:14px; gap:6px;
    }
    .btn:hover{border-color:var(--accent-strong);box-shadow:0 0 0 3px rgba(96,165,250,.2)}
    .btn.acc{background:var(--accent);border-color:var(--accent);color:#fff}
    .btn.acc:hover{background:var(--accent-strong);border-color:var(--accent-strong)}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .hint{color:#64748b;font-size:12px}
    .err{color:#ef4444;font-family:ui-monospace,monospace;white-space:pre-wrap}

    .pill{display:inline-flex;gap:8px;align-items:center;padding:6px 10px;border:1px solid var(--line);border-radius:999px;color:var(--muted);background:#fff}
    .pill.ok{border-color:rgba(34,197,94,.25);color:var(--ok)}
    .pill.warn{border-color:rgba(245,158,11,.25);color:var(--warn)}
    .pill.bad{border-color:rgba(239,68,68,.25);color:var(--bad)}
    table{width:100%;border-collapse:collapse;border:1px solid var(--line);overflow:auto;background:#fff;border-radius:12px}
    th,td{padding:8px 10px;border-bottom:1px solid var(--line);text-align:left;vertical-align:top}
    th{color:#0f172a;font-weight:600;background:#f1f5f9;position:sticky;top:0}

    .brand{display:flex;align-items:center;gap:14px;margin:0 0 16px}
    .brand h1{margin:0;font-size:22px}
    .brand-logo{width:var(--logo-size);height:var(--logo-size);flex:0 0 var(--logo-size)}
    .logo-text{
      font-family:'Nunito','Arial Rounded MT','SF Pro Rounded','Quicksand','Pretendard','Noto Sans KR',sans-serif;
      font-weight:900; letter-spacing:-0.2px; fill:#0f172a; font-size:18px;
      paint-order:stroke fill; stroke:#0f172a; stroke-width:.9px;
    }

    :root{--admin-h:44px}
    .admin-drawer input,.admin-drawer .btn{height:var(--admin-h);line-height:calc(var(--admin-h) - 2px);border-radius:12px}

    .panels{display:grid;gap:16px}
    @media(min-width:1100px){ .panels{grid-template-columns:1fr 1fr} }

    .controls{display:grid;gap:var(--gap)}
    .controls-line{display:grid;align-items:end;gap:var(--gap);grid-template-columns:1.2fr 1fr var(--ctl-h)}
    .icon-btn{width:var(--ctl-h);height:var(--ctl-h);border:1px solid var(--line);border-radius:10px;background:#fff;display:inline-flex;align-items:center;justify-content:center;cursor:pointer}
    .icon-btn:hover{border-color:var(--accent-strong);box-shadow:0 0 0 3px rgba(96,165,250,.2)}
    .icon-btn svg{width:18px;height:18px}

    .dirline{
      display:grid;align-items:center;gap:8px;
      grid-template-columns:auto minmax(120px,auto) minmax(240px,1fr) auto;
    }
    .dirlabel{
      display:none;
      color:#64748b;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
      font-weight:700;
    }
    .dirlabel::before{content:"ğŸ“";margin-right:8px;opacity:.9}
    .dirlabel.connected{display:inline-block;color:var(--accent-strong);font-weight:800}

    .gear-btn{position:fixed;top:16px;right:16px;z-index:50;background:#fff;border:1px solid var(--line);border-radius:12px;padding:8px;cursor:pointer}
    .admin-overlay{position:fixed;inset:0;background:rgba(15,23,42,.28);backdrop-filter:saturate(140%) blur(2px);visibility:hidden;opacity:0;pointer-events:none;transition:.15s;z-index:60}
    .admin-overlay.open{visibility:visible;opacity:1;pointer-events:auto}
    .admin-drawer{position:fixed;top:0;right:0;height:100%;width:520px;max-width:92vw;background:#fff;border-left:1px solid var(--line);box-shadow:-8px 0 24px rgba(0,0,0,.08);padding:16px 16px 24px;display:flex;flex-direction:column;gap:12px;z-index:70;transform:translateX(12px);opacity:0;pointer-events:none;transition:transform .15s, opacity .15s}
    .admin-drawer.open{transform:translateX(0);opacity:1;pointer-events:auto}
    .x-btn{appearance:none;border:1px solid var(--line);background:#fff;border-radius:10px;padding:6px 8px;cursor:pointer}

    /* ==== ì—¬ëŸ¬ í™”ë©´(screens) ê³µí†µ ==== */
    .screen{display:none;min-height:100vh;}
    .screen.active{display:block;}

    .topbar{
      border-bottom:1px solid var(--line);
      background:#f8fafc;
    }
    .topbar-inner{
      max-width:1200px;margin:0 auto;padding:10px 16px;
      display:flex;align-items:center;justify-content:space-between;gap:12px;
    }
    .topbar-nav{display:flex;gap:8px;flex-wrap:wrap}
    .topbar-title{font-weight:600;color:#0f172a;font-size:15px}

    /* ë©”ì¸ ëŒ€ì‹œë³´ë“œ ì¹´ë“œ */
    .dashboard-grid{
      display:grid;gap:16px;
    }
    @media(min-width:900px){
      .dashboard-grid{grid-template-columns:repeat(2,minmax(0,1fr));}
    }
    .feature-card{
      border-radius:18px;border:1px solid var(--line);padding:18px;
      background:linear-gradient(135deg,#eff6ff,#f9fafb);
      cursor:pointer;transition:.15s box-shadow,.15s transform,.15s border-color;
      display:flex;flex-direction:column;gap:8px;
    }
    .feature-card:hover{
      box-shadow:0 12px 30px rgba(15,23,42,.12);
      border-color:var(--accent-strong);
      transform:translateY(-2px);
    }
    .feature-title{font-size:16px;font-weight:700;display:flex;align-items:center;gap:8px}
    .feature-tagline{font-size:13px;color:var(--muted)}
    .feature-meta{font-size:12px;color:#94a3b8}

    /* ì‚¼ì§€ì°½ ëŠë‚Œì˜ íƒ­ (ê¸°ëŠ¥ ë‚´ë¶€ ì „í™˜ìš©) */
    .tri-tabs{
      display:inline-flex;border:1px solid var(--line);border-radius:999px;overflow:hidden;background:#f8fafc;
    }
    .tri-tab{
      padding:6px 12px;font-size:12px;border:none;background:transparent;cursor:pointer;
      color:#64748b;display:flex;align-items:center;gap:4px;
    }
    .tri-tab.active{
      background:#fff;color:#0f172a;font-weight:600;
      box-shadow:0 0 0 1px rgba(148,163,184,.4);
    }

    .big-login-btn{
      font-size:16px;font-weight:600;padding:14px 24px;border-radius:999px;
      min-width:220px;justify-content:center;
    }
  </style>
</head>
<body>

<div id="app">

  <!-- ======================= ë¡œê·¸ì¸ í™”ë©´ ======================= -->
  <section id="screen-login" class="screen active">
    <div class="wrap">
      <header class="brand" style="margin-top:40px">
        <svg class="brand-logo" viewBox="0 0 90 50" role="img" aria-label="ClassAround">
          <rect width="90" height="50" rx="10" fill="white"/>
          <circle cx="66" cy="10" r="8" fill="#6b8bd6"/>
          <circle cx="80" cy="18" r="5" fill="#ef4444"/>
          <text x="8" y="24" class="logo-text">Class</text>
          <text x="8" y="42" class="logo-text">Around</text>
        </svg>
        <div>
          <h1>í´ë˜ìŠ¤ì–´ë¼ìš´ë“œ ìš´ì˜ë´‡ ëŒ€ì‹œë³´ë“œ</h1>
          <div class="hint">Google ê³„ì •ìœ¼ë¡œ ë¡œê·¸ì¸í•˜ë©´ ìˆ˜ê°•ìƒ ëª…ë‹¨, ì¹´í†¡ ì…ì¥ì ì²´í¬, í´ë” ëª©ë¡, GPTs ê¸°ëŠ¥ì„ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</div>
        </div>
      </header>

      <div class="card" style="text-align:center;margin-top:24px">
        <p style="margin:0 0 12px;font-size:15px">ë¨¼ì € Google ê³„ì •ìœ¼ë¡œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.</p>
        <div class="row" style="justify-content:center;margin-bottom:8px">
          <button id="gsLoginBtn" class="btn acc big-login-btn" type="button">
            <span>ğŸ” Googleë¡œ ë¡œê·¸ì¸</span>
          </button>
          <button id="gsLogoutBtn" class="btn" type="button">ë¡œê·¸ì•„ì›ƒ</button>
        </div>
        <div id="authState" class="hint">ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.</div>
        <div id="authErr" class="err" style="margin-top:6px"></div>
      </div>
    </div>
  </section>

  <!-- ======================= ë©”ì¸ ëŒ€ì‹œë³´ë“œ í™”ë©´ ======================= -->
  <section id="screen-home" class="screen">
    <header class="topbar">
      <div class="topbar-inner">
        <div class="row" style="gap:10px">
          <svg class="brand-logo" viewBox="0 0 90 50" role="img" aria-label="ClassAround" style="width:60px;height:34px">
            <rect width="90" height="50" rx="10" fill="white"/>
            <circle cx="66" cy="10" r="8" fill="#6b8bd6"/>
            <circle cx="80" cy="18" r="5" fill="#ef4444"/>
            <text x="8" y="24" class="logo-text">Class</text>
            <text x="8" y="42" class="logo-text">Around</text>
          </svg>
          <div>
            <div class="topbar-title">í´ë˜ìŠ¤ì–´ë¼ìš´ë“œ ìš´ì˜ë´‡ ëŒ€ì‹œë³´ë“œ</div>
            <div id="homeAuthState" class="hint">ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸ ì¤‘...</div>
          </div>
        </div>
        <div class="topbar-nav">
          <button class="btn" type="button" data-screen-target="home">ğŸ  ëŒ€ì‹œë³´ë“œ</button>
          <button class="btn" type="button" id="goLogoutFromHome">ë¡œê·¸ì•„ì›ƒ</button>
        </div>
      </div>
    </header>

    <div class="wrap">
      <div class="card" style="margin-top:16px">
        <div class="hint" style="margin-bottom:8px">ê¸°ëŠ¥ ì„ íƒ</div>
        <div class="dashboard-grid">
          <button class="feature-card" type="button" data-screen-target="roster">
            <div class="feature-title">ğŸ“‹ ìˆ˜ê°•ìƒ ëª…ë‹¨ ì—…ë°ì´íŠ¸</div>
            <div class="feature-tagline">ê²°ì œì CSV / ì‹œíŠ¸ â†’ í†µí•© ìˆ˜ê°•ìƒ ëª…ë‹¨ ìë™ ì •ë¦¬</div>
            <div class="feature-meta">í–¥í›„: ê¸°ìˆ˜ë³„ í•„í„°, ì¤‘ë³µ ì œê±°, í™˜ë¶ˆì ë°˜ì˜</div>
          </button>

          <button class="feature-card" type="button" data-screen-target="kakao">
            <div class="feature-title">ğŸ’¬ ì¹´í†¡ ì…ì¥ì ì²´í¬</div>
            <div class="feature-tagline">ì¹´í†¡ ëŒ€í™” ë‚´ì—­(txt/csv) + ìˆ˜ê°•ìƒ ëª…ë‹¨ìœ¼ë¡œ ì…ì¥/ë¯¸ì…ì¥/í‡´ì¥ ìë™ ì²´í¬</div>
            <div class="feature-meta">í˜„ì¬ ì‚¬ìš© ì¤‘ì¸ Dual íŒ¨ë„ ë²„ì „ íƒ‘ì¬</div>
          </button>

          <button class="feature-card" type="button" data-screen-target="drive">
            <div class="feature-title">ğŸ“ êµ¬ê¸€ ë“œë¼ì´ë¸Œ í´ë” ëª¨ìŒ</div>
            <div class="feature-tagline">ìì£¼ ì“°ëŠ” ë“œë¼ì´ë¸Œ í´ë”ë¥¼ í•œ ë²ˆì— ë³´ê³  ë°”ë¡œ ì´ë™</div>
            <div class="feature-meta">í–¥í›„: ì™¸ë¶€ JSON/ì‹œíŠ¸ë¡œ í´ë” ëª©ë¡ ê´€ë¦¬</div>
          </button>

          <button class="feature-card" type="button" data-screen-target="gpts">
            <div class="feature-title">ğŸ§  GPTs ì„¸ì¼ì¦ˆ ë©˜íŠ¸ ë„ìš°ë¯¸</div>
            <div class="feature-tagline">GPT APIë¡œ ë©˜íŠ¸ ìƒì„± â†’ ìˆ˜ì • â†’ ì €ì¥ê¹Œì§€ í•œ í™”ë©´ì—ì„œ</div>
            <div class="feature-meta">ì§€ê¸ˆì€ í‹€ë§Œ, ì´í›„ OpenAI API ì—°ë™ ì˜ˆì •</div>
          </button>
        </div>
      </div>
    </div>
  </section>

  <!-- ======================= ì¹´í†¡ ì…ì¥ì ì²´í¬ í™”ë©´ (ê¸°ì¡´ A ê¸°ëŠ¥) ======================= -->
  <section id="screen-kakao" class="screen">
    <!-- gear / adminì€ ì´ í™”ë©´ì—ì„œë§Œ ë³´ì´ê²Œ -->
    <button id="settingsBtn" class="gear-btn" title="ì„¤ì •" type="button" aria-label="ê´€ë¦¬ì ì„¤ì • ì—´ê¸°">âš™</button>
    <div id="adminOverlay" class="admin-overlay" aria-hidden="true"></div>
    <aside id="adminDrawer" class="admin-drawer" aria-hidden="true">
      <div class="row" style="justify-content:space-between;align-items:center;margin-bottom:8px">
        <h3 style="margin:0">ì¹´í†¡ ì…ì¥ì Â· ìŠ¤í”„ë ˆë“œì‹œíŠ¸ ì—°ê²°</h3>
        <button id="closeAdmin" class="x-btn" type="button">ë‹«ê¸°</button>
      </div>

      <div class="card" style="margin:0">
        <h4 style="margin:0 0 8px">ìŠ¤í”„ë ˆë“œì‹œíŠ¸ ì—°ê²° ì¶”ê°€</h4>
        <label>í‘œì‹œ ì´ë¦„(ì„ íƒ)</label>
        <input id="admLabel" type="text" placeholder="ì˜ˆ: ë””ë…¸ ì¿ íŒ¡ 3ê¸°" />
        <label style="margin-top:10px">ìŠ¤í”„ë ˆë“œì‹œíŠ¸ ë§í¬(URL)</label>
        <input id="admUrl" type="text" placeholder="https://docs.google.com/spreadsheets/d/..." />
        <label style="margin-top:10px">ì½ì„ ì—´(A~) <span class="hint">ì½ê¸° ì‹œíŠ¸ ì´ë¦„ì—´(ì˜ˆ: C)</span></label>
        <input id="admReadCol" type="text" value="G" />
        <div class="row" style="margin-top:10px">
          <button id="admAdd" class="btn" type="button">ì—°ê²° ì¶”ê°€</button>
          <button id="admClearAll" class="btn" type="button">ì „ì²´ ì‚­ì œ</button>
        </div>
        <div id="admErr" class="err" style="margin-top:8px"></div>
      </div>

      <div class="card" style="margin-top:12px">
        <h4 style="margin:0 0 8px">ë“±ë¡ëœ ìŠ¤í”„ë ˆë“œì‹œíŠ¸</h4>
        <table style="width:100%;border-collapse:collapse">
          <thead><tr><th>ë¼ë²¨</th><th>ì‹œíŠ¸ìˆ˜</th><th>ì½ì„ ì—´</th><th>ì‘ì—…</th></tr></thead>
          <tbody id="admList"><tr><td colspan="4" style="color:#64748b">ì—†ìŒ</td></tr></tbody>
        </table>
        <div class="hint" id="admMeta" style="margin-top:6px"></div>
      </div>
    </aside>

    <header class="topbar">
      <div class="topbar-inner">
        <div class="row" style="gap:10px">
          <div class="topbar-title">ğŸ’¬ ì¹´í†¡ ì…ì¥ì ì²´í¬</div>
          <div class="tri-tabs">
            <button class="tri-tab active" type="button">
              <span>ğŸ“Š ê¸°ë³¸ ì²´í¬</span>
            </button>
            <button class="tri-tab" type="button" disabled>
              <span>ğŸ” (ì¶”ê°€ ê¸°ëŠ¥ ì˜ˆì •)</span>
            </button>
            <button class="tri-tab" type="button" disabled>
              <span>âš™ (ì˜µì…˜ ì˜ˆì •)</span>
            </button>
          </div>
        </div>
        <div class="topbar-nav">
          <button class="btn" type="button" data-screen-target="home">â¬… ëŒ€ì‹œë³´ë“œ</button>
        </div>
      </div>
    </header>

    <div class="wrap">
      <header class="brand" style="margin-top:16px">
        <svg class="brand-logo" viewBox="0 0 90 50" role="img" aria-label="ClassAround">
          <rect width="90" height="50" rx="10" fill="white"/>
          <circle cx="66" cy="10" r="8" fill="#6b8bd6"/>
          <circle cx="80" cy="18" r="5" fill="#ef4444"/>
          <text x="8" y="24" class="logo-text">Class</text>
          <text x="8" y="42" class="logo-text">Around</text>
        </svg>
        <h1>í´ë˜ìŠ¤ì–´ë¼ìš´ë“œ ì¹´ì¹´ì˜¤í†¡ ì…ì¥ì ì²´í¬ë´‡</h1>
      </header>

      <!-- ë¡œê·¸ì¸ ìƒíƒœ ê°„ë‹¨ í‘œì‹œ (ì½ê¸°ë§Œ) -->
      <div class="card">
        <div id="kakaoAuthInfo" class="hint">Google ë¡œê·¸ì¸ í›„ ì‚¬ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤. (ë¡œê·¸ì¸ ìƒíƒœëŠ” ìƒë‹¨ ëŒ€ì‹œë³´ë“œì—ì„œ ê´€ë¦¬)</div>
      </div>

      <div class="panels">
        <!-- Panel A -->
        <section>
          <div class="card">
            <div class="controls">
              <div class="controls-line">
                <div>
                  <label>ì‹œíŠ¸ ì„ íƒ</label>
                  <select id="sheetPackSelectA"></select>
                </div>
                <div>
                  <label>ì½ê¸° ì‹œíŠ¸ ì„ íƒ</label>
                  <select id="readSheetSelectA"></select>
                </div>
                <div>
                  <label style="visibility:hidden">refresh</label>
                  <button id="refreshMetaA" class="icon-btn" type="button">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M3 12a9 9 0 1 0 3-6.7"/><polyline points="3 4 3 10 9 10"/>
                    </svg>
                  </button>
                </div>
              </div>

              <div class="hint" style="margin-top:-4px">A íŒ¨ë„</div>

              <label style="margin-top:8px"></label>
              <div class="dirline">
                <button id="dirPickA" class="btn" type="button">í´ë”</button>
                <div class="dirlabel" id="dirNameA"></div>
                <select id="dirFileSelectA"></select>
                <button id="dirRefreshA" class="icon-btn" type="button">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M3 12a9 9 0 1 0 3-6.7"/><polyline points="3 4 3 10 9 10"/>
                  </svg>
                </button>
              </div>
            </div>

            <div class="row" style="margin-top:10px">
              <label class="row" style="gap:6px;align-items:center">
                <input id="previewOnlyA" type="checkbox" />
                <span class="hint">ì—´ëŒìš©</span>
              </label>
              <button id="runBtnA" class="btn acc" type="button">ì‹¤í–‰</button>
              <button id="demoBtnA" class="btn" type="button">ë°ëª¨</button>
              <span id="pillsAA" class="row"></span>
            </div>
            <div id="errA" class="err" style="margin-top:8px"></div>
          </div>
          <div id="resultsA" style="display:grid;gap:16px"></div>
        </section>

        <!-- Panel B -->
        <section>
          <div class="card">
            <div class="controls">
              <div class="controls-line">
                <div>
                  <label>ì‹œíŠ¸ ì„ íƒ</label>
                  <select id="sheetPackSelectB"></select>
                </div>
                <div>
                  <label>ì½ê¸° ì‹œíŠ¸ ì„ íƒ</label>
                  <select id="readSheetSelectB"></select>
                </div>
                <div>
                  <label style="visibility:hidden">refresh</label>
                  <button id="refreshMetaB" class="icon-btn" type="button">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M3 12a9 9 0 1 0 3-6.7"/><polyline points="3 4 3 10 9 10"/>
                    </svg>
                  </button>
                </div>
              </div>

              <div class="hint" style="margin-top:-4px">B íŒ¨ë„</div>

              <label style="margin-top:8px"></label>
              <div class="dirline">
                <button id="dirPickB" class="btn" type="button">í´ë”</button>
                <div class="dirlabel" id="dirNameB"></div>
                <select id="dirFileSelectB"></select>
                <button id="dirRefreshB" class="icon-btn" type="button">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M3 12a9 9 0 1 0 3-6.7"/><polyline points="3 4 3 10 9 10"/>
                  </svg>
                </button>
              </div>
            </div>

            <div class="row" style="margin-top:10px">
              <label class="row" style="gap:6px;align-items:center">
                <input id="previewOnlyB" type="checkbox" />
                <span class="hint">ì—´ëŒìš©</span>
              </label>
              <button id="runBtnB" class="btn acc" type="button">ì‹¤í–‰</button>
              <button id="demoBtnB" class="btn" type="button">ë°ëª¨</button>
              <span id="pillsBB" class="row"></span>
            </div>
            <div id="errB" class="err" style="margin-top:8px"></div>
          </div>
          <div id="resultsB" style="display:grid;gap:16px"></div>
        </section>
      </div>
    </div>
  </section>

  <!-- ======================= ìˆ˜ê°•ìƒ ëª…ë‹¨ ì—…ë°ì´íŠ¸ í™”ë©´ (UI í‹€) ======================= -->
  <section id="screen-roster" class="screen">
    <header class="topbar">
      <div class="topbar-inner">
        <div class="row" style="gap:10px">
          <div class="topbar-title">ğŸ“‹ ìˆ˜ê°•ìƒ ëª…ë‹¨ ì—…ë°ì´íŠ¸</div>
          <div class="tri-tabs">
            <button class="tri-tab active" type="button">
              <span>CSV â†’ ì‹œíŠ¸</span>
            </button>
            <button class="tri-tab" type="button" disabled>
              <span>ì¤‘ë³µ/í™˜ë¶ˆ ì •ë¦¬(ì˜ˆì •)</span>
            </button>
            <button class="tri-tab" type="button" disabled>
              <span>ê¸°ìˆ˜ë³„ ê´€ë¦¬(ì˜ˆì •)</span>
            </button>
          </div>
        </div>
        <div class="topbar-nav">
          <button class="btn" type="button" data-screen-target="home">â¬… ëŒ€ì‹œë³´ë“œ</button>
        </div>
      </div>
    </header>

    <div class="wrap">
      <div class="card" style="margin-top:16px">
        <h2 style="margin-top:0;font-size:18px">ê²°ì œì CSV â†’ ìˆ˜ê°•ìƒ ëª…ë‹¨ ì‹œíŠ¸ ì •ë¦¬ (v0.1 í‹€)</h2>
        <p class="hint" style="margin-bottom:12px">
          ì—¬ê¸°ì—ëŠ” ë‚˜ì¤‘ì— â€œê²°ì œì CSV íŒŒì¼ ì—…ë¡œë“œ â†’ ì„¤ì •í•œ ì‹œíŠ¸ ì»¬ëŸ¼ìœ¼ë¡œ ìë™ ë§¤í•‘â€ ê¸°ëŠ¥ì„ ë„£ì„ê±°ì•¼.<br/>
          ì§€ê¸ˆì€ UI í‹€ë§Œ ì¡ì•„ë‘” ìƒíƒœë¼, ë‹¤ìŒì— ë„¤ê°€ ì“°ëŠ” ì‹¤ì œ ì‹œíŠ¸ êµ¬ì¡°/í—¤ë” ì•Œë ¤ì£¼ë©´ ë¡œì§ ì±„ì›Œë„£ì.
        </p>

        <div class="row" style="margin-bottom:12px">
          <label style="flex:1">
            <span class="hint">ëŒ€ìƒ ìŠ¤í”„ë ˆë“œì‹œíŠ¸ URL</span>
            <input id="rosterSheetUrl" type="text" style="width:100%;height:40px;border-radius:12px;border:1px solid var(--line);padding:8px 10px" placeholder="https://docs.google.com/spreadsheets/d/...">
          </label>
          <label style="width:200px">
            <span class="hint">ì‘ì„± ì‹œíŠ¸ ì´ë¦„</span>
            <input id="rosterTargetSheet" type="text" style="width:100%;height:40px;border-radius:12px;border:1px solid var(--line);padding:8px 10px" placeholder="ì˜ˆ: ìˆ˜ê°•ìƒ ëª…ë‹¨">
          </label>
        </div>

        <div class="row" style="margin-bottom:12px">
          <label>
            <span class="hint">CSV / TXT ì—…ë¡œë“œ (ì°¨í›„ êµ¬í˜„: File Picker + Drive)</span>
          </label>
        </div>

        <div class="row" style="margin-bottom:12px">
          <button class="btn acc" type="button" disabled>ğŸš§ ìë™ ì •ë¦¬ ì‹¤í–‰ (ì¶”í›„ êµ¬í˜„)</button>
          <span class="hint">ì§€ê¸ˆì€ ë¹„í™œì„±í™”. A ê¸°ëŠ¥ ì™„ì„± í›„, ì´ìª½ì— ë¡œì§ ë¶™ì´ì.</span>
        </div>
      </div>
    </div>
  </section>

  <!-- ======================= êµ¬ê¸€ ë“œë¼ì´ë¸Œ í´ë” ëª©ë¡ í™”ë©´ (UI í‹€) ======================= -->
  <section id="screen-drive" class="screen">
    <header class="topbar">
      <div class="topbar-inner">
        <div class="row" style="gap:10px">
          <div class="topbar-title">ğŸ“ ìì£¼ ì“°ëŠ” êµ¬ê¸€ ë“œë¼ì´ë¸Œ í´ë” ëª¨ìŒ</div>
        </div>
        <div class="topbar-nav">
          <button class="btn" type="button" data-screen-target="home">â¬… ëŒ€ì‹œë³´ë“œ</button>
        </div>
      </div>
    </header>

    <div class="wrap">
      <div class="card" style="margin-top:16px">
        <h2 style="margin-top:0;font-size:18px">í´ë” ë°”ë¡œê°€ê¸° (ì½”ë“œ ë‚´ ìƒìˆ˜ë¡œ ë“±ë¡)</h2>
        <p class="hint" style="margin-bottom:12px">
          ì´ í™”ë©´ì€ â€œë§í¬ ë„£ì–´ì„œ ì¶”ê°€í•˜ë©´ í´ë” ì•„ì´ì½˜ìœ¼ë¡œ ì €ì¥ & í´ë¦­ ì‹œ ì´ë™â€ ê¸°ëŠ¥ìš© í‹€ì´ê³ ,<br/>
          ì§€ê¸ˆì€ ìƒ˜í”Œ ìƒìˆ˜ ëª©ë¡ë§Œ ë„£ì–´ë‘˜ê²Œ. ë‚˜ì¤‘ì— ì™¸ë¶€ JSON / ì‹œíŠ¸ ì—°ë™ë„ ê°€ëŠ¥.
        </p>

        <div id="driveShortcutList" style="display:grid;gap:10px"></div>
      </div>
    </div>
  </section>

  <!-- ======================= GPTs ì„¸ì¼ì¦ˆ ë©˜íŠ¸ í™”ë©´ (UI í‹€) ======================= -->
  <section id="screen-gpts" class="screen">
    <header class="topbar">
      <div class="topbar-inner">
        <div class="row" style="gap:10px">
          <div class="topbar-title">ğŸ§  GPTs ì„¸ì¼ì¦ˆ ë©˜íŠ¸ ë„ìš°ë¯¸</div>
          <div class="tri-tabs">
            <button class="tri-tab active" type="button">
              <span>ë©˜íŠ¸ ìƒì„±</span>
            </button>
            <button class="tri-tab" type="button" disabled>
              <span>ë©˜íŠ¸ ì •ë¦¬/íƒœê¹…(ì˜ˆì •)</span>
            </button>
            <button class="tri-tab" type="button" disabled>
              <span>ì‹œíŠ¸ ì €ì¥(ì˜ˆì •)</span>
            </button>
          </div>
        </div>
        <div class="topbar-nav">
          <button class="btn" type="button" data-screen-target="home">â¬… ëŒ€ì‹œë³´ë“œ</button>
        </div>
      </div>
    </header>

    <div class="wrap">
      <div class="card" style="margin-top:16px">
        <h2 style="margin-top:0;font-size:18px">GPTs ê¸°ë°˜ ì„¸ì¼ì¦ˆ ë©˜íŠ¸ ìƒì„± (UI í‹€)</h2>
        <p class="hint" style="margin-bottom:12px">
          ì—¬ê¸°ì—ëŠ” â€œGPTs / OpenAI API í‚¤ë¥¼ ì½”ë“œ ë‚´ë¶€ì—ì„œ í˜¸ì¶œ â†’ ë©˜íŠ¸ ìƒì„± â†’ ë©˜íŠ¸ë³„ë¡œ ë”°ë¡œ ì €ì¥/ìˆ˜ì •â€ ê¸°ëŠ¥ì„ ë„£ì„ê±°ì•¼.<br/>
          ì§€ê¸ˆì€ ì…ë ¥/ì¶œë ¥ ì˜ì—­ë§Œ ì¡ì•„ë‘ê³ , ë„¤ê°€ ì›í•˜ëŠ” í”„ë¡¬í”„íŠ¸/í•„ë“œ êµ¬ì¡° ë“£ê³  ë¡œì§ì€ ë‹¤ìŒ ë‹¨ê³„ì—ì„œ ì±„ìš°ì.
        </p>

        <div class="row" style="margin-bottom:8px">
          <label style="flex:1">
            <span class="hint">íƒ€ê¹ƒ / ìƒí™© ì„¤ëª…</span>
            <textarea id="gptsPrompt" rows="3" style="width:100%;border-radius:12px;border:1px solid var(--line);padding:8px 10px;resize:vertical" placeholder="ì˜ˆ: 40~50ëŒ€ ì£¼ë¶€ ëŒ€ìƒ, ë¬´ë£Œê°•ì˜ ì‹œì‘ ë©˜íŠ¸ 3ê°œ + ê²°ì œ ìœ ë„ ë©˜íŠ¸ 2ê°œ"></textarea>
          </label>
        </div>

        <div class="row" style="margin-bottom:8px">
          <button class="btn acc" type="button" disabled>ğŸš§ GPTë¡œ ë©˜íŠ¸ ìƒì„± (ì¶”í›„ API ì—°ë™)</button>
          <span class="hint">ì§€ê¸ˆì€ ë²„íŠ¼ë§Œ. API í‚¤/í”„ë¡¬í”„íŠ¸ êµ¬ì¡° ì •í•´ì§€ë©´ ì—°ê²°í•´ì¤„ê²Œ.</span>
        </div>

        <div>
          <label class="hint">ìƒì„±ëœ ë©˜íŠ¸ ëª©ë¡ (ìƒ˜í”Œ ë”ë¯¸)</label>
          <div id="gptsOutput" style="border-radius:12px;border:1px solid var(--line);padding:10px;background:#f8fafc;min-height:80px;font-size:13px">
            - ì—¬ê¸°ì—ëŠ” ìƒì„±ëœ ë©˜íŠ¸ê°€ ì¹´ë“œ í˜•íƒœë¡œ ìŒ“ì´ê³ , ê°ê° í¸ì§‘/ë³µì‚¬/ì €ì¥ ë²„íŠ¼ì´ ë¶™ì„ ì˜ˆì •ì…ë‹ˆë‹¤.
          </div>
        </div>
      </div>
    </div>
  </section>

</div> <!-- #app -->

<script>
/* ===== ê³µí†µ DOM ìœ í‹¸ ===== */
const $$=id=>document.getElementById(id);
const SCREENS=['login','home','kakao','roster','drive','gpts'];

function showScreen(name){
  SCREENS.forEach(n=>{
    const el = $$('screen-'+n);
    if(!el) return;
    el.classList.toggle('active', n===name);
  });
}

/* ===== ë¡œê·¸ì¸ / OAuth ===== */
let accessToken=null,tokenClient=null;

/* âœ… ì—¬ê¸°ì— ë³¸ì¸ OAuth í´ë¼ì´ì–¸íŠ¸ ID ë„£ê¸° */
const CLIENT_ID="18228268359-iifm4ck3j9kqj74eh1p90tco1k2mbpi0.apps.googleusercontent.com";

function txt(id,v){const el=$$(id);if(el)el.textContent=v||'';}

function initAuth(){
  try{
    if(!window.google?.accounts?.oauth2){txt('authErr','GIS ë¡œë“œ ì‹¤íŒ¨');return;}
    tokenClient=google.accounts.oauth2.initTokenClient({
      client_id:CLIENT_ID,
      scope:'https://www.googleapis.com/auth/spreadsheets https://www.googleapis.com/auth/drive.readonly',
      prompt:'',
      callback:res=>{
        accessToken=res.access_token;
        txt('authState','ë¡œê·¸ì¸ ì™„ë£Œ');
        txt('homeAuthState','ë¡œê·¸ì¸ ì™„ë£Œ');
        const ka=$$('kakaoAuthInfo'); if(ka) ka.textContent='ë¡œê·¸ì¸ ì™„ë£Œ Â· ìŠ¤í”„ë ˆë“œì‹œíŠ¸ / ë“œë¼ì´ë¸Œ ì ‘ê·¼ ê°€ëŠ¥';
        txt('authErr','');
        showScreen('home');
      },
      error_callback:err=>{
        txt('authErr','OAuth ì˜¤ë¥˜: '+(err?.error||err?.type||JSON.stringify(err)));
      }
    });
  }catch(e){
    txt('authErr','OAuth ì´ˆê¸°í™” ì˜¤ë¥˜');
    console.error(e);
  }
}
function requestAccess(){if(!tokenClient){txt('authErr','OAuth ì´ˆê¸°í™” ì‹¤íŒ¨');return;}tokenClient.requestAccessToken({prompt:'consent'});}
function revokeAccess(){
  if(accessToken){
    google.accounts.oauth2.revoke(accessToken,()=>{
      accessToken=null;
      txt('authState','ë¯¸ë¡œê·¸ì¸');
      txt('homeAuthState','ë¡œê·¸ì•„ì›ƒë¨');
      const ka=$$('kakaoAuthInfo'); if(ka) ka.textContent='Google ë¡œê·¸ì¸ í›„ ì‚¬ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.';
      showScreen('login');
    });
  }else{
    showScreen('login');
  }
}
function requireAuth(){if(!accessToken)throw new Error('ë¨¼ì € Google ë¡œê·¸ì¸í•˜ì„¸ìš”.');}

/* ===== Google API ê³µí†µ ===== */
async function gFetch(url,init){
  requireAuth();
  const res=await fetch(url,{
    ...(init||{}),
    headers:{
      ...(init&&init.headers||{}),
      Authorization:'Bearer '+accessToken,
      'Content-Type':'application/json'
    }
  });
  if(!res.ok)throw new Error(await res.text());
  return res.json();
}
async function listSheets(spreadsheetId){
  const url=`https://sheets.googleapis.com/v4/spreadsheets/${encodeURIComponent(spreadsheetId)}?fields=sheets(properties(title))`;
  const data=await gFetch(url);
  return (data.sheets||[]).map(s=>s.properties.title);
}
async function getRange(spreadsheetId,rangeA1){
  const url=`https://sheets.googleapis.com/v4/spreadsheets/${encodeURIComponent(spreadsheetId)}/values/${encodeURIComponent(rangeA1)}`;
  return await gFetch(url);
}
async function batchUpdateValues(spreadsheetId,dataRanges){
  const url=`https://sheets.googleapis.com/v4/spreadsheets/${encodeURIComponent(spreadsheetId)}/values:batchUpdate`;
  return await gFetch(url,{method:'POST',body:JSON.stringify({valueInputOption:'USER_ENTERED',data:dataRanges})});
}

/* ===== ë“œë¼ì´ë¸Œ í´ë” / íŒŒì¼ (ì…ì¥ì ì²´í¬ìš©) ===== */
const PANEL_SUFFIXES=['A','B'];
const byPanel=(base,s)=>$$(base+s);
const val=(id,sfx)=>{const el=sfx?byPanel(id,sfx):$$(id);return el?el.value:'';};

function digitsOnly(s){return String(s||'').replace(/[^\d]/g,'');}
function last4Digits(s){const d=digitsOnly(s);return d.slice(-4);}

function normalizeName(n){
  let s=String(n||'').trim();
  s=s.replace(/[\s]*[\(\[\{ï¼ˆã€][^)\]\}ï¼‰ã€‘]*[\)\]\}ï¼‰ã€‘]\s*$/,'');
  s=s.replace(/[/_\-\s]+$/,'');
  s=s.replace(/\s+/g,' ');
  return s;
}
const earlierId=(a,b)=>{const ai=parseInt(a,10),bi=parseInt(b,10);if(!Number.isNaN(ai)&&!Number.isNaN(bi))return ai<=bi?a:b;return(String(a)<=String(b))?a:b;};

(function(){
  const pushErr=(msg,src,l,c,e)=>{
    const details=(e&&e.stack)?'\n'+e.stack:'';
    PANEL_SUFFIXES.forEach(s=>{
      const el=$$('#err'+s);
      if(el)el.textContent='ì˜¤ë¥˜: '+msg+(src?`\n${src}:${l}:${c}`:'')+details;
    });
  };
  window.addEventListener('error',e=>pushErr(e.message,e.filename,e.lineno,e.colno,e.error));
  window.addEventListener('unhandledrejection',e=>{
    const r=e.reason||{};
    pushErr(r.message||String(r),'',0,0,r);
  });
})();

/* ===== ì…ì¥ì ì²´í¬ìš© ìƒìˆ˜ ===== */
const READ_START_ROW=2;
const WRITE_START_ROW=2;
const FIXED_WRITE_SHEET='ê³µìœ ìš© ì‹œíŠ¸';

/* ===== ê´€ë¦¬ì ì €ì¥ ===== */
const PACKS_KEY='ca_gsapi_sources_v12';
const loadPacks=()=>{try{return JSON.parse(localStorage.getItem(PACKS_KEY)||'[]');}catch(e){return[];}}; 
const savePacks=ps=>localStorage.setItem(PACKS_KEY,JSON.stringify(ps));
const addPack=p=>{const a=loadPacks();a.push(p);savePacks(a);};
const removePack=id=>savePacks(loadPacks().filter(p=>p.id!==id));
const clearPacks=()=>localStorage.removeItem(PACKS_KEY);

let admBusy=false;
async function admAdd(){
  if(admBusy)return;
  admBusy=true;
  try{
    txt('admErr','');
    const label=($$('admLabel').value.trim()||'ìŠ¤í”„ë ˆë“œì‹œíŠ¸');
    const urlOrId=$$('admUrl').value.trim();
    const m=urlOrId.match(/spreadsheets\/d\/([a-zA-Z0-9-_]+)/);
    const sheetId=m?m[1]:urlOrId;
    const readCol=($$('admReadCol').value.trim()||'C').toUpperCase();
    if(!sheetId)throw new Error('ìŠ¤í”„ë ˆë“œì‹œíŠ¸ ë§í¬/IDë¥¼ ì…ë ¥í•˜ì„¸ìš”.');
    const titles=await listSheets(sheetId);
    const pack={id:`${Date.now()}_${Math.random().toString(36).slice(2,7)}`,label,sheetId,readCol,sheets:titles};
    addPack(pack);
    ['admLabel','admUrl'].forEach(id=>{const el=$$(id);if(el)el.value='';});
    const rc=$$('admReadCol');if(rc)rc.value='C';
    renderAdmList();populatePacks('A');populatePacks('B');
    alert('ì—°ê²° ì™„ë£Œ! ê° íŒ¨ë„ì—ì„œ ì„ íƒí•˜ì„¸ìš”.');
  }catch(e){txt('admErr',e.message);}
  finally{admBusy=false;}
}
function renderAdmList(){
  const list=loadPacks();const tb=$$('admList');if(!tb)return;tb.innerHTML='';
  if(!list.length){tb.innerHTML='<tr><td colspan="4" style="color:#64748b">ì—†ìŒ</td></tr>';txt('admMeta','');return;}
  list.forEach(p=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${p.label}</td><td>${p.sheets?.length||0}</td><td>${p.readCol}</td><td><button class="btn" data-del="${p.id}" type="button">ì‚­ì œ</button></td>`;
    tb.appendChild(tr);
  });
  tb.querySelectorAll('button[data-del]').forEach(b=>b.addEventListener('click',e=>{
    removePack(e.target.getAttribute('data-del'));renderAdmList();populatePacks('A');populatePacks('B');
  }));
  txt('admMeta',`ì´ ${list.length}ê°œ ì—°ê²° Â· ${new Date().toLocaleString()}`);
}

/* ===== ì‹œíŠ¸ ì…€ë ‰íŠ¸ ===== */
function populatePacks(sfx){
  const packs=loadPacks();const sel=byPanel('sheetPackSelect',sfx);if(!sel)return;sel.innerHTML='';
  const readSel=byPanel('readSheetSelect',sfx);
  if(!packs.length){
    sel.appendChild(new Option('(ìŠ¤í”„ë ˆë“œì‹œíŠ¸ ì—°ê²°)',''));
    if(readSel)readSel.innerHTML='';
    return;
  }
  sel.appendChild(new Option('ìŠ¤í”„ë ˆë“œì‹œíŠ¸ ì„ íƒ',''));
  packs.forEach(p=>sel.appendChild(new Option(p.label,p.id)));
  const prev=sessionStorage.getItem('ca_prev_pack_'+sfx);
  if(prev){const o=[...sel.options].find(x=>x.value===prev);if(o)o.selected=true;}
  onPackChanged(sfx);
}
async function refreshMeta(sfx){
  try{
    const sel=byPanel('sheetPackSelect',sfx);if(!sel)return;
    const id=sel.value;if(!id)return;
    const packs=loadPacks();const idx=packs.findIndex(p=>p.id===id);if(idx<0)return;
    const titles=await listSheets(packs[idx].sheetId);
    packs[idx].sheets=titles;savePacks(packs);onPackChanged(sfx);
  }catch(e){const el=$$('err'+sfx);if(el)el.textContent='ì‹œíŠ¸ ëª©ë¡ ê°±ì‹  ì‹¤íŒ¨: '+e.message;}
}
function onPackChanged(sfx){
  const sel=byPanel('sheetPackSelect',sfx);if(!sel)return;
  const id=sel.value;sessionStorage.setItem('ca_prev_pack_'+sfx,id||'');
  const packs=loadPacks();const p=packs.find(x=>x.id===id);
  const readSel=byPanel('readSheetSelect',sfx);
  if(readSel)readSel.innerHTML='';
  if(!p)return;
  if(readSel)readSel.appendChild(new Option('ì½ê¸° ì‹œíŠ¸ ì„ íƒ',''));
  (p.sheets||[]).forEach(t=>{if(readSel)readSel.appendChild(new Option(t,t));});
}

/* ===== ë“œë¼ì´ë¸Œ í´ë” / íŒŒì¼ (txt/csv) ===== */
let driveFolderId={A:null,B:null};
let driveFiles={A:[],B:[]};

function extractDriveFolderId(input){
  const s=String(input||'').trim();if(!s)return'';
  const m=s.match(/folders\/([a-zA-Z0-9_-]+)/);
  if(m)return m[1];
  return s;
}
async function getDriveFolderName(folderId){
  requireAuth();
  const url=`https://www.googleapis.com/drive/v3/files/${encodeURIComponent(folderId)}?fields=name`;
  const res=await fetch(url,{headers:{Authorization:'Bearer '+accessToken}});
  if(!res.ok)throw new Error(await res.text());
  const data=await res.json();
  return data.name||folderId;
}
async function pickDriveFolder(sfx){
  try{
    const input=prompt('êµ¬ê¸€ ë“œë¼ì´ë¸Œ í´ë” URL ë˜ëŠ” IDë¥¼ ì…ë ¥í•˜ì„¸ìš”.','');
    if(!input)return;
    const id=extractDriveFolderId(input);
    if(!id)throw new Error('í´ë” IDë¥¼ ì¸ì‹í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
    driveFolderId[sfx]=id;
    await refreshDriveList(sfx);
  }catch(e){
    alert('ë“œë¼ì´ë¸Œ í´ë” ì„¤ì • ì‹¤íŒ¨: '+e.message);
    console.error(e);
  }
}
async function listDriveTxtFiles(folderId){
  requireAuth();
  const q=`'${folderId}' in parents and (mimeType='text/plain' or mimeType='text/csv') and trashed=false`;
  const url=`https://www.googleapis.com/drive/v3/files?q=${encodeURIComponent(q)}&fields=files(id,name,modifiedTime,size)&orderBy=modifiedTime desc&pageSize=1000`;
  const res=await fetch(url,{headers:{Authorization:'Bearer '+accessToken}});
  if(!res.ok)throw new Error(await res.text());
  const data=await res.json();
  return data.files||[];
}
async function refreshDriveList(sfx){
  const sel=byPanel('dirFileSelect',sfx);
  const nameSpan=byPanel('dirName',sfx);
  driveFiles[sfx]=[];
  if(sel)sel.innerHTML='';
  const folderId=driveFolderId[sfx];
  if(!folderId){
    if(nameSpan){nameSpan.textContent='';nameSpan.classList.remove('connected');}
    if(sel)sel.appendChild(new Option('(ë“œë¼ì´ë¸Œ í´ë” ì—°ê²°)',''));
    return;
  }
  try{
    const files=await listDriveTxtFiles(folderId);
    driveFiles[sfx]=files.map(f=>({id:f.id,name:f.name,size:f.size||0,mtime:f.modifiedTime?Date.parse(f.modifiedTime):0}));
    if(nameSpan){
      let displayName=folderId;
      try{displayName=await getDriveFolderName(folderId);}catch(e){console.warn('í´ë” ì´ë¦„ ì¡°íšŒ ì‹¤íŒ¨',e);}
      nameSpan.textContent=displayName;
      nameSpan.classList.add('connected');
    }
    if(sel){
      sel.appendChild(new Option('í´ë” ë‚´ íŒŒì¼ ì„ íƒ',''));
      driveFiles[sfx].forEach((f,idx)=>sel.appendChild(new Option(f.name,String(idx))));
    }
  }catch(e){
    if(nameSpan){nameSpan.textContent='';nameSpan.classList.remove('connected');}
    if(sel)sel.appendChild(new Option('(ë“œë¼ì´ë¸Œ ì ‘ê·¼ ì˜¤ë¥˜)',''));
    console.error(e);
    alert('ë“œë¼ì´ë¸Œ íŒŒì¼ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤: '+e.message);
  }
}

/* txt / csv ì½ê¸° : csvëŠ” Cì—´ë§Œ */
async function readSelectedTxt(sfx){
  const idxStr=val('dirFileSelect',sfx);
  if(!idxStr)throw new Error('í´ë” ë‚´ íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”.');
  const info=driveFiles[sfx][Number(idxStr)];
  if(!info)throw new Error('ì„ íƒí•œ íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
  requireAuth();
  const url=`https://www.googleapis.com/drive/v3/files/${encodeURIComponent(info.id)}?alt=media`;
  const res=await fetch(url,{headers:{Authorization:'Bearer '+accessToken}});
  if(!res.ok)throw new Error(await res.text());
  const raw=await res.text();
  if(info.name.toLowerCase().endsWith('.csv')){
    const lines=raw.split(/\r?\n/);
    const colC=[];
    for(let i=0;i<lines.length;i++){
      const line=lines[i];
      if(!line.trim())continue;
      const cells=line.split(',');
      if(cells.length<3)continue;
      let cell=cells[2].trim();
      if(cell.startsWith('"')&&cell.endsWith('"'))cell=cell.slice(1,-1);
      if(cell)colC.push(cell);
    }
    return colC.join('\n');
  }
  return raw;
}

/* ===== ì¹´í†¡ íŒŒì‹± ===== */
const JOIN_PAT=/(.*?)ë‹˜ì´\s*(ì…ì¥í•˜ì…¨ìŠµë‹ˆë‹¤|ë“¤ì–´ì™”ìŠµë‹ˆë‹¤|ì…ì¥í–ˆìŠµë‹ˆë‹¤|ë“¤ì–´ì˜¤ì…¨ìŠµë‹ˆë‹¤)[\s\.\!]*$/;
const LEAVE_PAT=/(.*?)ë‹˜ì´\s*(í‡´ì¥í•˜ì…¨ìŠµë‹ˆë‹¤|ë‚˜ê°”ìŠµë‹ˆë‹¤|í‡´ì¥í–ˆìŠµë‹ˆë‹¤|ë‚˜ê°€ì…¨ìŠµë‹ˆë‹¤)[\s\.\!]*$/;
const KICK_PAT=/(.*?)ë‹˜ì„\s*(ë‚´ë³´ëƒˆìŠµë‹ˆë‹¤|ê°•í‡´í–ˆìŠµë‹ˆë‹¤|ì¶”ë°©í–ˆìŠµë‹ˆë‹¤)[\s\.\!]*$/;

function splitNickname(nick){
  const raw=String(nick||'').trim();
  if(!raw)return null;
  const idx=raw.search(/\d/);
  let namePart=idx>=0?raw.slice(0,idx):raw;
  let name=namePart.replace(/[/_\-\s]+$/,'');
  name=normalizeName(name);
  if(!name)return{name:raw,digits:null};
  const digitsAll=raw.replace(/[^\d]/g,'');
  const digits=digitsAll.length>=4?digitsAll.slice(-4):null;
  return{name,digits};
}
function parseChat(text){
  const lines=text.split(/\r?\n/);
  const events=[];let joinedCount=0,leftCount=0;
  for(const raw of lines){
    const line=raw.trim();if(!line)continue;
    let m=line.match(JOIN_PAT);if(m){events.push({type:'join',nick:m[1].trim(),raw:line});joinedCount++;continue;}
    m=line.match(LEAVE_PAT);if(m){events.push({type:'leave',nick:m[1].trim(),raw:line});leftCount++;continue;}
    m=line.match(KICK_PAT);if(m){events.push({type:'leave',nick:m[1].trim(),raw:line});leftCount++;continue;}
  }
  return{events,joinedCount,leftCount};
}

/* ===== ì‹¤í–‰ ===== */
async function runMain(sfx){
  try{
    const errEl=$$('err'+sfx);if(errEl)errEl.textContent='';
    const resultsEl=$$('results'+sfx);if(resultsEl)resultsEl.innerHTML='';
    const previewOnly=byPanel('previewOnly',sfx)?.checked;

    const chatText=await readSelectedTxt(sfx);
    const packSel=byPanel('sheetPackSelect',sfx);if(!packSel||!packSel.value)throw new Error('ìŠ¤í”„ë ˆë“œì‹œíŠ¸ë¥¼ ì„ íƒí•˜ì„¸ìš”.');
    const readSheet=val('readSheetSelect',sfx);if(!readSheet)throw new Error('ì½ê¸° ì‹œíŠ¸ë¥¼ ì„ íƒí•˜ì„¸ìš”.');
    const writeSheet=FIXED_WRITE_SHEET;

    const packs=loadPacks();const pack=packs.find(x=>x.id===packSel.value);if(!pack)throw new Error('ì—°ê²° ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
    const sheetId=pack.sheetId;const readCol=pack.readCol||'C';

    const {events,joinedCount,leftCount}=parseChat(chatText);

    const NAME_ONLY_SENTINEL='__NAMEONLY__';
    const activeDigitsByName=new Map();
    const leftFinalDigitsByName=new Map();
    const nameOnlyJoin=new Set();
    const ensure=(map,key)=>{if(!map.has(key))map.set(key,new Set());return map.get(key);};

    for(const ev of events){
      const s=splitNickname(ev.nick);
      if(!s)continue;
      const nN=s.name;
      if(ev.type==='join'){
        ensure(activeDigitsByName,nN).add(s.digits||NAME_ONLY_SENTINEL);
        if(leftFinalDigitsByName.has(nN)){
          const L=leftFinalDigitsByName.get(nN);
          L.delete(s.digits||NAME_ONLY_SENTINEL);
          if(L.size===0)leftFinalDigitsByName.delete(nN);
        }
        if(!s.digits)nameOnlyJoin.add(nN);
      }else{
        const A=ensure(activeDigitsByName,nN);
        if(s.digits)A.delete(s.digits);
        else if(A.size===1&&A.has(NAME_ONLY_SENTINEL))A.delete(NAME_ONLY_SENTINEL);
        ensure(leftFinalDigitsByName,nN).add(s.digits||NAME_ONLY_SENTINEL);
      }
    }

    const readNames=await getRange(sheetId,`${readSheet}!${readCol}${READ_START_ROW}:${readCol}`);
    const readRows=readNames.values||[];
    const rosterNames=[];const rosterNamesN=[];const rosterSetN=new Set();
    for(let i=0;i<readRows.length;i++){
      const nm=String(readRows[i]?.[0]??'').trim();
      if(!nm)continue;
      const nN=normalizeName(nm);
      rosterNames.push(nm);
      rosterNamesN.push(nN);
      rosterSetN.add(nN);
    }

    const wAtoE=await getRange(sheetId,`${writeSheet}!A${WRITE_START_ROW}:E`);
    const wRowsAE=wAtoE.values||[];
    const earliestByKey=new Map();
    const earliestByName=new Map();
    for(const r of wRowsAE){
      const id=(r[0]??'').toString().trim();
      const nameRaw=(r[3]??'').toString().trim();
      const phoneRaw=(r[4]??'').toString().trim();
      if(!id||!nameRaw)continue;
      const nN=normalizeName(nameRaw);
      const p4=last4Digits(phoneRaw);
      if(p4){
        const key=nN+'|'+p4;
        if(!earliestByKey.has(key))earliestByKey.set(key,{id,phoneFull:phoneRaw,phone4:p4});
        else{
          const cur=earliestByKey.get(key);
          earliestByKey.set(key,earlierId(cur.id,id)===cur.id?cur:{id,phoneFull:phoneRaw,phone4:p4});
        }
      }
      if(!earliestByName.has(nN))earliestByName.set(nN,{id,phoneFull:phoneRaw,phone4:p4});
      else{
        const cur=earliestByName.get(nN);
        earliestByName.set(nN,earlierId(cur.id,id)===cur.id?cur:{id,phoneFull:phoneRaw,phone4:p4});
      }
    }

    const isAttendingNameN=nN=>{
      const set=activeDigitsByName.get(nN);
      return(set&&set.size>0)||nameOnlyJoin.has(nN);
    };
    const attendingSetN=new Set([...rosterSetN].filter(nN=>isAttendingNameN(nN)));

    const report=[];
    for(let i=0;i<rosterNames.length;i++){
      const nm=rosterNames[i];
      const nN=rosterNamesN[i];
      const phoneFull=earliestByName.get(nN)?.phoneFull||'';
      const set=activeDigitsByName.get(nN)||new Set();
      const any4=[...set].find(x=>x!==NAME_ONLY_SENTINEL)||'';
      const matchedId=
        any4&&earliestByKey.get(nN+'|'+any4)?earliestByKey.get(nN+'|'+any4).id:
        earliestByName.get(nN)?.id||'';
      const notes=(isAttendingNameN(nN)&&!any4)?'(ë²ˆí˜¸ì—†ìŒ)':'';
      const status=attendingSetN.has(nN)?'ì…ì¥':'ë¯¸ì…ì¥';
      const rosterNo=matchedId;
      report.push([rosterNo,nm,phoneFull,status,any4?`${nm}/${any4}`:(status==='ì…ì¥'?nm:''),notes]);
    }

    const extra=[];
    [...activeDigitsByName.entries()].sort(([a],[b])=>a.localeCompare(b,'ko')).forEach(([nN,set])=>{
      if(!rosterSetN.has(nN)){
        const digits=[...set].filter(x=>x!==NAME_ONLY_SENTINEL);
        if(digits.length)digits.forEach(d=>extra.push([`${nN}/${d}`]));
        if(set.has(NAME_ONLY_SENTINEL))extra.push([`${nN}(ë²ˆí˜¸ì—†ìŒ)`]);
      }
    });

    const leavers=[];
    [...leftFinalDigitsByName.entries()].sort(([a],[b])=>a.localeCompare(b,'ko')).forEach(([nN,set])=>{
      const activeSet=activeDigitsByName.get(nN);
      set.forEach(d=>{
        if(!activeSet||!activeSet.has(d)){
          if(d===NAME_ONLY_SENTINEL)leavers.push([`${nN}(ë²ˆí˜¸ì—†ìŒ)`]);
          else leavers.push([`${nN}/${d}`]);
        }
      });
    });

    const readWriteRange=`${writeSheet}!D${WRITE_START_ROW}:T`;
    const wdata=await getRange(sheetId,readWriteRange);
    const rows=wdata.values||[];
    const targetRowsIdx=[];
    const nameCountN=new Map();
    for(let i=0;i<rows.length;i++){
      const r=rows[i]||[];
      const tVal=(r[16]??'').toString().trim(); // Tì—´
      if(tVal!=='ìˆ˜ê°•ìƒ')continue;
      const nameN=normalizeName(String(r[0]??'')); // D
      if(!nameN)continue;
      targetRowsIdx.push(i);
      nameCountN.set(nameN,(nameCountN.get(nameN)||0)+1);
    }
    const updates=[];
    const unresolved=[];
    for(const i of targetRowsIdx){
      const r=rows[i]||[];
      const nameRaw=String(r[0]??'').trim();
      const nameN=normalizeName(nameRaw);
      const phone4=last4Digits(r[1]??'');
      if(!nameN)continue;
      if(!attendingSetN.has(nameN))continue;
      const set=activeDigitsByName.get(nameN)||new Set();
      const isDupInPaid=(nameCountN.get(nameN)||0)>1;
      let canWrite=false;
      if(isDupInPaid){
        if(phone4&&set.has(phone4))canWrite=true;
        else{
          if(set.has(NAME_ONLY_SENTINEL))unresolved.push([nameRaw,'ê³µìœ ì‹œíŠ¸ ë™ëª…ì´ì¸ + ì…ì¥ë¡œê·¸ ë²ˆí˜¸ì—†ìŒ']);
          else unresolved.push([nameRaw,'ê³µìœ ì‹œíŠ¸ ë™ëª…ì´ì¸ + ë²ˆí˜¸ë¶ˆì¼ì¹˜']);
        }
      }else{
        if(set.size>=1||set.has(NAME_ONLY_SENTINEL))canWrite=true;
      }
      if(canWrite){
        const rowNumber=WRITE_START_ROW+i;
        updates.push({range:`${writeSheet}!S${rowNumber}`,values:[['ì…ì¥']]});
      }
    }

    if(updates.length&&!previewOnly){
      await batchUpdateValues(sheetId,updates);
    }

    const pills=$$('#pills'+sfx+sfx);
    if(pills){
      pills.innerHTML='';
      const mk=(t,c)=>{const s=document.createElement('span');s.className='pill '+c;s.textContent=t;return s;};
      pills.appendChild(mk(`ì…ì¥ë¡œê·¸ join ${joinedCount}`,'ok'));
      pills.appendChild(mk(`í‡´ì¥ë¡œê·¸ leave ${leftCount}`,'bad'));
      pills.appendChild(mk(`ì…ì¥ ëŒ€ìƒ(ì½ê¸°ì‹œíŠ¸) ${attendingSetN.size}`,'warn'));
      if(previewOnly)pills.appendChild(mk('ì²´í¬ë§Œ','warn'));
    }

    function resTbl(title,headers,rowsArr){
      if(!resultsEl)return;
      const wrap=document.createElement('div');wrap.className='card';
      const h=document.createElement('h3');h.textContent=title;h.style.margin='0 0 8px';wrap.appendChild(h);
      const t=document.createElement('table');const thead=document.createElement('thead');const trh=document.createElement('tr');
      headers.forEach(x=>{const th=document.createElement('th');th.textContent=x;trh.appendChild(th);});
      thead.appendChild(trh);t.appendChild(thead);
      const tb=document.createElement('tbody');
      (rowsArr||[]).forEach(r=>{const tr=document.createElement('tr');(r||[]).forEach(c=>{const td=document.createElement('td');td.textContent=(c==null?'':String(c));tr.appendChild(td);});tb.appendChild(tr);});
      t.appendChild(tb);wrap.appendChild(t);resultsEl.appendChild(wrap);
    }
    resTbl('ë‚´ ëª…ë‹¨ ê¸°ì¤€ ìƒíƒœ(ì½ê¸° ì‹œíŠ¸)',['no','name','phone','status','matched_id','notes'],report);
    resTbl('ëª…ë‹¨ ì™¸ ì…ì¥ì',['name/last4 or (ë²ˆí˜¸ì—†ìŒ)'],extra);
    resTbl('í‡´ì¥ì ëª…ë‹¨(ìµœì¢…)',['name/last4 or (ë²ˆí˜¸ì—†ìŒ)'],leavers);
    resTbl(previewOnly?'ì˜ˆìƒ ê°±ì‹  ê²°ê³¼(ì²´í¬ë§Œ ëª¨ë“œ)':'ê³µìœ  ì‹œíŠ¸ ê°±ì‹  ê²°ê³¼',['updated_cells'],updates.map(u=>[u.range+' â† ì…ì¥']));
    resTbl('ë¯¸í™•ì¸ ëª©ë¡(ê³µìœ  ì‹œíŠ¸ ë™ëª…ì´ì¸/ë²ˆí˜¸ ë¬¸ì œ)',['name','reason'],unresolved);

  }catch(e){
    const errEl=$$('err'+sfx);if(errEl)errEl.textContent='ì˜¤ë¥˜: '+(e?.message||e);
    console.error(e);
  }
}

/* ===== ë°ëª¨ ===== */
function runDemo(sfx){
  const errEl=$$('err'+sfx);if(errEl)errEl.textContent='';
  const resultsEl=$$('results'+sfx);if(resultsEl)resultsEl.innerHTML='';

  const roster=[
    {id:1,name:'í™©í˜„í•˜',phone:'010-1234-5678'},
    {id:3,name:'ê¹€í˜œì˜',phone:'010-3456-7890'},
    {id:4,name:'ì„ê·œë¦¬',phone:'010-1717-1771'},
    {id:5,name:'ê¹€ì˜ˆì€',phone:'010-1111-0000'},
    {id:6,name:'ë°©ì˜ˆì§„',phone:'010-0000-9999'},
  ];
  const rosterSetN=new Set(roster.map(r=>normalizeName(r.name)));
  const chatText=[
    'ê¹€ì˜ˆì€/0000ë‹˜ì´ ì…ì¥í•˜ì…¨ìŠµë‹ˆë‹¤',
    'í™©í˜„í•˜/5678ë‹˜ì´ ì…ì¥í•˜ì…¨ìŠµë‹ˆë‹¤',
    'ë°©ì˜ˆì§„/9999ë‹˜ì´ ì…ì¥í–ˆìŠµë‹ˆë‹¤',
    'ì„ê·œë¦¬ 1771ë‹˜ì´ ë“¤ì–´ì™”ìŠµë‹ˆë‹¤',
    'ê¹€í˜œì˜/7890ë‹˜ì´ ì…ì¥í•˜ì…¨ìŠµë‹ˆë‹¤',
    'ì§„ì¢…ë²”/2514ë‹˜ì´ ì…ì¥í•˜ì…¨ìŠµë‹ˆë‹¤',
    'ë§¤ë“œë“œë¼ì´ë²„ê¹€ì§€í˜„ë‹˜ì´ ì…ì¥í•˜ì…¨ìŠµë‹ˆë‹¤',
    'ì„¸ê³„ì œì¼ì˜ê·œë¦¬ë‹¹ì¥ì°¬ì–‘ë‹˜ì´ ë‚˜ê°”ìŠµë‹ˆë‹¤.',
    'ì†¡ì§€í˜„ì˜ˆì˜ë‹¤ë‹˜ì„ ë‚´ë³´ëƒˆìŠµë‹ˆë‹¤.'
  ].join('\n');
  const {events,joinedCount,leftCount}=parseChat(chatText);
  const NAME_ONLY_SENTINEL='__NAMEONLY__';
  const active=new Map();const leftFinal=new Map();
  const ensure=(map,key)=>{if(!map.has(key))map.set(key,new Set());return map.get(key);};
  for(const ev of events){
    const s=splitNickname(ev.nick);if(!s)continue;
    const nN=s.name;
    if(ev.type==='join'){
      ensure(active,nN).add(s.digits||NAME_ONLY_SENTINEL);
      const L=leftFinal.get(nN);if(L){L.delete(s.digits||NAME_ONLY_SENTINEL);if(L.size===0)leftFinal.delete(nN);}
    }else{
      const A=ensure(active,nN);
      if(s.digits)A.delete(s.digits);
      else if(A.size===1&&A.has(NAME_ONLY_SENTINEL))A.delete(NAME_ONLY_SENTINEL);
      ensure(leftFinal,nN).add(s.digits||NAME_ONLY_SENTINEL);
    }
  }
  const paidRows=[
    {name:'ê¹€ì˜ˆì€',phone4:'0000'},
    {name:'ë°©ì˜ˆì§„',phone4:'9999'},
    {name:'í™©í˜„í•˜',phone4:'5678'},
    {name:'í™©í˜„í•˜',phone4:'9999'},
    {name:'ê¹€í˜œì˜',phone4:''},
  ];
  const paidNameCountN=new Map();
  for(const r of paidRows){
    const nN=normalizeName(r.name);
    paidNameCountN.set(nN,(paidNameCountN.get(nN)||0)+1);
  }
  const report=[];
  for(const r of roster){
    const nN=normalizeName(r.name);
    const set=active.get(nN)||new Set();
    const isActive=set.size>0;
    const any4=[...set].find(x=>x!==NAME_ONLY_SENTINEL)||'';
    report.push([String(r.id),r.name,r.phone,isActive?'ì…ì¥':'ë¯¸ì…ì¥',isActive?(any4?`${r.name}/${any4}`:r.name):'',isActive&&!any4?'(ë²ˆí˜¸ì—†ìŒ)':'']);
  }
  const extra=[];
  [...active.entries()].sort(([a],[b])=>a.localeCompare(b,'ko')).forEach(([nN,set])=>{
    if(!rosterSetN.has(nN)){
      const digits=[...set].filter(x=>x!==NAME_ONLY_SENTINEL);
      if(digits.length)digits.forEach(d=>extra.push([`${nN}/${d}`]));
      if(set.has(NAME_ONLY_SENTINEL))extra.push([`${nN}(ë²ˆí˜¸ì—†ìŒ)`]);
    }
  });
  const leavers=[];
  [...leftFinal.entries()].sort(([a],[b])=>a.localeCompare(b,'ko')).forEach(([nN,set])=>{
    const act=active.get(nN);
    set.forEach(d=>{if(!act||!act.has(d))leavers.push([d===NAME_ONLY_SENTINEL?`${nN}(ë²ˆí˜¸ì—†ìŒ)`:`${nN}/${d}`]);});
  });
  const unresolved=[];
  for(const r of paidRows){
    const nN=normalizeName(r.name);
    const set=active.get(nN)||new Set();
    const isDupInPaid=(paidNameCountN.get(nN)||0)>1;
    if(!isDupInPaid)continue;
    const p4=(r.phone4||'').trim();
    if(p4&&set.has(p4))continue;
    unresolved.push([r.name,p4?'ê³µìœ ì‹œíŠ¸ ë™ëª…ì´ì¸ + ë²ˆí˜¸ë¶ˆì¼ì¹˜':'ê³µìœ ì‹œíŠ¸ ë™ëª…ì´ì¸ + ì…ì¥ë¡œê·¸ ë²ˆí˜¸ì—†ìŒ']);
  }
  const pills=$$('#pills'+sfx+sfx);
  if(pills){
    pills.innerHTML='';
    const mk=(t,c)=>{const s=document.createElement('span');s.className='pill '+c;s.textContent=t;return s;};
    const attendingCount=roster.filter(r=>(active.get(normalizeName(r.name))||new Set()).size>0).length;
    pills.appendChild(mk(`ì…ì¥ë¡œê·¸ join ${joinedCount}`,'ok'));
    pills.appendChild(mk(`í‡´ì¥ë¡œê·¸ leave ${leftCount}`,'bad'));
    pills.appendChild(mk(`ì…ì¥ ëŒ€ìƒ(ì½ê¸°ì‹œíŠ¸) ${attendingCount}`,'warn'));
    pills.appendChild(mk('ì²´í¬ë§Œ','warn'));
  }
  function resTbl(title,headers,rowsArr){
    if(!resultsEl)return;
    const wrap=document.createElement('div');wrap.className='card';
    const h=document.createElement('h3');h.textContent=title;h.style.margin='0 0 8px';wrap.appendChild(h);
    const t=document.createElement('table');const thead=document.createElement('thead');const trh=document.createElement('tr');
    headers.forEach(x=>{const th=document.createElement('th');th.textContent=x;trh.appendChild(th);});
    thead.appendChild(trh);t.appendChild(thead);
    const tb=document.createElement('tbody');
    (rowsArr||[]).forEach(r=>{const tr=document.createElement('tr');(r||[]).forEach(c=>{const td=document.createElement('td');td.textContent=(c==null?'':String(c));tr.appendChild(td);});tb.appendChild(tr);});
    t.appendChild(tb);wrap.appendChild(t);resultsEl.appendChild(wrap);
  }
  resTbl('ëª…ë‹¨ê¸°ì¤€ ì…ì¥ì(ë°ëª¨)',['no','name','phone','status','matched_id','notes'],report);
  resTbl('ëª…ë‹¨ ì™¸ ì…ì¥ì(ë°ëª¨)',['name/last4 or (ë²ˆí˜¸ì—†ìŒ)'],extra);
  resTbl('í‡´ì¥ì ëª…ë‹¨(ë°ëª¨)',['name/last4 or (ë²ˆí˜¸ì—†ìŒ)'],leavers);
  resTbl('ë¯¸í™•ì¸ ëª©ë¡(ë°ëª¨)',['name','reason'],unresolved);
}

/* ===== ë“œë¼ì´ë¸Œ í´ë” ëª¨ìŒ (drive í™”ë©´ìš©) ===== */
const DRIVE_SHORTCUTS=[
  {
    label:'ì¹´í†¡ ì…ì¥ì ë¡œê·¸ ê¸°ë³¸ í´ë”',
    url:'https://drive.google.com/drive/folders/1OIZGro5_CVmlsNiOuvtzbnHDukPJIcQJ?usp=drive_link',
    desc:'ì¹´í†¡ ë°©ë³„ ëŒ€í™”ë‚´ì—­ txt/csv ëª¨ì•„ë‘ëŠ” ê¸°ë³¸ í´ë”'
  },
  // í•„ìš”í•˜ë©´ ì—¬ê¸° ë°‘ì— ê³„ì† ì¶”ê°€
];

function renderDriveShortcuts(){
  const root=$$('driveShortcutList');
  if(!root)return;
  root.innerHTML='';
  if(!DRIVE_SHORTCUTS.length){
    root.textContent='ë“±ë¡ëœ í´ë”ê°€ ì—†ìŠµë‹ˆë‹¤. ì½”ë“œ ìƒë‹¨ì˜ DRIVE_SHORTCUTSì— ì¶”ê°€í•´ì£¼ì„¸ìš”.';
    return;
  }
  DRIVE_SHORTCUTS.forEach(sc=>{
    const a=document.createElement('a');
    a.href=sc.url;
    a.target='_blank';
    a.rel='noopener';
    a.style.textDecoration='none';
    const card=document.createElement('div');
    card.className='card';
    card.style.marginBottom='0';
    card.style.display='flex';
    card.style.alignItems='flex-start';
    card.style.gap='10px';
    card.innerHTML=`
      <div style="font-size:22px">ğŸ“</div>
      <div>
        <div style="font-weight:600;margin-bottom:4px">${sc.label}</div>
        <div class="hint">${sc.desc||''}</div>
        <div class="hint" style="margin-top:4px;font-size:11px">${sc.url}</div>
      </div>
    `;
    a.appendChild(card);
    root.appendChild(a);
  });
}

/* ===== ì´ˆê¸°í™” ===== */
window.addEventListener('load',()=>{if(window.google?.accounts?.oauth2)initAuth();});

document.addEventListener('DOMContentLoaded',()=>{
  // ë„¤ë¹„ê²Œì´ì…˜ ë²„íŠ¼
  document.querySelectorAll('[data-screen-target]').forEach(btn=>{
    btn.addEventListener('click',()=>{
      const target=btn.getAttribute('data-screen-target');
      showScreen(target);
    });
  });

  // ë¡œê·¸ì¸/ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼
  const loginBtn=$$('gsLoginBtn');
  if(loginBtn)loginBtn.addEventListener('click',requestAccess);
  const logoutBtn=$$('gsLogoutBtn');
  if(logoutBtn)logoutBtn.addEventListener('click',revokeAccess);
  const logoutFromHome=$$('goLogoutFromHome');
  if(logoutFromHome)logoutFromHome.addEventListener('click',revokeAccess);

  txt('homeAuthState','ë¯¸ë¡œê·¸ì¸');

  // ê´€ë¦¬ì íŒ¨ë„ (ì¹´í†¡ í™”ë©´ ì „ìš©)
  const overlay=$$('adminOverlay'),drawer=$$('adminDrawer');
  const openAdmin=()=>{if(overlay&&drawer){overlay.classList.add('open');drawer.classList.add('open');renderAdmList();}};
  const closeAdmin=()=>{if(overlay&&drawer){overlay.classList.remove('open');drawer.classList.remove('open');}};
  const settingsBtn=$$('settingsBtn');
  if(settingsBtn)settingsBtn.addEventListener('click',openAdmin);
  const closeAdminBtn=$$('closeAdmin');
  if(closeAdminBtn)closeAdminBtn.addEventListener('click',closeAdmin);
  if(overlay)overlay.addEventListener('click',closeAdmin);

  const admAddBtn=$$('admAdd');
  if(admAddBtn)admAddBtn.addEventListener('click',admAdd);
  const admClearBtn=$$('admClearAll');
  if(admClearBtn)admClearBtn.addEventListener('click',()=>{
    if(confirm('ëª¨ë“  ì—°ê²°ì„ ì‚­ì œí• ê¹Œìš”?')){
      clearPacks();renderAdmList();populatePacks('A');populatePacks('B');
    }
  });

  // Panel A
  const spaA=$$('sheetPackSelectA');
  if(spaA)spaA.addEventListener('change',()=>onPackChanged('A'));
  const rma=$$('refreshMetaA');
  if(rma)rma.addEventListener('click',()=>refreshMeta('A'));
  const runA=$$('runBtnA');
  if(runA)runA.addEventListener('click',()=>runMain('A'));
  const demoA=$$('demoBtnA');
  if(demoA)demoA.addEventListener('click',()=>runDemo('A'));
  const dpA=$$('dirPickA');
  if(dpA)dpA.addEventListener('click',()=>pickDriveFolder('A'));
  const drA=$$('dirRefreshA');
  if(drA)drA.addEventListener('click',()=>refreshDriveList('A'));

  // Panel B
  const spaB=$$('sheetPackSelectB');
  if(spaB)spaB.addEventListener('change',()=>onPackChanged('B'));
  const rmb=$$('refreshMetaB');
  if(rmb)rmb.addEventListener('click',()=>refreshMeta('B'));
  const runB=$$('runBtnB');
  if(runB)runB.addEventListener('click',()=>runMain('B'));
  const demoB=$$('demoBtnB');
  if(demoB)demoB.addEventListener('click',()=>runDemo('B'));
  const dpB=$$('dirPickB');
  if(dpB)dpB.addEventListener('click',()=>pickDriveFolder('B'));
  const drB=$$('dirRefreshB');
  if(drB)drB.addEventListener('click',()=>refreshDriveList('B'));

  populatePacks('A');
  populatePacks('B');

  // ì¹´í†¡ ì…ì¥ì ì²´í¬ ê¸°ë³¸ í´ë”ë¥¼ A íŒ¨ë„ì— ì„¸íŒ… (ì›í•˜ë©´ Bì—ë„)
  driveFolderId.A = extractDriveFolderId('https://drive.google.com/drive/folders/1OIZGro5_CVmlsNiOuvtzbnHDukPJIcQJ?usp=drive_link');
  refreshDriveList('A');

  renderDriveShortcuts();
});
</script>
</body>
</html>
