<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>í´ë˜ìŠ¤ì–´ë¼ìš´ë“œ Â· ìš´ì˜ë´‡ ëŒ€ì‹œë³´ë“œ</title>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <style>
    :root{
      --bg:#fff; --card:#fff; --surface:#f8fafc; --line:#e5e7eb; --text:#0f172a; --muted:#64748b;
      --accent:#60a5fa; --accent-strong:#3b82f6; --ok:#22c55e; --warn:#f59e0b; --bad:#ef4444;
      --radius:12px; --ctl-h:42px; --gap:12px; --logo-size:112px;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font:14px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
    .wrap{max-width:1200px;margin:28px auto;padding:0 16px}
    h1{font-size:22px;margin:0 0 8px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:16px;margin-bottom:16px}
    label{display:block;color:var(--muted);margin-bottom:6px}
    select{
      width:100%; background:#fff; color:var(--text); border:1px solid var(--line);
      border-radius:var(--radius); padding:10px 12px; outline:none; height:var(--ctl-h);
    }
    .btn{
      appearance:none; border:1px solid var(--line); background:#fff; color:var(--text);
      padding:10px 14px; border-radius:var(--radius); cursor:pointer; transition:all .15s ease;
      height:var(--ctl-h); display:inline-flex; align-items:center; justify-content:center;
    }
    .btn:hover{border-color:var(--accent-strong);box-shadow:0 0 0 3px rgba(96,165,250,.2)}
    .btn.acc{background:var(--accent);border-color:var(--accent);color:#fff}
    .btn.acc:hover{background:var(--accent-strong);border-color:var(--accent-strong)}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .hint{color:#64748b;font-size:12px}
    .err{color:#ef4444;font-family:ui-monospace,monospace;white-space:pre-wrap}

    .pill{display:inline-flex;gap:8px;align-items:center;padding:6px 10px;border:1px solid var(--line);border-radius:999px;color:var(--muted);background:#fff}
    .pill.ok{border-color:rgba(34,197,94,.25);color:var(--ok)}
    .pill.warn{border-color:rgba(245,158,11,.25);color:var(--warn)}
    .pill.bad{border-color:rgba(239,68,68,.25);color:var(--bad)}
    table{width:100%;border-collapse:collapse;border:1px solid var(--line);overflow:auto;background:#fff;border-radius:12px}
    th,td{padding:8px 10px;border-bottom:1px solid var(--line);text-align:left;vertical-align:top}
    th{color:#0f172a;font-weight:600;background:#f1f5f9;position:sticky;top:0}

    .brand{display:flex;align-items:center;gap:14px;margin:0 0 6px}
    .brand h1{margin:0;font-size:22px}
    .brand-logo{width:var(--logo-size);height:var(--logo-size);flex:0 0 var(--logo-size)}
    .logo-text{
      font-family:'Nunito','Arial Rounded MT','SF Pro Rounded','Quicksand','Pretendard','Noto Sans KR',sans-serif;
      font-weight:900; letter-spacing:-0.2px; fill:#0f172a; font-size:18px;
      paint-order:stroke fill; stroke:#0f172a; stroke-width:.9px;
    }

    .brand-sub{font-size:12px;color:var(--muted);margin-top:2px}

    .admin-drawer{width:520px;padding:14px 16px 18px}
    .admin-drawer .card{background:#fff;border:1px solid var(--line);border-radius:16px;padding:14px 16px;box-shadow:none;margin:0 0 12px}
    .admin-drawer h4{margin:0 0 8px;font-weight:700}
    .admin-drawer label{color:#64748b;font-size:13px;margin:6px 0 4px}
    .admin-drawer input{height:42px;border:1px solid var(--line);border-radius:12px;padding:10px 12px}
    .admin-drawer .btn{height:36px;padding:0 12px;border-radius:12px}
    #admList{border-collapse:collapse;width:100%}
    #admMeta{color:#94a3b8;margin-top:8px}
    :root{--admin-h:44px}
    .admin-drawer input,.admin-drawer .btn{height:var(--admin-h);line-height:calc(var(--admin-h) - 2px);border-radius:12px}

    .panels{display:grid;gap:16px}
    @media(min-width:1100px){ .panels{grid-template-columns:1fr 1fr} }

    .controls{display:grid;gap:var(--gap)}
    .controls-line{display:grid;align-items:end;gap:var(--gap);grid-template-columns:1.2fr 1fr var(--ctl-h)}
    .icon-btn{width:var(--ctl-h);height:var(--ctl-h);border:1px solid var(--line);border-radius:10px;background:#fff;display:inline-flex;align-items:center;justify-content:center;cursor:pointer}
    .icon-btn:hover{border-color:var(--accent-strong);box-shadow:0 0 0 3px rgba(96,165,250,.2)}
    .icon-btn svg{width:18px;height:18px}

    .dirline{
      display:grid;align-items:center;gap:8px;
      grid-template-columns:auto minmax(120px,auto) minmax(240px,1fr) auto;
    }
    .dirlabel{
      display:none;
      color:#64748b;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
      font-weight:700;
    }
    .dirlabel::before{content:"ğŸ“";margin-right:8px;opacity:.9}
    .dirlabel.connected{display:inline-block;color:var(--accent-strong);font-weight:800}

    .gear-btn{position:fixed;top:16px;right:16px;z-index:50;background:#fff;border:1px solid var(--line);border-radius:12px;padding:8px;cursor:pointer}
    .admin-overlay{position:fixed;inset:0;background:rgba(15,23,42,.28);backdrop-filter:saturate(140%) blur(2px);visibility:hidden;opacity:0;pointer-events:none;transition:.15s;z-index:60}
    .admin-overlay.open{visibility:visible;opacity:1;pointer-events:auto}
    .admin-drawer{position:fixed;top:0;right:0;height:100%;width:520px;max-width:92vw;background:#fff;border-left:1px solid var(--line);box-shadow:-8px 0 24px rgba(0,0,0,.08);padding:16px 16px 24px;display:flex;flex-direction:column;gap:12px;z-index:70;transform:translateX(12px);opacity:0;pointer-events:none;transition:transform .15s, opacity .15s}
    .admin-drawer.open{transform:translateX(0);opacity:1;pointer-events:auto}
    .x-btn{appearance:none;border:1px solid var(--line);background:#fff;border-radius:10px;padding:6px 8px;cursor:pointer}
  </style>
</head>
<body>
  <button id="settingsBtn" class="gear-btn" title="ì„¤ì •" type="button" aria-label="ê´€ë¦¬ì ì„¤ì • ì—´ê¸°">âš™</button>

  <div class="wrap">
    <header class="brand">
      <svg class="brand-logo" viewBox="0 0 90 50" role="img" aria-label="ClassAround">
        <rect width="90" height="50" rx="10" fill="white"/>
        <circle cx="66" cy="10" r="8" fill="#6b8bd6"/>
        <circle cx="80" cy="18" r="5" fill="#ef4444"/>
        <text x="8" y="24" class="logo-text">Class</text>
        <text x="8" y="42" class="logo-text">Around</text>
      </svg>
      <div>
        <h1>í´ë˜ìŠ¤ì–´ë¼ìš´ë“œ ìš´ì˜ë´‡</h1>
        <div class="brand-sub">ì¹´ì¹´ì˜¤í†¡ ì…ì¥ì ì²´í¬ Â· ì±—ë´‡ ë°ì´í„° Â· ì„¸ì¼ì¦ˆ ë©˜íŠ¸ Â· ë“œë¼ì´ë¸Œ Â· ê²°ì œì CSV</div>
      </div>
    </header>

    <!-- ë¡œê·¸ì¸ ì¹´ë“œ (í•­ìƒ ì²« í™”ë©´ì— ë³´ì´ëŠ” ì˜ì—­) -->
    <div class="card" id="authCard">
      <div class="row">
        <button id="gsLoginBtn" class="btn acc" type="button">ë¡œê·¸ì¸</button>
        <button id="gsLogoutBtn" class="btn" type="button">ë¡œê·¸ì•„ì›ƒ</button>
        <span id="authState" class="hint">ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.</span>
      </div>
      <div id="authErr" class="err" style="margin-top:6px"></div>
    </div>

    <!-- ê¸°ëŠ¥ ì„ íƒ ë©”ë‰´ (ë¡œê·¸ì¸ í›„ì—ë§Œ í‘œì‹œ) -->
    <div class="card" id="featureMenuCard" style="display:none">
      <label>ê¸°ëŠ¥ ì„ íƒ</label>
      <div class="row" style="margin-top:4px">
        <button id="featureBtnEntrant" class="btn acc" type="button">ì…ì¥ì ì²´í¬</button>
        <button id="featureBtnChatbot" class="btn" type="button" disabled>ì±—ë´‡ ë°ì´í„° (ì¤€ë¹„ì¤‘)</button>
        <button id="featureBtnSales" class="btn" type="button" disabled>ì„¸ì¼ì¦ˆ ë©˜íŠ¸ GPTs (ì¤€ë¹„ì¤‘)</button>
        <button id="featureBtnDrive" class="btn" type="button" disabled>ë“œë¼ì´ë¸Œ ë§í¬ ëª¨ìŒ (ì¤€ë¹„ì¤‘)</button>
        <button id="featureBtnCsv" class="btn" type="button" disabled>ê²°ì œì CSV ì •ë¦¬ (ì¤€ë¹„ì¤‘)</button>
      </div>
      <div class="hint" style="margin-top:6px">
        Google ë¡œê·¸ì¸ í›„ ì‚¬ìš©í•˜ê³  ì‹¶ì€ ê¸°ëŠ¥ ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.  
        (ì§€ê¸ˆì€ <strong>ì…ì¥ì ì²´í¬</strong>ë§Œ ì—°ê²°ë˜ì–´ ìˆê³ , ë‚˜ë¨¸ì§€ëŠ” ì´í›„ ì½”ë“œ ë°›ìœ¼ë©´ ì—°ê²°í•  ì˜ˆì •)
      </div>
    </div>

    <!-- ê¸°ëŠ¥ë³„ ì„¹ì…˜ ì»¨í…Œì´ë„ˆ -->
    <div id="featureContainer">
      <!-- ì…ì¥ì ì²´í¬ ì„¹ì…˜: ê¸°ì¡´ Panel A/B ì „ì²´ë¥¼ ê·¸ëŒ€ë¡œ ê°ìŒˆ -->
      <section id="featureEntrant" data-feature-section="entrant" style="display:none">
        <div class="panels">
          <!-- Panel A -->
          <section>
            <div class="card">
              <div class="controls">
                <div class="controls-line">
                  <div>
                    <label>ì‹œíŠ¸ ì„ íƒ</label>
                    <select id="sheetPackSelectA"></select>
                  </div>
                  <div>
                    <label>ì½ê¸° ì‹œíŠ¸ ì„ íƒ</label>
                    <select id="readSheetSelectA"></select>
                  </div>
                  <div>
                    <label style="visibility:hidden">refresh</label>
                    <button id="refreshMetaA" class="icon-btn" type="button">
                      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M3 12a9 9 0 1 0 3-6.7"/><polyline points="3 4 3 10 9 10"/>
                      </svg>
                    </button>
                  </div>
                </div>

                <div class="hint" style="margin-top:-4px"></div>

                <label style="margin-top:8px"></label>
                <div class="dirline">
                  <button id="dirPickA" class="btn" type="button">í´ë”</button>
                  <div class="dirlabel" id="dirNameA"></div>
                  <select id="dirFileSelectA"></select>
                  <button id="dirRefreshA" class="icon-btn" type="button">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M3 12a9 9 0 1 0 3-6.7"/><polyline points="3 4 3 10 9 10"/>
                    </svg>
                  </button>
                </div>
              </div>

              <div class="row" style="margin-top:10px">
                <label class="row" style="gap:6px;align-items:center">
                  <input id="previewOnlyA" type="checkbox" />
                  <span class="hint">ì—´ëŒìš©</span>
                </label>
                <button id="runBtnA" class="btn acc" type="button">ì‹¤í–‰</button>
                <button id="demoBtnA" class="btn" type="button">ë°ëª¨</button>
                <span id="pillsAA" class="row"></span>
              </div>
              <div id="errA" class="err" style="margin-top:8px"></div>
            </div>
            <div id="resultsA" style="display:grid;gap:16px"></div>
          </section>

          <!-- Panel B -->
          <section>
            <div class="card">
              <div class="controls">
                <div class="controls-line">
                  <div>
                    <label>ì‹œíŠ¸ ì„ íƒ</label>
                    <select id="sheetPackSelectB"></select>
                  </div>
                  <div>
                    <label>ì½ê¸° ì‹œíŠ¸ ì„ íƒ</label>
                    <select id="readSheetSelectB"></select>
                  </div>
                  <div>
                    <label style="visibility:hidden">refresh</label>
                    <button id="refreshMetaB" class="icon-btn" type="button">
                      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M3 12a9 9 0 1 0 3-6.7"/><polyline points="3 4 3 10 9 10"/>
                      </svg>
                    </button>
                  </div>
                </div>

                <div class="hint" style="margin-top:-4px"></div>

                <label style="margin-top:8px"></label>
                <div class="dirline">
                  <button id="dirPickB" class="btn" type="button">í´ë”</button>
                  <div class="dirlabel" id="dirNameB"></div>
                  <select id="dirFileSelectB"></select>
                  <button id="dirRefreshB" class="icon-btn" type="button">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M3 12a9 9 0 1 0 3-6.7"/><polyline points="3 4 3 10 9 10"/>
                    </svg>
                  </button>
                </div>
              </div>

              <div class="row" style="margin-top:10px">
                <label class="row" style="gap:6px;align-items:center">
                  <input id="previewOnlyB" type="checkbox" />
                  <span class="hint">ì—´ëŒìš©</span>
                </label>
                <button id="runBtnB" class="btn acc" type="button">ì‹¤í–‰</button>
                <button id="demoBtnB" class="btn" type="button">ë°ëª¨</button>
                <span id="pillsBB" class="row"></span>
              </div>
              <div id="errB" class="err" style="margin-top:8px"></div>
            </div>
            <div id="resultsB" style="display:grid;gap:16px"></div>
          </section>
        </div>
      </section>

      <!-- ì´í›„ ì½”ë“œ ë¶™ì¼ ìë¦¬ë“¤: ì§€ê¸ˆì€ ë¹„ì–´ ìˆê³  ìˆ¨ê²¨ë‘  -->
      <section id="featureChatbot" data-feature-section="chatbot" style="display:none">
        <!-- ë©”ì‹ ì €ë´‡R / ì±—ë´‡ ë°ì´í„°ìš© UI ì—¬ê¸° ë“¤ì–´ê°ˆ ì˜ˆì • -->
      </section>

      <section id="featureSales" data-feature-section="sales" style="display:none">
        <!-- ì„¸ì¼ì¦ˆ ë©˜íŠ¸ GPTs UI ì—¬ê¸° ë“¤ì–´ê°ˆ ì˜ˆì • -->
      </section>

      <section id="featureDrive" data-feature-section="drive" style="display:none">
        <!-- ë“œë¼ì´ë¸Œ í´ë” ë§í¬ ëª¨ìŒ UI ì—¬ê¸° ë“¤ì–´ê°ˆ ì˜ˆì • -->
      </section>

      <section id="featureCsv" data-feature-section="csv" style="display:none">
        <!-- ê²°ì œì CSV ì •ë¦¬ UI ì—¬ê¸° ë“¤ì–´ê°ˆ ì˜ˆì • -->
      </section>
    </div>
  </div>

  <div id="adminOverlay" class="admin-overlay" aria-hidden="true"></div>
  <aside id="adminDrawer" class="admin-drawer" aria-hidden="true">
    <div class="row" style="justify-content:space-between;align-items:center;margin-bottom:8px">
      <h3 style="margin:0">ê´€ë¦¬ì ì„¤ì •</h3>
      <button id="closeAdmin" class="x-btn" type="button">ë‹«ê¸°</button>
    </div>

    <div class="card" style="margin:0">
      <h4 style="margin:0 0 8px">ìŠ¤í”„ë ˆë“œì‹œíŠ¸ ì—°ê²° ì¶”ê°€</h4>
      <label>í‘œì‹œ ì´ë¦„(ì„ íƒ)</label>
      <input id="admLabel" type="text" placeholder="ì˜ˆ: ë””ë…¸ ì¿ íŒ¡ 3ê¸°" />
      <label style="margin-top:10px">ìŠ¤í”„ë ˆë“œì‹œíŠ¸ ë§í¬(URL)</label>
      <input id="admUrl" type="text" placeholder="https://docs.google.com/spreadsheets/d/..." />
      <label style="margin-top:10px">ì½ì„ ì—´(A~) <span class="hint">ì½ê¸° ì‹œíŠ¸ ì´ë¦„ì—´(ì˜ˆ: C)</span></label>
      <input id="admReadCol" type="text" value="G" />
      <div class="row" style="margin-top:10px">
        <button id="admAdd" class="btn" type="button">ì—°ê²° ì¶”ê°€</button>
        <button id="admClearAll" class="btn" type="button">ì „ì²´ ì‚­ì œ</button>
      </div>
      <div id="admErr" class="err" style="margin-top:8px"></div>
    </div>

    <div class="card" style="margin-top:12px">
      <h4 style="margin:0 0 8px">ë“±ë¡ëœ ìŠ¤í”„ë ˆë“œì‹œíŠ¸</h4>
      <table style="width:100%;border-collapse:collapse">
        <thead><tr><th>ë¼ë²¨</th><th>ì‹œíŠ¸ìˆ˜</th><th>ì½ì„ ì—´</th><th>ì‘ì—…</th></tr></thead>
        <tbody id="admList"><tr><td colspan="4" style="color:#64748b">ì—†ìŒ</td></tr></tbody>
      </table>
      <div class="hint" id="admMeta" style="margin-top:6px"></div>
    </div>
  </aside>

<script>
const PANEL_SUFFIXES=['A','B'];
const $$=id=>document.getElementById(id);
const byPanel=(base,s)=>$$(base+s);
const txt=(id,v,sfx)=>{const el=sfx?byPanel(id,sfx):$$(id);if(el)el.textContent=v||'';};
const val=(id,sfx)=>{const el=sfx?byPanel(id,sfx):$$(id);return el?el.value:'';};
function on(id,ev,fn,sfx){
  const el=sfx?byPanel(id,sfx):$$(id);
  if(!el){console.warn('bind skip',id,sfx);return;}
  el.addEventListener(ev,e=>{try{fn(e);}catch(err){console.error(err);}});
}
function show(el){el.classList.add('open');el.setAttribute('aria-hidden','false');}
function hide(el){el.classList.remove('open');el.setAttribute('aria-hidden','true');}
function digitsOnly(s){return String(s||'').replace(/[^\d]/g,'');}
function last4Digits(s){const d=digitsOnly(s);return d.slice(-4);}
function normalizeName(n){
  let s=String(n||'').trim();
  s=s.replace(/[\s]*[\(\[\{ï¼ˆã€][^)\]\}ï¼‰ã€‘]*[\)\]\}ï¼‰ã€‘]\s*$/,'');
  s=s.replace(/[/_\-\s]+$/,'');
  s=s.replace(/\s+/g,' ');
  return s;
}
const earlierId=(a,b)=>{const ai=parseInt(a,10),bi=parseInt(b,10);if(!Number.isNaN(ai)&&!Number.isNaN(bi))return ai<=bi?a:b;return(String(a)<=String(b))?a:b;};

(function(){
  const pushErr=(msg,src,l,c,e)=>{
    const details=(e&&e.stack)?'\n'+e.stack:'';
    PANEL_SUFFIXES.forEach(s=>{
      const el=$$('#err'+s);
      if(el)el.textContent='ì˜¤ë¥˜: '+msg+(src?`\n${src}:${l}:${c}`:'')+details;
    });
  };
  window.addEventListener('error',e=>pushErr(e.message,e.filename,e.lineno,e.colno,e.error));
  window.addEventListener('unhandledrejection',e=>{
    const r=e.reason||{};
    pushErr(r.message||String(r),'',0,0,r);
  });
})();

/* ===== ê¸°ë³¸ ì„¤ì • ===== */
const READ_START_ROW=2;
const WRITE_START_ROW=2;
const FIXED_WRITE_SHEET='ê³µìœ ìš© ì‹œíŠ¸';

/* âœ… ì—¬ê¸°ì— ë³¸ì¸ OAuth í´ë¼ì´ì–¸íŠ¸ ID ë„£ê¸° */
const CLIENT_ID="18228268359-iifm4ck3j9kqj74eh1p90tco1k2mbpi0.apps.googleusercontent.com";

/* ===== OAuth ===== */
let accessToken=null,tokenClient=null;

function setFeatureVisibility(isLoggedIn){
  const menuCard=$$('featureMenuCard');
  if(menuCard) menuCard.style.display=isLoggedIn?'block':'none';
  if(!isLoggedIn){
    // ëª¨ë“  ê¸°ëŠ¥ ì„¹ì…˜ ìˆ¨ê¸°ê¸°
    document.querySelectorAll('[data-feature-section]').forEach(sec=>{
      sec.style.display='none';
    });
  }
}

function showFeatureSection(key){
  document.querySelectorAll('[data-feature-section]').forEach(sec=>{
    sec.style.display = (sec.dataset.featureSection===key)?'block':'none';
  });
}

function initAuth(){
  try{
    if(!window.google?.accounts?.oauth2){txt('authErr','GIS ë¡œë“œ ì‹¤íŒ¨');return;}
    tokenClient=google.accounts.oauth2.initTokenClient({
      client_id:CLIENT_ID,
      scope:'https://www.googleapis.com/auth/spreadsheets https://www.googleapis.com/auth/drive.readonly',
      prompt:'',
      callback:res=>{
        accessToken=res.access_token;
        txt('authState','ë¡œê·¸ì¸ ì™„ë£Œ');
        txt('authErr','');
        setFeatureVisibility(true);
      },
      error_callback:err=>{
        txt('authErr','OAuth ì˜¤ë¥˜: '+(err?.error||err?.type||JSON.stringify(err)));
      }
    });
  }catch(e){txt('authErr','OAuth ì´ˆê¸°í™” ì˜¤ë¥˜');console.error(e);}
}
function requestAccess(){
  if(!tokenClient){txt('authErr','OAuth ì´ˆê¸°í™” ì‹¤íŒ¨');return;}
  tokenClient.requestAccessToken({prompt:'consent'});
}
function revokeAccess(){
  if(accessToken){
    google.accounts.oauth2.revoke(accessToken,()=>{
      accessToken=null;
      txt('authState','ë¯¸ë¡œê·¸ì¸');
      setFeatureVisibility(false);
    });
  }else{
    setFeatureVisibility(false);
    txt('authState','ë¯¸ë¡œê·¸ì¸');
  }
}
function requireAuth(){if(!accessToken)throw new Error('ë¨¼ì € Google ë¡œê·¸ì¸í•˜ì„¸ìš”.');}

/* ===== Sheets ===== */
async function gFetch(url,init){
  requireAuth();
  const res=await fetch(url,{...(init||{}),headers:{...(init&&init.headers||{}),Authorization:'Bearer '+accessToken,'Content-Type':'application/json'}});
  if(!res.ok)throw new Error(await res.text());
  return res.json();
}
async function listSheets(spreadsheetId){
  const url=`https://sheets.googleapis.com/v4/spreadsheets/${encodeURIComponent(spreadsheetId)}?fields=sheets(properties(title))`;
  const data=await gFetch(url);
  return (data.sheets||[]).map(s=>s.properties.title);
}
async function getRange(spreadsheetId,rangeA1){
  const url=`https://sheets.googleapis.com/v4/spreadsheets/${encodeURIComponent(spreadsheetId)}/values/${encodeURIComponent(rangeA1)}`;
  return await gFetch(url);
}
async function batchUpdateValues(spreadsheetId,dataRanges){
  const url=`https://sheets.googleapis.com/v4/spreadsheets/${encodeURIComponent(spreadsheetId)}/values:batchUpdate`;
  return await gFetch(url,{method:'POST',body:JSON.stringify({valueInputOption:'USER_ENTERED',data:dataRanges})});
}

/* ===== ê´€ë¦¬ì ì €ì¥ ===== */
const PACKS_KEY='ca_gsapi_sources_v12';
const loadPacks=()=>{try{return JSON.parse(localStorage.getItem(PACKS_KEY)||'[]');}catch(e){return[];}};
const savePacks=ps=>localStorage.setItem(PACKS_KEY,JSON.stringify(ps));
const addPack=p=>{const a=loadPacks();a.push(p);savePacks(a);};
const removePack=id=>savePacks(loadPacks().filter(p=>p.id!==id));
const clearPacks=()=>localStorage.removeItem(PACKS_KEY);

let admBusy=false;
async function admAdd(){
  if(admBusy)return;
  admBusy=true;
  try{
    txt('admErr','');
    const label=(val('admLabel').trim()||'ìŠ¤í”„ë ˆë“œì‹œíŠ¸');
    const urlOrId=val('admUrl').trim();
    const m=urlOrId.match(/spreadsheets\/d\/([a-zA-Z0-9-_]+)/);
    const sheetId=m?m[1]:urlOrId;
    const readCol=(val('admReadCol').trim()||'C').toUpperCase();
    if(!sheetId)throw new Error('ìŠ¤í”„ë ˆë“œì‹œíŠ¸ ë§í¬/IDë¥¼ ì…ë ¥í•˜ì„¸ìš”.');
    const titles=await listSheets(sheetId);
    const pack={id:`${Date.now()}_${Math.random().toString(36).slice(2,7)}`,label,sheetId,readCol,sheets:titles};
    addPack(pack);
    ['admLabel','admUrl'].forEach(id=>{const el=$$(id);if(el)el.value='';});
    const rc=$$('admReadCol');if(rc)rc.value='C';
    renderAdmList();populatePacks('A');populatePacks('B');
    alert('ì—°ê²° ì™„ë£Œ! ê° íŒ¨ë„ì—ì„œ ì„ íƒí•˜ì„¸ìš”.');
  }catch(e){txt('admErr',e.message);}
  finally{admBusy=false;}
}
function renderAdmList(){
  const list=loadPacks();const tb=$$('admList');if(!tb)return;tb.innerHTML='';
  if(!list.length){tb.innerHTML='<tr><td colspan="4" style="color:#64748b">ì—†ìŒ</td></tr>';txt('admMeta','');return;}
  list.forEach(p=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${p.label}</td><td>${p.sheets?.length||0}</td><td>${p.readCol}</td><td><button class="btn" data-del="${p.id}" type="button">ì‚­ì œ</button></td>`;
    tb.appendChild(tr);
  });
  tb.querySelectorAll('button[data-del]').forEach(b=>b.addEventListener('click',e=>{
    removePack(e.target.getAttribute('data-del'));renderAdmList();populatePacks('A');populatePacks('B');
  }));
  txt('admMeta',`ì´ ${list.length}ê°œ ì—°ê²° Â· ${new Date().toLocaleString()}`);
}

/* ===== ì‹œíŠ¸ ì…€ë ‰íŠ¸ ===== */
function populatePacks(sfx){
  const packs=loadPacks();const sel=byPanel('sheetPackSelect',sfx);if(!sel)return;sel.innerHTML='';
  const readSel=byPanel('readSheetSelect',sfx);
  if(!packs.length){
    sel.appendChild(new Option('(ìŠ¤í”„ë ˆë“œì‹œíŠ¸ ì—°ê²°)',''));
    if(readSel)readSel.innerHTML='';
    return;
  }
  sel.appendChild(new Option('ìŠ¤í”„ë ˆë“œì‹œíŠ¸ ì„ íƒ',''));
  packs.forEach(p=>sel.appendChild(new Option(p.label,p.id)));
  const prev=sessionStorage.getItem('ca_prev_pack_'+sfx);
  if(prev){const o=[...sel.options].find(x=>x.value===prev);if(o)o.selected=true;}
  onPackChanged(sfx);
}
async function refreshMeta(sfx){
  try{
    const sel=byPanel('sheetPackSelect',sfx);if(!sel)return;
    const id=sel.value;if(!id)return;
    const packs=loadPacks();const idx=packs.findIndex(p=>p.id===id);if(idx<0)return;
    const titles=await listSheets(packs[idx].sheetId);
    packs[idx].sheets=titles;savePacks(packs);onPackChanged(sfx);
  }catch(e){txt('err'+sfx,'ì‹œíŠ¸ ëª©ë¡ ê°±ì‹  ì‹¤íŒ¨: '+e.message);}
}
function onPackChanged(sfx){
  const sel=byPanel('sheetPackSelect',sfx);if(!sel)return;
  const id=sel.value;sessionStorage.setItem('ca_prev_pack_'+sfx,id||'');
  const packs=loadPacks();const p=packs.find(x=>x.id===id);
  const readSel=byPanel('readSheetSelect',sfx);
  if(readSel)readSel.innerHTML='';
  if(!p)return;
  if(readSel)readSel.appendChild(new Option('ì½ê¸° ì‹œíŠ¸ ì„ íƒ',''));
  (p.sheets||[]).forEach(t=>{if(readSel)readSel.appendChild(new Option(t,t));});
}

/* ===== ë“œë¼ì´ë¸Œ í´ë” / íŒŒì¼ ===== */
let driveFolderId={A:null,B:null};
let driveFiles={A:[],B:[]};

function extractDriveFolderId(input){
  const s=String(input||'').trim();if(!s)return'';
  const m=s.match(/folders\/([a-zA-Z0-9_-]+)/);
  if(m)return m[1];
  return s;
}
async function getDriveFolderName(folderId){
  requireAuth();
  const url=`https://www.googleapis.com/drive/v3/files/${encodeURIComponent(folderId)}?fields=name`;
  const res=await fetch(url,{headers:{Authorization:'Bearer '+accessToken}});
  if(!res.ok)throw new Error(await res.text());
  const data=await res.json();
  return data.name||folderId;
}
async function pickDriveFolder(sfx){
  try{
    const input=prompt('êµ¬ê¸€ ë“œë¼ì´ë¸Œ í´ë” URL ë˜ëŠ” IDë¥¼ ì…ë ¥í•˜ì„¸ìš”.','');
    if(!input)return;
    const id=extractDriveFolderId(input);
    if(!id)throw new Error('í´ë” IDë¥¼ ì¸ì‹í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
    driveFolderId[sfx]=id;
    await refreshDriveList(sfx);
  }catch(e){
    alert('ë“œë¼ì´ë¸Œ í´ë” ì„¤ì • ì‹¤íŒ¨: '+e.message);
    console.error(e);
  }
}
async function listDriveTxtFiles(folderId){
  requireAuth();
  const q=`'${folderId}' in parents and (mimeType='text/plain' or mimeType='text/csv') and trashed=false`;
  const url=`https://www.googleapis.com/drive/v3/files?q=${encodeURIComponent(q)}&fields=files(id,name,modifiedTime,size)&orderBy=modifiedTime desc&pageSize=1000`;
  const res=await fetch(url,{headers:{Authorization:'Bearer '+accessToken}});
  if(!res.ok)throw new Error(await res.text());
  const data=await res.json();
  return data.files||[];
}
async function refreshDriveList(sfx){
  const sel=byPanel('dirFileSelect',sfx);
  const nameSpan=byPanel('dirName',sfx);
  driveFiles[sfx]=[];
  if(sel)sel.innerHTML='';
  const folderId=driveFolderId[sfx];
  if(!folderId){
    if(nameSpan){nameSpan.textContent='';nameSpan.classList.remove('connected');}
    if(sel)sel.appendChild(new Option('(ë“œë¼ì´ë¸Œ í´ë” ì—°ê²°)',''));
    return;
  }
  try{
    const files=await listDriveTxtFiles(folderId);
    driveFiles[sfx]=files.map(f=>({id:f.id,name:f.name,size:f.size||0,mtime:f.modifiedTime?Date.parse(f.modifiedTime):0}));
    if(nameSpan){
      let displayName=folderId;
      try{displayName=await getDriveFolderName(folderId);}catch(e){console.warn('í´ë” ì´ë¦„ ì¡°íšŒ ì‹¤íŒ¨',e);}
      nameSpan.textContent=displayName;
      nameSpan.classList.add('connected');
    }
    if(sel){
      sel.appendChild(new Option('í´ë” ë‚´ íŒŒì¼ ì„ íƒ',''));
      driveFiles[sfx].forEach((f,idx)=>sel.appendChild(new Option(f.name,String(idx))));
    }
  }catch(e){
    if(nameSpan){nameSpan.textContent='';nameSpan.classList.remove('connected');}
    if(sel)sel.appendChild(new Option('(ë“œë¼ì´ë¸Œ ì ‘ê·¼ ì˜¤ë¥˜)',''));
    console.error(e);
    alert('ë“œë¼ì´ë¸Œ íŒŒì¼ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤: '+e.message);
  }
}

/* âœ… txt / csv ì½ê¸° : csvëŠ” Cì—´ë§Œ */
async function readSelectedTxt(sfx){
  const idxStr=val('dirFileSelect',sfx);
  if(!idxStr)throw new Error('í´ë” ë‚´ íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”.');
  const info=driveFiles[sfx][Number(idxStr)];
  if(!info)throw new Error('ì„ íƒí•œ íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');

  requireAuth();
  const url=`https://www.googleapis.com/drive/v3/files/${encodeURIComponent(info.id)}?alt=media`;
  const res=await fetch(url,{headers:{Authorization:'Bearer '+accessToken}});
  if(!res.ok)throw new Error(await res.text());

  const raw=await res.text();

  // csvë©´ Cì—´(3ë²ˆì§¸ ì—´)ë§Œ ì¤„ ë‹¨ìœ„ë¡œ ì¶”ì¶œ
  if(info.name.toLowerCase().endsWith('.csv')){
    const lines=raw.split(/\r?\n/);
    const colC=[];
    for(let i=0;i<lines.length;i++){
      const line=lines[i];
      if(!line.trim())continue;
      const cells=line.split(',');
      if(cells.length<3)continue;
      let cell=cells[2].trim();
      if(cell.startsWith('"')&&cell.endsWith('"')){
        cell=cell.slice(1,-1);
      }
      if(cell)colC.push(cell);
    }
    return colC.join('\n');
  }

  // txtëŠ” ê·¸ëŒ€ë¡œ
  return raw;
}

/* ===== ì¹´í†¡ íŒŒì‹± ===== */
const JOIN_PAT=/(.*?)ë‹˜ì´\s*(ì…ì¥í•˜ì…¨ìŠµë‹ˆë‹¤|ë“¤ì–´ì™”ìŠµë‹ˆë‹¤|ì…ì¥í–ˆìŠµë‹ˆë‹¤|ë“¤ì–´ì˜¤ì…¨ìŠµë‹ˆë‹¤)[\s\.\!]*$/;
const LEAVE_PAT=/(.*?)ë‹˜ì´\s*(í‡´ì¥í•˜ì…¨ìŠµë‹ˆë‹¤|ë‚˜ê°”ìŠµë‹ˆë‹¤|í‡´ì¥í–ˆìŠµë‹ˆë‹¤|ë‚˜ê°€ì…¨ìŠµë‹ˆë‹¤)[\s\.\!]*$/;
const KICK_PAT=/(.*?)ë‹˜ì„\s*(ë‚´ë³´ëƒˆìŠµë‹ˆë‹¤|ê°•í‡´í–ˆìŠµë‹ˆë‹¤|ì¶”ë°©í–ˆìŠµë‹ˆë‹¤)[\s\.\!]*$/;

function splitNickname(nick){
  const raw=String(nick||'').trim();
  if(!raw)return null;
  const idx=raw.search(/\d/);
  let namePart=idx>=0?raw.slice(0,idx):raw;
  let name=namePart.replace(/[/_\-\s]+$/,'');
  name=normalizeName(name);
  if(!name)return{name:raw,digits:null};
  const digitsAll=raw.replace(/[^\d]/g,'');
  const digits=digitsAll.length>=4?digitsAll.slice(-4):null;
  return{name,digits};
}
function parseChat(text){
  const lines=text.split(/\r?\n/);
  const events=[];let joinedCount=0,leftCount=0;
  for(const raw of lines){
    const line=raw.trim();if(!line)continue;
    let m=line.match(JOIN_PAT);if(m){events.push({type:'join',nick:m[1].trim(),raw:line});joinedCount++;continue;}
    m=line.match(LEAVE_PAT);if(m){events.push({type:'leave',nick:m[1].trim(),raw:line});leftCount++;continue;}
    m=line.match(KICK_PAT);if(m){events.push({type:'leave',nick:m[1].trim(),raw:line});leftCount++;continue;}
  }
  return{events,joinedCount,leftCount};
}

/* ===== ì‹¤í–‰ ===== */
async function runMain(sfx){
  try{
    txt('err','',sfx);
    const resultsEl=byPanel('results',sfx);if(resultsEl)resultsEl.innerHTML='';
    const previewOnly=byPanel('previewOnly',sfx)?.checked;

    const chatText=await readSelectedTxt(sfx);
    const packSel=byPanel('sheetPackSelect',sfx);if(!packSel||!packSel.value)throw new Error('ìŠ¤í”„ë ˆë“œì‹œíŠ¸ë¥¼ ì„ íƒí•˜ì„¸ìš”.');
    const readSheet=val('readSheetSelect',sfx);if(!readSheet)throw new Error('ì½ê¸° ì‹œíŠ¸ë¥¼ ì„ íƒí•˜ì„¸ìš”.');
    const writeSheet=FIXED_WRITE_SHEET;

    const packs=loadPacks();const pack=packs.find(x=>x.id===packSel.value);if(!pack)throw new Error('ì—°ê²° ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
    const sheetId=pack.sheetId;const readCol=pack.readCol||'C';

    const {events,joinedCount,leftCount}=parseChat(chatText);

    const NAME_ONLY_SENTINEL='__NAMEONLY__';
    const activeDigitsByName=new Map();
    const leftFinalDigitsByName=new Map();
    const nameOnlyJoin=new Set();
    const ensure=(map,key)=>{if(!map.has(key))map.set(key,new Set());return map.get(key);};

    for(const ev of events){
      const s=splitNickname(ev.nick);
      if(!s)continue;
      const nN=s.name;
      if(ev.type==='join'){
        ensure(activeDigitsByName,nN).add(s.digits||NAME_ONLY_SENTINEL);
        if(leftFinalDigitsByName.has(nN)){
          const L=leftFinalDigitsByName.get(nN);
          L.delete(s.digits||NAME_ONLY_SENTINEL);
          if(L.size===0)leftFinalDigitsByName.delete(nN);
        }
        if(!s.digits)nameOnlyJoin.add(nN);
      }else{
        const A=ensure(activeDigitsByName,nN);
        if(s.digits)A.delete(s.digits);
        else if(A.size===1&&A.has(NAME_ONLY_SENTINEL))A.delete(NAME_ONLY_SENTINEL);
        ensure(leftFinalDigitsByName,nN).add(s.digits||NAME_ONLY_SENTINEL);
      }
    }

    const readNames=await getRange(sheetId,`${readSheet}!${readCol}${READ_START_ROW}:${readCol}`);
    const readRows=readNames.values||[];
    const rosterNames=[];const rosterNamesN=[];const rosterSetN=new Set();
    for(let i=0;i<readRows.length;i++){
      const nm=String(readRows[i]?.[0]??'').trim();
      if(!nm)continue;
      const nN=normalizeName(nm);
      rosterNames.push(nm);
      rosterNamesN.push(nN);
      rosterSetN.add(nN);
    }

    const wAtoE=await getRange(sheetId,`${writeSheet}!A${WRITE_START_ROW}:E`);
    const wRowsAE=wAtoE.values||[];
    const earliestByKey=new Map();
    const earliestByName=new Map();
    for(const r of wRowsAE){
      const id=(r[0]??'').toString().trim();
      const nameRaw=(r[3]??'').toString().trim();
      const phoneRaw=(r[4]??'').toString().trim();
      if(!id||!nameRaw)continue;
      const nN=normalizeName(nameRaw);
      const p4=last4Digits(phoneRaw);
      if(p4){
        const key=nN+'|'+p4;
        if(!earliestByKey.has(key))earliestByKey.set(key,{id,phoneFull:phoneRaw,phone4:p4});
        else{
          const cur=earliestByKey.get(key);
          earliestByKey.set(key,earlierId(cur.id,id)===cur.id?cur:{id,phoneFull:phoneRaw,phone4:p4});
        }
      }
      if(!earliestByName.has(nN))earliestByName.set(nN,{id,phoneFull:phoneRaw,phone4:p4});
      else{
        const cur=earliestByName.get(nN);
        earliestByName.set(nN,earlierId(cur.id,id)===cur.id?cur:{id,phoneFull:phoneRaw,phone4:p4});
      }
    }

    const isAttendingNameN=nN=>{
      const set=activeDigitsByName.get(nN);
      return(set&&set.size>0)||nameOnlyJoin.has(nN);
    };
    const attendingSetN=new Set([...rosterSetN].filter(nN=>isAttendingNameN(nN)));

    const report=[];
    for(let i=0;i<rosterNames.length;i++){
      const nm=rosterNames[i];
      const nN=rosterNamesN[i];
      const phoneFull=earliestByName.get(nN)?.phoneFull||'';
      const set=activeDigitsByName.get(nN)||new Set();
      const any4=[...set].find(x=>x!==NAME_ONLY_SENTINEL)||'';
      const matchedId=
        any4&&earliestByKey.get(nN+'|'+any4)?earliestByKey.get(nN+'|'+any4).id:
        earliestByName.get(nN)?.id||'';
      const notes=(isAttendingNameN(nN)&&!any4)?'(ë²ˆí˜¸ì—†ìŒ)':'';
      const status=attendingSetN.has(nN)?'ì…ì¥':'ë¯¸ì…ì¥';
      const rosterNo=matchedId;
      report.push([rosterNo,nm,phoneFull,status,any4?`${nm}/${any4}`:(status==='ì…ì¥'?nm:''),notes]);
    }

    const extra=[];
    [...activeDigitsByName.entries()].sort(([a],[b])=>a.localeCompare(b,'ko')).forEach(([nN,set])=>{
      if(!rosterSetN.has(nN)){
        const digits=[...set].filter(x=>x!==NAME_ONLY_SENTINEL);
        if(digits.length)digits.forEach(d=>extra.push([`${nN}/${d}`]));
        if(set.has(NAME_ONLY_SENTINEL))extra.push([`${nN}(ë²ˆí˜¸ì—†ìŒ)`]);
      }
    });

    const leavers=[];
    [...leftFinalDigitsByName.entries()].sort(([a],[b])=>a.localeCompare(b,'ko')).forEach(([nN,set])=>{
      const activeSet=activeDigitsByName.get(nN);
      set.forEach(d=>{
        if(!activeSet||!activeSet.has(d)){
          if(d===NAME_ONLY_SENTINEL)leavers.push([`${nN}(ë²ˆí˜¸ì—†ìŒ)`]);
          else leavers.push([`${nN}/${d}`]);
        }
      });
    });

    const readWriteRange=`${writeSheet}!D${WRITE_START_ROW}:T`;
    const wdata=await getRange(sheetId,readWriteRange);
    const rows=wdata.values||[];
    const targetRowsIdx=[];
    const nameCountN=new Map();
    for(let i=0;i<rows.length;i++){
      const r=rows[i]||[];
      const tVal=(r[16]??'').toString().trim(); // Tì—´
      if(tVal!=='ìˆ˜ê°•ìƒ')continue;
      const nameN=normalizeName(String(r[0]??'')); // D
      if(!nameN)continue;
      targetRowsIdx.push(i);
      nameCountN.set(nameN,(nameCountN.get(nameN)||0)+1);
    }
    const updates=[];
    const unresolved=[];
    for(const i of targetRowsIdx){
      const r=rows[i]||[];
      const nameRaw=String(r[0]??'').trim();
      const nameN=normalizeName(nameRaw);
      const phone4=last4Digits(r[1]??'');
      if(!nameN)continue;
      if(!attendingSetN.has(nameN))continue;
      const set=activeDigitsByName.get(nameN)||new Set();
      const isDupInPaid=(nameCountN.get(nameN)||0)>1;
      let canWrite=false;
      if(isDupInPaid){
        if(phone4&&set.has(phone4))canWrite=true;
        else{
          if(set.has(NAME_ONLY_SENTINEL))unresolved.push([nameRaw,'ê³µìœ ì‹œíŠ¸ ë™ëª…ì´ì¸ + ì…ì¥ë¡œê·¸ ë²ˆí˜¸ì—†ìŒ']);
          else unresolved.push([nameRaw,'ê³µìœ ì‹œíŠ¸ ë™ëª…ì´ì¸ + ë²ˆí˜¸ë¶ˆì¼ì¹˜']);
        }
      }else{
        if(set.size>=1||set.has(NAME_ONLY_SENTINEL))canWrite=true;
      }
      if(canWrite){
        const rowNumber=WRITE_START_ROW+i;
        updates.push({range:`${writeSheet}!S${rowNumber}`,values:[['ì…ì¥']]});
      }
    }

    if(updates.length&&!previewOnly){
      await batchUpdateValues(sheetId,updates);
    }

    const pills=$$('#pills'+sfx+sfx);
    if(pills){
      pills.innerHTML='';
      const mk=(t,c)=>{const s=document.createElement('span');s.className='pill '+c;s.textContent=t;return s;};
      pills.appendChild(mk(`ì…ì¥ë¡œê·¸ join ${joinedCount}`,'ok'));
      pills.appendChild(mk(`í‡´ì¥ë¡œê·¸ leave ${leftCount}`,'bad'));
      pills.appendChild(mk(`ì…ì¥ ëŒ€ìƒ(ì½ê¸°ì‹œíŠ¸) ${attendingSetN.size}`,'warn'));
      if(previewOnly)pills.appendChild(mk('ì²´í¬ë§Œ','warn'));
    }

    function resTbl(title,headers,rowsArr){
      if(!resultsEl)return;
      const wrap=document.createElement('div');wrap.className='card';
      const h=document.createElement('h3');h.textContent=title;h.style.margin='0 0 8px';wrap.appendChild(h);
      const t=document.createElement('table');const thead=document.createElement('thead');const trh=document.createElement('tr');
      headers.forEach(x=>{const th=document.createElement('th');th.textContent=x;trh.appendChild(th);});
      thead.appendChild(trh);t.appendChild(thead);
      const tb=document.createElement('tbody');
      (rowsArr||[]).forEach(r=>{const tr=document.createElement('tr');(r||[]).forEach(c=>{const td=document.createElement('td');td.textContent=(c==null?'':String(c));tr.appendChild(td);});tb.appendChild(tr);});
      t.appendChild(tb);wrap.appendChild(t);resultsEl.appendChild(wrap);
    }
    resTbl('ë‚´ ëª…ë‹¨ ê¸°ì¤€ ìƒíƒœ(ì½ê¸° ì‹œíŠ¸)',['no','name','phone','status','matched_id','notes'],report);
    resTbl('ëª…ë‹¨ ì™¸ ì…ì¥ì',['name/last4 or (ë²ˆí˜¸ì—†ìŒ)'],extra);
    resTbl('í‡´ì¥ì ëª…ë‹¨(ìµœì¢…)',['name/last4 or (ë²ˆí˜¸ì—†ìŒ)'],leavers);
    resTbl(previewOnly?'ì˜ˆìƒ ê°±ì‹  ê²°ê³¼(ì²´í¬ë§Œ ëª¨ë“œ)':'ê³µìœ  ì‹œíŠ¸ ê°±ì‹  ê²°ê³¼',['updated_cells'],updates.map(u=>[u.range+' â† ì…ì¥']));
    resTbl('ë¯¸í™•ì¸ ëª©ë¡(ê³µìœ  ì‹œíŠ¸ ë™ëª…ì´ì¸/ë²ˆí˜¸ ë¬¸ì œ)',['name','reason'],unresolved);

  }catch(e){
    txt('err','ì˜¤ë¥˜: '+(e?.message||e),sfx);
    console.error(e);
  }
}

/* ===== ë°ëª¨ ===== */
function runDemo(sfx){
  txt('err','',sfx);
  const resultsEl=byPanel('results',sfx);
  if(resultsEl)resultsEl.innerHTML='';

  const roster=[
    {id:1,name:'í™©í˜„í•˜',phone:'010-1234-5678'},
    {id:3,name:'ê¹€í˜œì˜',phone:'010-3456-7890'},
    {id:4,name:'ì„ê·œë¦¬',phone:'010-1717-1771'},
    {id:5,name:'ê¹€ì˜ˆì€',phone:'010-1111-0000'},
    {id:6,name:'ë°©ì˜ˆì§„',phone:'010-0000-9999'},
  ];
  const rosterSetN=new Set(roster.map(r=>normalizeName(r.name)));
  const chatText=[
    'ê¹€ì˜ˆì€/0000ë‹˜ì´ ì…ì¥í•˜ì…¨ìŠµë‹ˆë‹¤',
    'í™©í˜„í•˜/5678ë‹˜ì´ ì…ì¥í•˜ì…¨ìŠµë‹ˆë‹¤',
    'ë°©ì˜ˆì§„/9999ë‹˜ì´ ì…ì¥í–ˆìŠµë‹ˆë‹¤',
    'ì„ê·œë¦¬ 1771ë‹˜ì´ ë“¤ì–´ì™”ìŠµë‹ˆë‹¤',
    'ê¹€í˜œì˜/7890ë‹˜ì´ ì…ì¥í•˜ì…¨ìŠµë‹ˆë‹¤',
    'ì§„ì¢…ë²”/2514ë‹˜ì´ ì…ì¥í•˜ì…¨ìŠµë‹ˆë‹¤',
    'ë§¤ë“œë“œë¼ì´ë²„ê¹€ì§€í˜„ë‹˜ì´ ì…ì¥í•˜ì…¨ìŠµë‹ˆë‹¤',
    'ì„¸ê³„ì œì¼ì˜ê·œë¦¬ë‹¹ì¥ì°¬ì–‘ë‹˜ì´ ë‚˜ê°”ìŠµë‹ˆë‹¤.',
    'ì†¡ì§€í˜„ì˜ˆì˜ë‹¤ë‹˜ì„ ë‚´ë³´ëƒˆìŠµë‹ˆë‹¤.'
  ].join('\n');
  const {events,joinedCount,leftCount}=parseChat(chatText);
  const NAME_ONLY_SENTINEL='__NAMEONLY__';
  const active=new Map();const leftFinal=new Map();
  const ensure=(map,key)=>{if(!map.has(key))map.set(key,new Set());return map.get(key);};
  for(const ev of events){
    const s=splitNickname(ev.nick);if(!s)continue;
    const nN=s.name;
    if(ev.type==='join'){
      ensure(active,nN).add(s.digits||NAME_ONLY_SENTINEL);
      const L=leftFinal.get(nN);if(L){L.delete(s.digits||NAME_ONLY_SENTINEL);if(L.size===0)leftFinal.delete(nN);}
    }else{
      const A=ensure(active,nN);
      if(s.digits)A.delete(s.digits);
      else if(A.size===1&&A.has(NAME_ONLY_SENTINEL))A.delete(NAME_ONLY_SENTINEL);
      ensure(leftFinal,nN).add(s.digits||NAME_ONLY_SENTINEL);
    }
  }
  const paidRows=[
    {name:'ê¹€ì˜ˆì€',phone4:'0000'},
    {name:'ë°©ì˜ˆì§„',phone4:'9999'},
    {name:'í™©í˜„í•˜',phone4:'5678'},
    {name:'í™©í˜„í•˜',phone4:'9999'},
    {name:'ê¹€í˜œì˜',phone4:''},
  ];
  const paidNameCountN=new Map();
  for(const r of paidRows){
    const nN=normalizeName(r.name);
    paidNameCountN.set(nN,(paidNameCountN.get(nN)||0)+1);
  }
  const report=[];
  for(const r of roster){
    const nN=normalizeName(r.name);
    const set=active.get(nN)||new Set();
    const isActive=set.size>0;
    const any4=[...set].find(x=>x!==NAME_ONLY_SENTINEL)||'';
    report.push([String(r.id),r.name,r.phone,isActive?'ì…ì¥':'ë¯¸ì…ì¥',isActive?(any4?`${r.name}/${any4}`:r.name):'',isActive&&!any4?'(ë²ˆí˜¸ì—†ìŒ)':'']);
  }
  const extra=[];
  [...active.entries()].sort(([a],[b])=>a.localeCompare(b,'ko')).forEach(([nN,set])=>{
    if(!rosterSetN.has(nN)){
      const digits=[...set].filter(x=>x!==NAME_ONLY_SENTINEL);
      if(digits.length)digits.forEach(d=>extra.push([`${nN}/${d}`]));
      if(set.has(NAME_ONLY_SENTINEL))extra.push([`${nN}(ë²ˆí˜¸ì—†ìŒ)`]);
    }
  });
  const leavers=[];
  [...leftFinal.entries()].sort(([a],[b])=>a.localeCompare(b,'ko')).forEach(([nN,set])=>{
    const act=active.get(nN);
    set.forEach(d=>{if(!act||!act.has(d))leavers.push([d===NAME_ONLY_SENTINEL?`${nN}(ë²ˆí˜¸ì—†ìŒ)`:`${nN}/${d}`]);});
  });
  const unresolved=[];
  for(const r of paidRows){
    const nN=normalizeName(r.name);
    const set=active.get(nN)||new Set();
    const isDupInPaid=(paidNameCountN.get(nN)||0)>1;
    if(!isDupInPaid)continue;
    const p4=(r.phone4||'').trim();
    if(p4&&set.has(p4))continue;
    unresolved.push([r.name,p4?'ê³µìœ ì‹œíŠ¸ ë™ëª…ì´ì¸ + ë²ˆí˜¸ë¶ˆì¼ì¹˜':'ê³µìœ ì‹œíŠ¸ ë™ëª…ì´ì¸ + ì…ì¥ë¡œê·¸ ë²ˆí˜¸ì—†ìŒ']);
  }
  const pills=$$('#pills'+sfx+sfx);
  if(pills){
    pills.innerHTML='';
    const mk=(t,c)=>{const s=document.createElement('span');s.className='pill '+c;s.textContent=t;return s;};
    const attendingCount=roster.filter(r=>(active.get(normalizeName(r.name))||new Set()).size>0).length;
    pills.appendChild(mk(`ì…ì¥ë¡œê·¸ join ${joinedCount}`,'ok'));
    pills.appendChild(mk(`í‡´ì¥ë¡œê·¸ leave ${leftCount}`,'bad'));
    pills.appendChild(mk(`ì…ì¥ ëŒ€ìƒ(ì½ê¸°ì‹œíŠ¸) ${attendingCount}`,'warn'));
    pills.appendChild(mk('ì²´í¬ë§Œ','warn'));
  }
  function resTbl(title,headers,rowsArr){
    if(!resultsEl)return;
    const wrap=document.createElement('div');wrap.className='card';
    const h=document.createElement('h3');h.textContent=title;h.style.margin='0 0 8px';wrap.appendChild(h);
    const t=document.createElement('table');const thead=document.createElement('thead');const trh=document.createElement('tr');
    headers.forEach(x=>{const th=document.createElement('th');th.textContent=x;trh.appendChild(th);});
    thead.appendChild(trh);t.appendChild(thead);
    const tb=document.createElement('tbody');
    (rowsArr||[]).forEach(r=>{const tr=document.createElement('tr');(r||[]).forEach(c=>{const td=document.createElement('td');td.textContent=(c==null?'':String(c));tr.appendChild(td);});tb.appendChild(tr);});
    t.appendChild(tb);wrap.appendChild(t);resultsEl.appendChild(wrap);
  }
  resTbl('ëª…ë‹¨ê¸°ì¤€ ì…ì¥ì(ë°ëª¨)',['no','name','phone','status','matched_id','notes'],report);
  resTbl('ëª…ë‹¨ ì™¸ ì…ì¥ì(ë°ëª¨)',['name/last4 or (ë²ˆí˜¸ì—†ìŒ)'],extra);
  resTbl('í‡´ì¥ì ëª…ë‹¨(ë°ëª¨)',['name/last4 or (ë²ˆí˜¸ì—†ìŒ)'],leavers);
  resTbl('ë¯¸í™•ì¸ ëª©ë¡(ë°ëª¨)',['name','reason'],unresolved);
}

/* ===== ì´ˆê¸°í™” ===== */
window.addEventListener('load',()=>{if(window.google?.accounts?.oauth2)initAuth();});
document.addEventListener('DOMContentLoaded',()=>{
  on('gsLoginBtn','click',requestAccess);
  on('gsLogoutBtn','click',revokeAccess);

  // ê¸°ëŠ¥ ë²„íŠ¼: ì¼ë‹¨ ì…ì¥ì ì²´í¬ë§Œ í™œì„±
  const btnEntrant=$$('featureBtnEntrant');
  if(btnEntrant){
    btnEntrant.addEventListener('click',()=>{
      showFeatureSection('entrant');
    });
  }

  const overlay=$$('adminOverlay'),drawer=$$('adminDrawer');
  const openAdmin=()=>{if(overlay&&drawer){show(overlay);show(drawer);renderAdmList();}};
  const closeAdmin=()=>{if(overlay&&drawer){hide(overlay);hide(drawer);}};
  on('settingsBtn','click',openAdmin);
  on('closeAdmin','click',closeAdmin);
  if(overlay)overlay.addEventListener('click',closeAdmin);

  on('admAdd','click',admAdd);
  on('admClearAll','click',()=>{if(confirm('ëª¨ë“  ì—°ê²°ì„ ì‚­ì œí• ê¹Œìš”?')){clearPacks();renderAdmList();populatePacks('A');populatePacks('B');}});

  // Panel A
  on('sheetPackSelect','change',()=>onPackChanged('A'),'A');
  on('refreshMeta','click',()=>refreshMeta('A'),'A');
  on('runBtn','click',()=>runMain('A'),'A');
  on('demoBtn','click',()=>runDemo('A'),'A');
  on('dirPick','click',()=>pickDriveFolder('A'),'A');
  on('dirRefresh','click',()=>refreshDriveList('A'),'A');

  // Panel B
  on('sheetPackSelect','change',()=>onPackChanged('B'),'B');
  on('refreshMeta','click',()=>refreshMeta('B'),'B');
  on('runBtn','click',()=>runMain('B'),'B');
  on('demoBtn','click',()=>runDemo('B'),'B');
  on('dirPick','click',()=>pickDriveFolder('B'),'B');
  on('dirRefresh','click',()=>refreshDriveList('B'),'B');

  populatePacks('A');
  populatePacks('B');
  refreshDriveList('A');
  refreshDriveList('B');

  // ì²˜ìŒì—” ê¸°ëŠ¥ ì„¹ì…˜ ëª¨ë‘ ìˆ¨ê¹€
  setFeatureVisibility(false);
});
</script>
</body>
</html>
