<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>í´ì–´ ìš´ì˜ ë“œë¼ì´ë¸Œ</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Google Identity Services (ë¡œê·¸ì¸ìš©) -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>

  <style>
    body { background:#f8fafc; }

    .file-row:hover{background:#f1f5f9}

    /* ì…ì¥ì ì²´í¬ë´‡ ë¡œê³  ìŠ¤íƒ€ì¼ ì°¸ê³  */
    :root{
      --logo-size:108px;
    }
    .brand{display:flex;align-items:center;gap:14px;margin:0 0 6px}
    .brand h1{margin:0;font-size:22px}
    .brand-logo{width:var(--logo-size);height:calc(var(--logo-size)*1.1);flex:0 0 var(--logo-size)}
    .logo-text{
      font-family:'Nunito','Arial Rounded MT','SF Pro Rounded','Quicksand','Pretendard','Noto Sans KR',sans-serif;
      font-weight:900; letter-spacing:-0.2px; fill:#0f172a; font-size:16px;
      paint-order:stroke fill; stroke:#0f172a; stroke-width:.9px;
    }
  </style>
</head>
<body class="min-h-screen text-slate-900">
  <div class="max-w-6xl mx-auto px-4 py-6">
    <!-- í—¤ë” : ì…ì¥ì ì²´í¬ë´‡ ë¡œê³  ì°¸ê³  -->
    <header class="flex items-center justify-between mb-6 gap-4">
      <div class="brand">
        <!-- ê°™ì€ SVG ë¡œê³  -->
        <svg class="brand-logo" viewBox="0 0 90 50" role="img" aria-label="ClassAround">
          <rect width="90" height="50" rx="10" fill="white"/>
          <circle cx="66" cy="10" r="8" fill="#6b8bd6"/>
          <circle cx="80" cy="18" r="5" fill="#ef4444"/>
          <text x="8" y="24" class="logo-text">Class</text>
          <text x="8" y="42" class="logo-text">Around</text>
        </svg>
        <div>
          <p class="text-[11px] text-slate-400 font-semibold"></p>
          <h1 class="text-xl font-bold">í´ì–´ ìš´ì˜ ë“œë¼ì´ë¸Œ</h1>
          <p class="text-[11px] text-slate-500">
          </p>
        </div>
      </div>

      <div id="login-box" class="text-right text-xs text-slate-500 space-y-1">
        <div class="flex items-center gap-2 justify-end">
          <span id="login-status" class="text-[11px] text-slate-500">ë¡œê·¸ì¸ í•„ìš”</span>
          <button id="btn-login"
                  class="px-3 py-1 rounded-full border border-slate-300 text-xs font-medium hover:bg-slate-100">
            Google ë¡œê·¸ì¸
          </button>
        </div>
        <p class="text-[11px] text-slate-400" id="proxy-status">
        </p>
      </div>
    </header>

    <div class="grid grid-cols-[260px,1fr] gap-4">
      <!-- ì™¼ìª½: ë£¨íŠ¸ í´ë” ë¦¬ìŠ¤íŠ¸ -->
      <aside class="bg-white rounded-2xl shadow border border-slate-100 p-4">
        <div class="flex items-center mb-3">
          <span class="text-xl mr-2">ğŸ“‚</span>
          <div>
            <p class="text-sm font-semibold">ë“œë¼ì´ë¸Œ í´ë” ëª¨ìŒ</p>
            <p class="text-xs text-slate-500">
              ì¢Œì¸¡ì—ì„œ í´ë” ì„ íƒ í›„ ìš°ì¸¡ì—ì„œ íŒŒì¼ ë¯¸ë¦¬ë³´ê¸°
            </p>
          </div>
        </div>

        <div id="folder-list" class="space-y-1 text-sm">
          <!-- JSë¡œ í´ë” ë²„íŠ¼ ë Œë”ë§ -->
        </div>
      </aside>

      <!-- ì˜¤ë¥¸ìª½: íŒŒì¼ ë¯¸ë¦¬ë³´ê¸° -->
      <main class="bg-white rounded-2xl shadow border border-slate-100 p-4 flex flex-col">
        <div class="flex items-center justify-between mb-3 gap-3">
          <div class="min-w-0">
            <p class="text-xs text-slate-400">DRIVE FOLDER VIEW</p>
            <p id="current-folder-title" class="text-base font-semibold mt-1 truncate">
              í´ë”ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”
            </p>
            <p id="current-folder-desc" class="text-xs text-slate-500 truncate">
              ì¢Œì¸¡ì—ì„œ í´ë”ë¥¼ í´ë¦­í•˜ë©´ ì´ ì˜ì—­ì— íŒŒì¼ ëª©ë¡ì´ í‘œì‹œë©ë‹ˆë‹¤.
            </p>
          </div>
          <div class="flex items-center gap-2">
            <!-- ê²€ìƒ‰ ì¸í’‹ -->
            <div class="relative">
              <input
                id="search-input"
                type="text"
                placeholder="íŒŒì¼ëª… ê²€ìƒ‰"
                class="pl-7 pr-2 py-1.5 text-xs border border-slate-200 rounded-full bg-slate-50 focus:outline-none focus:ring-1 focus:ring-sky-400 focus:bg-white min-w-[160px]"
              />
              <span class="absolute left-2 top-1.5 text-[13px] text-slate-400">ğŸ”</span>
            </div>
            <button id="btn-open-newtab"
                    class="px-3 py-1 rounded-full border border-slate-200 text-xs text-slate-600 hover:bg-slate-50 disabled:opacity-40 disabled:cursor-not-allowed"
                    disabled>
              ìƒˆ íƒ­ì—ì„œ í´ë” ì—´ê¸°
            </button>
          </div>
        </div>

        <div id="drive-preview"
             class="mt-2 flex-1 border border-slate-100 rounded-xl bg-slate-50 overflow-auto">
          <div class="h-full flex flex-col items-center justify-center text-slate-400 text-sm px-6 text-center">
            <p class="mb-2">ğŸ“ ì™¼ìª½ì—ì„œ í´ë”ë¥¼ ì„ íƒí•˜ë©´ íŒŒì¼ ëª©ë¡ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</p>
            <p class="text-xs">
              ë“œë¼ì´ë¸Œ ê¶Œí•œì€ ê·¸ëŒ€ë¡œ ìœ ì§€ë˜ê³ , ì´ í˜ì´ì§€ì—ì„œëŠ” íŒŒì¼ ì œëª©ë§Œ ë¯¸ë¦¬ ë³´ì—¬ì¤ë‹ˆë‹¤.
            </p>
          </div>
        </div>
      </main>
    </div>
  </div>

  <script>
    // ==============================
    // 1. ì„¤ì •
    // ==============================
    const SCRIPT_URL = 'https://script.google.com/a/macros/classaround.co.kr/s/AKfycby0ixfDg41UDot43MlveRJGP5br-7wFAVvKjxVjPDEE_00JlpSH3sjmUHewuvgnRcxQ/exec';
    const CLIENT_ID = '18228268359-iifm4ck3j9kqj74eh1p90tco1k2mbpi0.apps.googleusercontent.com';

    // ë£¨íŠ¸ í´ë” ëª©ë¡
    const FOLDERS = [
      {
        key: 'card',
        name: 'í˜„ê¸ˆê²°ì œ êµ¬ê¸€í¼',
        desc: 'í˜„ê¸ˆ/ê³„ì¢Œ ê²°ì œ ì‘ë‹µ ëª¨ìŒ',
        id: '1LdDYVwxDrpqpPy2HYlSnrw2w7YKhsKWF'
      },
      {
        key: 'share',
        name: 'ê°•ì‚¬ ê³µìœ ìš© ì‹œíŠ¸',
        desc: 'ê°•ì‚¬ì§„ ê³µìœ  ì‹œíŠ¸ & ìë£Œ',
        id: '1t33dy_UQCfsvoEQ9yOctIxvoT623i-j4'
      },
      {
        key: 'ebook',
        name: 'ë¬´ë£Œê°•ì˜ ì „ìì±… êµ¬ê¸€í¼',
        desc: 'ë¬´ë£Œ ì „ìì±… ì‹ ì²­ ì‘ë‹µ',
        id: '1C1OsgYqZtxauLNN9l4mRHPgaIavrhmq-'
      },
      {
        key: 'qna',
        name: 'ë¬´ë£Œê°•ì˜ ì‚¬ì „ ì§ˆë¬¸',
        desc: 'ë¬´ë£Œê°•ì˜ Q&A / ì‚¬ì „ì§ˆë¬¸ ëª¨ìŒ',
        id: '1BU7ugKEeRXmG3PoRGJqKHlxuVtgT2_js'
      },
      {
        key: 'live',
        name: 'ë¼ì´ë¸Œ ìë£Œ',
        desc: 'ë¼ì´ë¸Œ ë°©ì†¡ ìë£Œ Â· PPT ëª¨ìŒ',
        id: '1Ej6eIw0WwCn8NxtwW5A4vj8wo2xyKATC'
      }
    ];

    // ìƒíƒœ
    let currentFolder = null;     // {id, name, desc}
    let folderStack = [];         // íƒìƒ‰ ê²½ë¡œ [{id,name,desc}, ...]
    let currentFiles = [];        // í˜„ì¬ í´ë”ì˜ íŒŒì¼/í´ë” ì „ì²´
    let currentSearch = '';       // ê²€ìƒ‰ì–´

    let authTokenClient = null;
    let userInfo = null;          // {email,name,picture}

    // ==============================
    // 2. ë¡œê·¸ì¸
    // ==============================
    function setupAuth() {
      if (!window.google || !google.accounts || !google.accounts.oauth2) return;

      authTokenClient = google.accounts.oauth2.initTokenClient({
        client_id: CLIENT_ID,
        scope: 'openid email profile',
        callback: async (tokenResponse) => {
          try {
            const res = await fetch('https://www.googleapis.com/oauth2/v3/userinfo', {
              headers: { Authorization: 'Bearer ' + tokenResponse.access_token }
            });
            const info = await res.json();
            userInfo = {
              email: info.email,
              name: info.name,
              picture: info.picture
            };
          } catch (e) {
            console.error('userinfo error', e);
            userInfo = null;
          }
          updateLoginUI();
        }
      });
    }

    function handleLoginClick() {
      if (!authTokenClient) setupAuth();
      if (!authTokenClient) {
        alert('Google ë¡œê·¸ì¸ ì´ˆê¸°í™” ì¤‘ì…ë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
        return;
      }
      authTokenClient.requestAccessToken({ prompt: '' });
    }

    function handleLogout() {
      userInfo = null;
      updateLoginUI();
    }

    function updateLoginUI() {
      const statusEl = document.getElementById('login-status');
      const btnEl = document.getElementById('btn-login');
      if (!statusEl || !btnEl) return;

      if (userInfo) {
        statusEl.textContent = userInfo.email || 'ë¡œê·¸ì¸ ì™„ë£Œ';
        btnEl.textContent = 'ë¡œê·¸ì•„ì›ƒ';
        btnEl.onclick = handleLogout;
      } else {
        statusEl.textContent = 'ë¡œê·¸ì¸ í•„ìš”';
        btnEl.textContent = 'Google ë¡œê·¸ì¸';
        btnEl.onclick = handleLoginClick;
      }
    }

    function requireLogin() {
      if (!userInfo) {
        alert('ë¨¼ì € ì˜¤ë¥¸ìª½ ìƒë‹¨ì—ì„œ Google ë¡œê·¸ì¸ì„ í•´ì£¼ì„¸ìš”.');
        return false;
      }
      return true;
    }

    // ==============================
    // 3. í´ë” ë²„íŠ¼ ë Œë”ë§
    // ==============================
    function renderFolderList() {
      const listEl = document.getElementById('folder-list');
      listEl.innerHTML = '';

      FOLDERS.forEach(folder => {
        const btn = document.createElement('button');
        btn.className =
          'w-full text-left px-3 py-2 rounded-xl border border-slate-100 bg-slate-50 ' +
          'hover:border-sky-300 text-sm flex items-center justify-between transition';
        btn.innerHTML = `
          <div>
            <div class="font-medium">${folder.name}</div>
            <div class="text-[11px] text-slate-500">${folder.desc}</div>
          </div>
          <span class="text-[11px] px-2 py-0.5 rounded-full bg-white border border-slate-200">ì—´ê¸°</span>
        `;
        btn.onclick = () => onRootFolderClick(folder);
        listEl.appendChild(btn);
      });
    }

    // ==============================
    // 4. í´ë” íƒìƒ‰ (ë£¨íŠ¸/í•˜ìœ„)
    // ==============================
    function onRootFolderClick(folder) {
      if (!requireLogin()) return;

      currentFolder = { id: folder.id, name: folder.name, desc: folder.desc };
      folderStack = [currentFolder];
      currentFiles = [];
      currentSearch = '';
      const searchInput = document.getElementById('search-input');
      if (searchInput) searchInput.value = '';

      updateFolderHeader();
      updateOpenNewTabButton();
      loadCurrentFolder();
    }

    function enterSubfolder(file) {
      if (!file || !file.id) return;
      currentFolder = { id: file.id, name: file.name, desc: currentFolder.desc };
      folderStack.push(currentFolder);
      currentFiles = [];
      currentSearch = '';
      const searchInput = document.getElementById('search-input');
      if (searchInput) searchInput.value = '';

      updateFolderHeader();
      updateOpenNewTabButton();
      loadCurrentFolder();
    }

    function goUpFolder() {
      if (folderStack.length <= 1) return;
      folderStack.pop();
      currentFolder = folderStack[folderStack.length - 1];
      currentFiles = [];
      currentSearch = '';
      const searchInput = document.getElementById('search-input');
      if (searchInput) searchInput.value = '';

      updateFolderHeader();
      updateOpenNewTabButton();
      loadCurrentFolder();
    }

    function updateFolderHeader() {
      const titleEl = document.getElementById('current-folder-title');
      const descEl = document.getElementById('current-folder-desc');

      if (!currentFolder) {
        titleEl.textContent = 'í´ë”ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”';
        descEl.textContent = 'ì¢Œì¸¡ì—ì„œ í´ë”ë¥¼ í´ë¦­í•˜ë©´ ì´ ì˜ì—­ì— íŒŒì¼ ëª©ë¡ì´ í‘œì‹œë©ë‹ˆë‹¤.';
        return;
      }

      const pathNames = folderStack.map(f => f.name);
      titleEl.textContent = pathNames.join(' / ');
      descEl.textContent = currentFolder.desc || '';
    }

    function updateOpenNewTabButton() {
      const btn = document.getElementById('btn-open-newtab');
      if (!btn) return;
      if (!currentFolder) {
        btn.disabled = true;
        btn.onclick = null;
        return;
      }
      btn.disabled = false;
      btn.onclick = () => {
        window.open(
          `https://drive.google.com/drive/folders/${currentFolder.id}`,
          '_blank'
        );
      };
    }

    function loadCurrentFolder() {
      if (!currentFolder) return;
      listFilesInFolder(currentFolder.id);
    }

    // ==============================
    // 5. Apps Script í˜¸ì¶œ
    // ==============================
    async function listFilesInFolder(folderId) {
      const previewEl = document.getElementById('drive-preview');
      previewEl.innerHTML = `
        <div class="p-4 text-sm text-slate-500">
          <span class="animate-pulse">íŒŒì¼ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</span>
        </div>
      `;

      try {
        const res = await fetch(
          `${SCRIPT_URL}?folderId=${encodeURIComponent(folderId)}`
        );
        const data = await res.json();

        if (!data.ok) {
          console.error('Apps Script error:', data);
          previewEl.innerHTML = `
            <div class="p-4 text-sm text-red-500 space-y-1">
              <div>íŒŒì¼ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</div>
              <div class="text-xs text-slate-500">
                ${data.error || ''} ${data.message ? 'Â· ' + data.message : ''}
              </div>
            </div>
          `;
          return;
        }

        currentFiles = data.files || [];
        if (!currentFiles.length) {
          previewEl.innerHTML = `
            <div class="p-4 text-sm text-slate-500">
              ì´ í´ë”ì— í‘œì‹œí•  íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.
            </div>
          `;
          return;
        }

        currentSearch = '';
        updateFileList();
      } catch (err) {
        console.error(err);
        previewEl.innerHTML = `
          <div class="p-4 text-sm text-red-500">
            íŒŒì¼ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜ˆì™¸ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. (ë¸Œë¼ìš°ì € ì½˜ì†” í™•ì¸)
          </div>
        `;
      }
    }

    // ==============================
    // 6. ê²€ìƒ‰ + ë¦¬ìŠ¤íŠ¸ ë Œë”ë§
    // ==============================
    function updateFileList() {
      const previewEl = document.getElementById('drive-preview');
      if (!previewEl) return;

      if (!currentFiles.length) {
        previewEl.innerHTML = `
          <div class="p-4 text-sm text-slate-500">
            ì´ í´ë”ì— í‘œì‹œí•  íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.
          </div>
        `;
        return;
      }

      const keyword = currentSearch.trim().toLowerCase();
      const filtered = !keyword
        ? currentFiles
        : currentFiles.filter(f =>
            (f.name || '').toLowerCase().includes(keyword)
          );

      renderFileList(previewEl, filtered, currentFiles.length);
    }

    function renderFileList(containerEl, files, totalCount) {
      containerEl.innerHTML = '';

      const header = document.createElement('div');
      header.className =
        'text-[11px] text-slate-500 px-3 py-2 border-b border-slate-100 bg-slate-50/60 sticky top-0 z-10 flex justify-between items-center';

      const left = document.createElement('span');
      left.textContent = `ì´ ${totalCount ?? files.length}ê°œ Â· ê²€ìƒ‰ ê²°ê³¼ ${files.length}ê°œ`;
      header.appendChild(left);

      const right = document.createElement('div');
      right.className = 'flex items-center gap-2';

      if (folderStack.length > 1) {
        const upBtn = document.createElement('button');
        upBtn.id = 'btn-up-folder';
        upBtn.className =
          'px-2 py-0.5 rounded-full border border-slate-200 bg-white text-[11px] hover:bg-slate-100';
        upBtn.textContent = 'â† ìƒìœ„ í´ë”';
        upBtn.onclick = goUpFolder;
        right.appendChild(upBtn);
      }

      const hint = document.createElement('span');
      hint.textContent = 'íŒŒì¼ í´ë¦­ ì‹œ ìƒˆ íƒ­ì—ì„œ ì—´ë¦½ë‹ˆë‹¤. (í´ë”ëŠ” ë”ë¸”í´ë¦­ìœ¼ë¡œ ì§„ì…)';
      right.appendChild(hint);

      header.appendChild(right);
      containerEl.appendChild(header);

      const list = document.createElement('div');

      files.forEach(file => {
        const isFolder = file.isFolder === true ||
          file.mimeType === 'application/vnd.google-apps.folder';

        const row = document.createElement('div');
        row.className =
          'file-row w-full flex items-center text-left text-sm px-3 py-2 border-b border-slate-100 last:border-b-0';
        if (isFolder) row.classList.add('cursor-pointer');

        const main = document.createElement('div');
        main.className = 'flex-1 min-w-0';

        const nameEl = document.createElement('div');
        nameEl.className = 'truncate font-medium text-slate-800 flex items-center gap-1';
        if (isFolder) {
          const icon = document.createElement('span');
          icon.textContent = 'ğŸ“';
          icon.className = 'text-xs';
          nameEl.appendChild(icon);
        } else {
          const icon = document.createElement('span');
          icon.textContent = 'ğŸ“„';
          icon.className = 'text-xs';
          nameEl.appendChild(icon);
        }
        const nameText = document.createElement('span');
        nameText.textContent = file.name;
        nameEl.appendChild(nameText);
        main.appendChild(nameEl);

        const sub = document.createElement('div');
        sub.className = 'text-[11px] text-slate-500 mt-0.5';
        const date = file.modifiedTime
          ? new Date(file.modifiedTime).toLocaleString()
          : '-';
        sub.textContent = `${file.mimeType || (isFolder ? 'folder' : '')} Â· ìˆ˜ì •: ${date}`;
        main.appendChild(sub);

        row.appendChild(main);

        const sizeEl = document.createElement('div');
        sizeEl.className = 'text-[11px] text-slate-500 ml-3 whitespace-nowrap';
        if (!isFolder && file.size) {
          sizeEl.textContent = formatBytes(Number(file.size));
        } else {
          sizeEl.textContent = isFolder ? '-' : '';
        }
        row.appendChild(sizeEl);

        if (isFolder) {
          // ë”ë¸”í´ë¦­ â†’ í•˜ìœ„ í´ë”ë¡œ ì§„ì…
          row.addEventListener('dblclick', (e) => {
            e.preventDefault();
            e.stopPropagation();
            enterSubfolder(file);
          });
        } else {
          // íŒŒì¼ì€ í•œ ë²ˆ í´ë¦­ìœ¼ë¡œ ì—´ê¸°
          row.addEventListener('click', () => {
            window.open(file.url, '_blank');
          });
        }

        list.appendChild(row);
      });

      containerEl.appendChild(list);
    }

    function formatBytes(bytes) {
      if (!bytes || bytes === 0) return '-';
      const units = ['B', 'KB', 'MB', 'GB', 'TB'];
      const i = Math.floor(Math.log(bytes) / Math.log(1024));
      const value = bytes / Math.pow(1024, i);
      return `${value.toFixed(1)} ${units[i]}`;
    }

    // ==============================
    // 7. onload
    // ==============================
    window.addEventListener('load', () => {
      renderFolderList();
      updateLoginUI();

      const searchInput = document.getElementById('search-input');
      if (searchInput) {
        searchInput.addEventListener('input', (e) => {
          currentSearch = e.target.value || '';
          updateFileList();
        });
        searchInput.addEventListener('keydown', (e) => {
          if (e.key === 'Escape') {
            e.target.value = '';
            currentSearch = '';
            updateFileList();
          }
        });
      }

      // GSI ìŠ¤í¬ë¦½íŠ¸ ë¡œë”© ëŒ€ê¸°
      const timer = setInterval(() => {
        if (window.google && google.accounts && google.accounts.oauth2) {
          setupAuth();
          clearInterval(timer);
        }
      }, 300);

      const btnLogin = document.getElementById('btn-login');
      if (btnLogin) btnLogin.onclick = handleLoginClick;
    });
  </script>
</body>
</html>
